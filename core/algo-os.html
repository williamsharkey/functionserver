<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Function Server</title>
<link rel="stylesheet" href="algo-os.css">
</head>
<body>

<!-- Login Overlay -->
<div id="login-overlay" style="display:none;">
  <div class="login-dialog">
    <h2>üñ•Ô∏è Function Server</h2>
    <div class="tabs">
      <div class="tab active" data-tab="login" onclick="showLoginTab('login')">Login</div>
      <div class="tab" data-tab="register" onclick="showLoginTab('register')">Register</div>
    </div>
    <div id="login-form">
      <label>Username:</label>
      <input type="text" id="login-username" autocomplete="username">
      <label>Password:</label>
      <input type="password" id="login-password" autocomplete="current-password">
      <div style="margin:8px 0;display:flex;align-items:center;gap:6px;">
        <input type="checkbox" id="login-system-user" style="width:auto;margin:0;">
        <label for="login-system-user" style="font-size:12px;color:#888;cursor:pointer;margin:0;">System User (Linux admin login)</label>
      </div>
      <div class="buttons">
        <button onclick="doLogin()">Login</button>
      </div>
    </div>
    <div id="register-form" style="display:none;">
      <label>Username:</label>
      <input type="text" id="reg-username" autocomplete="username">
      <label>Password:</label>
      <input type="password" id="reg-password" autocomplete="new-password">
      <label>Confirm:</label>
      <input type="password" id="reg-confirm" autocomplete="new-password">
      <div class="buttons">
        <button onclick="doRegister()">Create Account</button>
      </div>
    </div>
    <div id="login-error" class="error"></div>
  </div>
</div>

<div id="user-indicator"></div>
<div id="desktop"></div>
<div id="toast-container"></div>

<div id="taskbar">
  <div id="start-btn" onclick="toggleStartMenu()">
    <span style="font-size:14px;">üñ•Ô∏è</span> Start
  </div>
  <div id="taskbar-windows"></div>
  <div id="clock"></div>
</div>

<div id="start-menu">
  <div class="start-sidebar">FunctionServer</div>
  <div class="start-items">
    <div class="start-item has-sub" onclick="toggleSubmenu(event, this)" onmouseenter="openSubmenu(this)" onmouseleave="closeSubmenuDelay(this)">
      <span>üìÅ</span> Programs
      <div class="start-submenu" id="programs-menu">
        <div class="start-item" onclick="openNotepad()"><span>üìù</span> Notepad</div>
        <div class="start-item" onclick="openJSIDE()"><span>üíª</span> javascript.ide</div>
        <div class="start-item" onclick="openBrowser()"><span>üåê</span> Web Browser</div>
        <div class="start-separator"></div>
        <div id="installed-programs-menu"></div>
      </div>
    </div>
    <div class="start-item" onclick="openDocumentation()"><span style="color:#8B0000;">üìï</span> Documentation</div>
    <div class="start-item" onclick="openHelp()"><span style="color:#8B0000;">üìô</span> Help</div>
    <div class="start-separator"></div>
    <div class="start-item" onclick="showAbout()"><span>‚ÑπÔ∏è</span> About</div>
    <div class="start-item" onclick="openSettings()"><span>‚öôÔ∏è</span> Settings</div>
    <div class="start-separator"></div>
    <div class="start-item" id="start-menu-auth" onclick="logout()"><span>üö™</span> Log Out</div>
  </div>
</div>

<div id="context-menu"></div>

<script>
// ==================== CONFIG ====================
const API_BASE = '/api';
let currentUser = null;
let sessionToken = null;

// ==================== STATE ====================
let windows = [];
let winId = 0;
let activeWin = null;
let savedFiles = [];
let installedPrograms = [];
let systemApps = [];
let uninstalledSystemApps = [];
let windowStates = {};
let apiKeys = {};
let dragWin = null;
let dragOffset = { x: 0, y: 0 };
let contextTarget = null;
let submenuCloseTimeout = null;

// File type registry
let fileTypeRegistry = {
  'txt': { icon: 'üìÑ', app: 'Notepad' },
  'js': { icon: 'üíª', app: 'javascript.ide' },
  'html': { icon: 'üåê', app: 'Browser' },
  'json': { icon: 'üìã', app: 'Notepad' },
  'md': { icon: 'üìù', app: 'Notepad' },
  'png': { icon: 'üñºÔ∏è', app: 'Image Viewer' },
  'jpg': { icon: 'üñºÔ∏è', app: 'Image Viewer' },
  'gif': { icon: 'üñºÔ∏è', app: 'Image Viewer' }
};

// ==================== PUBSUB ====================
// Inter-app communication system
const ALGO = window.ALGO || {};
ALGO.pubsub = {
  subscribers: {},      // topic -> [callback, ...]
  queues: {},          // topic -> [messages waiting for subscriber]
  appRegistry: {},     // appName -> { autoOpen: bool, openFn: fn }

  // Register an app with the pubsub system
  register: function(appName, options = {}) {
    this.appRegistry[appName] = {
      autoOpen: options.autoOpen || false,
      openFn: options.openFn || null,
      running: true
    };
    // Deliver any queued messages
    if (this.queues[appName] && this.queues[appName].length > 0) {
      const queue = this.queues[appName];
      this.queues[appName] = [];
      queue.forEach(item => this.publish(appName, item.msg, item.options, item.from));
    }
  },

  // Unregister when app closes
  unregister: function(appName) {
    if (this.appRegistry[appName]) {
      this.appRegistry[appName].running = false;
    }
  },

  // Subscribe to messages for a topic
  subscribe: function(topic, callback) {
    if (!this.subscribers[topic]) {
      this.subscribers[topic] = [];
    }
    this.subscribers[topic].push(callback);
    return () => {
      this.subscribers[topic] = this.subscribers[topic].filter(cb => cb !== callback);
    };
  },

  // Publish a message to a topic
  publish: function(topic, msg, options = {}, from = null) {
    const { autoOpen = false, queue = true, timeout = 5000 } = options;

    const callbacks = this.subscribers[topic] || [];
    const app = this.appRegistry[topic];

    // If no subscribers and app not running
    if (callbacks.length === 0 && (!app || !app.running)) {
      // Try to auto-open the app
      if (autoOpen && app && app.openFn) {
        app.openFn();
        // Queue message to be delivered after app opens
        if (!this.queues[topic]) this.queues[topic] = [];
        this.queues[topic].push({ msg, options, from, timestamp: Date.now() });
        return { status: 'queued', reason: 'app opening' };
      }
      // Queue for later if requested
      if (queue) {
        if (!this.queues[topic]) this.queues[topic] = [];
        this.queues[topic].push({ msg, options, from, timestamp: Date.now() });
        // Clean old messages after timeout
        setTimeout(() => {
          if (this.queues[topic]) {
            this.queues[topic] = this.queues[topic].filter(m => Date.now() - m.timestamp < timeout);
          }
        }, timeout);
        return { status: 'queued', reason: 'no subscribers' };
      }
      return { status: 'dropped', reason: 'no subscribers' };
    }

    // Deliver to all subscribers
    callbacks.forEach(cb => {
      try {
        cb(msg, from);
      } catch (e) {
        console.error('Pubsub callback error:', e);
      }
    });

    return { status: 'delivered', count: callbacks.length };
  },

  // Request-response pattern
  request: function(topic, msg, options = {}) {
    return new Promise((resolve, reject) => {
      const timeout = options.timeout || 5000;
      const requestId = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      const responseTopic = '_response_' + requestId;

      const timer = setTimeout(() => {
        unsubscribe();
        reject(new Error('Request timeout'));
      }, timeout);

      const unsubscribe = this.subscribe(responseTopic, (response) => {
        clearTimeout(timer);
        unsubscribe();
        resolve(response);
      });

      this.publish(topic, { ...msg, _requestId: requestId, _responseTopic: responseTopic }, options);
    });
  },

  // Respond to a request
  respond: function(originalMsg, response) {
    if (originalMsg._responseTopic) {
      this.publish(originalMsg._responseTopic, response);
    }
  }
};

// ==================== BRIDGE ====================
// Direct JS VM access for terminal-based agents (Claude Code)
ALGO.bridge = {
  // Execute JavaScript code and return result
  eval: function(code) {
    try {
      const result = eval(code);
      // Handle non-serializable results
      if (result === undefined) {
        return { success: true, result: null, type: 'undefined' };
      }
      if (typeof result === 'function') {
        return { success: true, result: result.toString(), type: 'function' };
      }
      if (result instanceof Element) {
        return { success: true, result: result.outerHTML.substring(0, 1000), type: 'element' };
      }
      if (result instanceof NodeList || result instanceof HTMLCollection) {
        return { success: true, result: Array.from(result).map(e => e.outerHTML?.substring(0, 200) || String(e)), type: 'nodelist' };
      }
      return { success: true, result: result, type: typeof result };
    } catch(e) {
      return { success: false, error: e.message, stack: e.stack };
    }
  },

  // Query the DOM
  query: function(selector) {
    try {
      const el = document.querySelector(selector);
      if (!el) return { success: true, result: null };
      return {
        success: true,
        result: {
          tag: el.tagName,
          id: el.id,
          className: el.className,
          text: el.textContent?.substring(0, 500),
          html: el.outerHTML?.substring(0, 1000),
          rect: el.getBoundingClientRect()
        }
      };
    } catch(e) {
      return { success: false, error: e.message };
    }
  },

  // Query multiple elements
  queryAll: function(selector) {
    try {
      const els = document.querySelectorAll(selector);
      return {
        success: true,
        count: els.length,
        result: Array.from(els).slice(0, 50).map(el => ({
          tag: el.tagName,
          id: el.id,
          className: el.className,
          text: el.textContent?.substring(0, 100)
        }))
      };
    } catch(e) {
      return { success: false, error: e.message };
    }
  },

  // Get current state of the OS
  getState: function() {
    return {
      success: true,
      result: {
        user: currentUser,
        windows: windows.map(w => ({ id: w.id, title: w.title, minimized: w.minimized })),
        activeWindow: activeWin,
        systemApps: systemApps.map(a => ({ id: a.id, name: a.name, icon: a.icon })),
        pubsubApps: Object.keys(ALGO.pubsub.appRegistry).filter(k => ALGO.pubsub.appRegistry[k].running)
      }
    };
  },

  // Click an element
  click: function(selector) {
    try {
      const el = document.querySelector(selector);
      if (!el) return { success: false, error: 'Element not found: ' + selector };
      el.click();
      return { success: true, clicked: selector };
    } catch(e) {
      return { success: false, error: e.message };
    }
  },

  // Set value of an input
  setValue: function(selector, value) {
    try {
      const el = document.querySelector(selector);
      if (!el) return { success: false, error: 'Element not found: ' + selector };
      el.value = value;
      el.dispatchEvent(new Event('input', { bubbles: true }));
      el.dispatchEvent(new Event('change', { bubbles: true }));
      return { success: true, selector, value };
    } catch(e) {
      return { success: false, error: e.message };
    }
  },

  // Open an app by ID
  openApp: function(appId) {
    try {
      const app = systemApps.find(a => a.id === appId);
      if (app) {
        runSystemApp(appId);
        return { success: true, opened: appId };
      }
      return { success: false, error: 'App not found: ' + appId };
    } catch(e) {
      return { success: false, error: e.message };
    }
  },

  // Focus a window by ID
  focusWindow: function(winId) {
    try {
      focusWindow(winId);
      return { success: true, focused: winId };
    } catch(e) {
      return { success: false, error: e.message };
    }
  },

  // Close a window by ID
  closeWindow: function(winId) {
    try {
      closeWindow(winId);
      return { success: true, closed: winId };
    } catch(e) {
      return { success: false, error: e.message };
    }
  }
};
window.ALGO = ALGO;

// ==================== AUTH ====================
function checkSession() {
  const saved = localStorage.getItem('algo-session');
  if (saved) {
    try {
      const s = JSON.parse(saved);
      if (s.token && s.username) {
        fetch(API_BASE + '/auth/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: s.token, username: s.username })
        }).then(r => r.json())
        .then(data => {
          if (data.valid) {
            loginSuccess(s.username, s.token, s.isSystemUser);
          } else {
            guestLogin();
          }
        }).catch(() => guestLogin());
        return;
      }
    } catch (e) {}
  }
  guestLogin();
}

function guestLogin() {
  currentUser = 'guest';
  sessionToken = null;
  hideLogin();
  document.getElementById('user-indicator').textContent = 'üë§ Guest';
  document.getElementById('start-menu-auth').innerHTML = '<span>üîë</span> Login / Register';
  document.getElementById('start-menu-auth').onclick = showLogin;
  loadState();
  loadSystemApps();
  init();
}

function showLogin() {
  document.getElementById('login-overlay').style.display = 'flex';
}

function hideLogin() {
  document.getElementById('login-overlay').style.display = 'none';
}

function showLoginTab(tab) {
  document.querySelectorAll('.login-dialog .tab').forEach(t => t.classList.remove('active'));
  document.querySelector('.login-dialog .tab[data-tab="' + tab + '"]').classList.add('active');
  document.getElementById('login-form').style.display = tab === 'login' ? 'block' : 'none';
  document.getElementById('register-form').style.display = tab === 'register' ? 'block' : 'none';
  document.getElementById('login-error').textContent = '';
}

let isSystemUser = false;

function loginSuccess(username, token, systemUser) {
  currentUser = username;
  sessionToken = token;
  isSystemUser = systemUser || false;
  localStorage.setItem('algo-session', JSON.stringify({ username, token, isSystemUser }));
  hideLogin();
  const indicator = isSystemUser ? 'üîë ' + username + ' (system)' : 'üë§ ' + username;
  document.getElementById('user-indicator').textContent = indicator;
  document.getElementById('start-menu-auth').innerHTML = '<span>üö™</span> Log Out (' + username + ')';
  loadState();
  loadSystemApps();
  init();
}

function doLogin() {
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  const isSystemUser = document.getElementById('login-system-user').checked;
  const error = document.getElementById('login-error');

  if (!username || !password) {
    error.textContent = 'Please enter username and password';
    return;
  }

  const endpoint = isSystemUser ? '/auth/system-login' : '/auth/login';

  fetch(API_BASE + endpoint, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, password })
  })
  .then(r => r.json())
  .then(data => {
    if (data.token) {
      loginSuccess(username, data.token, data.isSystemUser);
    } else {
      error.textContent = data.error || 'Login failed';
    }
  })
  .catch(e => {
    error.textContent = 'Connection error';
  });
}

function doRegister() {
  const username = document.getElementById('reg-username').value.trim();
  const password = document.getElementById('reg-password').value;
  const confirm = document.getElementById('reg-confirm').value;
  const error = document.getElementById('login-error');

  if (!username || !password) {
    error.textContent = 'Please fill all fields';
    return;
  }
  if (password !== confirm) {
    error.textContent = 'Passwords do not match';
    return;
  }

  fetch(API_BASE + '/register', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, password })
  })
  .then(r => r.json())
  .then(data => {
    if (data.token) {
      loginSuccess(username, data.token);
    } else {
      error.textContent = data.error || 'Registration failed';
    }
  })
  .catch(e => {
    error.textContent = 'Connection error';
  });
}

function logout() {
  hideStartMenu();
  localStorage.removeItem('algo-session');
  currentUser = null;
  sessionToken = null;
  location.reload();
}

// ==================== INIT ====================
function init() {
  createDesktopIcons();
  updateTaskbar();
  updateClock();
  setInterval(updateClock, 1000);

  // Global event listeners
  document.addEventListener('click', globalClick);
  document.addEventListener('mousemove', onDrag);
  document.addEventListener('mouseup', endDrag);
  document.addEventListener('contextmenu', handleContextMenu);
  document.addEventListener('keydown', handleKeyDown);

  setTimeout(() => algoSpeak("Welcome to Function Server!"), 1500);
}

function handleKeyDown(e) {
  if (e.key === 'Escape') {
    hideStartMenu();
    hideContextMenu();
  }
}

function handleContextMenu(e) {
  const desktop = document.getElementById('desktop');
  if (e.target === desktop || desktop.contains(e.target)) {
    e.preventDefault();
    showDesktopContextMenu(e);
  }
}

// ==================== DESKTOP ICONS ====================
function createDesktopIcons() {
  const desktop = document.getElementById('desktop');
  desktop.innerHTML = '';

  // Default icons
  const defaultIcons = [
    { id: 'notepad', name: 'Notepad', icon: 'üìù', x: 20, y: 20, action: 'openNotepad' },
    { id: 'jside', name: 'javascript.ide', icon: 'üíª', x: 20, y: 100, action: 'openJSIDE' },
    { id: 'browser', name: 'Web Browser', icon: 'üåê', x: 20, y: 180, action: 'openBrowser' },
    { id: 'docs', name: 'Documentation', icon: 'üìï', x: 20, y: 260, action: 'openDocumentation' },
  ];

  defaultIcons.forEach(ic => createDesktopIcon(ic));

  // User saved files
  savedFiles.forEach((file, idx) => {
    createDesktopIcon({
      id: 'file-' + idx,
      name: file.name,
      icon: getFileIcon(file.name),
      x: 120 + (idx % 5) * 80,
      y: 20 + Math.floor(idx / 5) * 80,
      action: 'openFile',
      fileIdx: idx
    });
  });
}

function createDesktopIcon(ic) {
  const desktop = document.getElementById('desktop');
  const icon = document.createElement('div');
  icon.className = 'desktop-icon';
  icon.id = 'icon-' + ic.id;
  icon.dataset.id = ic.id;
  icon.style.left = ic.x + 'px';
  icon.style.top = ic.y + 'px';
  icon.innerHTML = '<div class="icon-img">' + ic.icon + '</div><div class="icon-label">' + escapeHtml(ic.name) + '</div>';

  icon.ondblclick = () => {
    if (ic.action === 'openFile') {
      openSavedFile(savedFiles[ic.fileIdx]);
    } else if (typeof window[ic.action] === 'function') {
      window[ic.action]();
    }
  };

  // Right-click context menu for files
  if (ic.action === 'openFile') {
    icon.oncontextmenu = (e) => {
      e.preventDefault();
      e.stopPropagation();
      const file = savedFiles[ic.fileIdx];
      if (!file) return;
      showFileContextMenu(e, file, ic.fileIdx);
    };
  }

  desktop.appendChild(icon);
}

function getFileIcon(filename) {
  const ext = filename.split('.').pop().toLowerCase();
  return fileTypeRegistry[ext]?.icon || 'üìÑ';
}

// ==================== WINDOWS ====================
function createWindow(opts) {
  const id = winId++;
  const win = {
    id,
    title: opts.title || 'Window',
    icon: opts.icon || 'üìÑ',
    width: opts.width || 400,
    height: opts.height || 300,
    x: opts.x || 100 + (id % 5) * 30,
    y: opts.y || 50 + (id % 5) * 30,
    minimized: false,
    maximized: false,
    content: opts.content || '',
    onClose: opts.onClose
  };
  windows.push(win);
  renderWindow(win);
  focusWindow(id);
  updateTaskbar();
  return id;
}

function renderWindow(win) {
  const desktop = document.getElementById('desktop');
  const el = document.createElement('div');
  el.className = 'window';
  el.id = 'win-' + win.id;
  el.style.cssText = 'left:' + win.x + 'px;top:' + win.y + 'px;width:' + win.width + 'px;height:' + win.height + 'px;';

  el.innerHTML =
    '<div class="window-titlebar" onmousedown="startDrag(event,' + win.id + ')">' +
      '<span class="window-icon">' + win.icon + '</span>' +
      '<span class="window-title">' + escapeHtml(win.title) + '</span>' +
      '<div class="window-controls">' +
        '<button class="win-btn minimize" onclick="minimizeWindow(' + win.id + ')">_</button>' +
        '<button class="win-btn maximize" onclick="maximizeWindow(' + win.id + ')">‚ñ°</button>' +
        '<button class="win-btn close" onclick="closeWindow(' + win.id + ')">√ó</button>' +
      '</div>' +
    '</div>' +
    '<div class="window-content">' + win.content + '</div>';

  el.onmousedown = () => focusWindow(win.id);
  desktop.appendChild(el);
}

function focusWindow(id) {
  windows.forEach(w => {
    const el = document.getElementById('win-' + w.id);
    if (el) el.classList.remove('active');
  });
  const el = document.getElementById('win-' + id);
  if (el) {
    el.classList.add('active');
    el.style.zIndex = winId + 100;
  }
  activeWin = id;
}

function minimizeWindow(id) {
  const el = document.getElementById('win-' + id);
  if (el) el.classList.add('minimized');
  const win = windows.find(w => w.id === id);
  if (win) win.minimized = true;
  updateTaskbar();
}

function restoreWindow(id) {
  const el = document.getElementById('win-' + id);
  if (el) el.classList.remove('minimized');
  const win = windows.find(w => w.id === id);
  if (win) win.minimized = false;
  focusWindow(id);
  updateTaskbar();
}

function maximizeWindow(id) {
  const el = document.getElementById('win-' + id);
  const win = windows.find(w => w.id === id);
  if (!el || !win) return;

  if (win.maximized) {
    el.style.left = win.restoreX + 'px';
    el.style.top = win.restoreY + 'px';
    el.style.width = win.restoreW + 'px';
    el.style.height = win.restoreH + 'px';
    win.maximized = false;
  } else {
    win.restoreX = el.offsetLeft;
    win.restoreY = el.offsetTop;
    win.restoreW = el.offsetWidth;
    win.restoreH = el.offsetHeight;
    el.style.left = '0';
    el.style.top = '0';
    el.style.width = '100%';
    el.style.height = 'calc(100% - 28px)';
    win.maximized = true;
  }
}

function closeWindow(id) {
  const win = windows.find(w => w.id === id);
  if (win && win.onClose) win.onClose();
  const el = document.getElementById('win-' + id);
  if (el) el.remove();
  windows = windows.filter(w => w.id !== id);
  updateTaskbar();
}

function updateTaskbar() {
  const tb = document.getElementById('taskbar-windows');
  tb.innerHTML = windows.map(w =>
    '<div class="taskbar-item' + (w.id === activeWin ? ' active' : '') + (w.minimized ? ' minimized' : '') +
    '" onclick="' + (w.minimized ? 'restoreWindow(' + w.id + ')' : 'focusWindow(' + w.id + ')') + '">' +
    w.icon + ' ' + escapeHtml(w.title.substring(0, 20)) + '</div>'
  ).join('');
}

// ==================== DRAG ====================
function startDrag(e, id) {
  if (e.target.classList.contains('win-btn')) return;
  const el = document.getElementById('win-' + id);
  if (!el) return;
  dragWin = { id, el };
  dragOffset = { x: e.clientX - el.offsetLeft, y: e.clientY - el.offsetTop };
  focusWindow(id);
}

function onDrag(e) {
  if (!dragWin) return;
  dragWin.el.style.left = (e.clientX - dragOffset.x) + 'px';
  dragWin.el.style.top = (e.clientY - dragOffset.y) + 'px';
}

function endDrag() {
  dragWin = null;
}

// ==================== NOTEPAD ====================
function openNotepad(content, filename) {
  hideStartMenu();
  const id = winId;
  const text = content || '';
  const name = filename || 'Untitled.txt';

  createWindow({
    title: name,
    icon: 'üìù',
    width: 500,
    height: 400,
    content:
      '<div class="notepad-container">' +
        '<div class="notepad-toolbar">' +
          '<button onclick="notepadNew(' + id + ')">New</button>' +
          '<button onclick="notepadSave(' + id + ')">Save</button>' +
        '</div>' +
        '<textarea id="notepad-text-' + id + '" class="notepad-textarea">' + escapeHtml(text) + '</textarea>' +
      '</div>'
  });
}

function notepadNew(id) {
  const textarea = document.getElementById('notepad-text-' + id);
  if (textarea) textarea.value = '';
}

function notepadSave(id) {
  const textarea = document.getElementById('notepad-text-' + id);
  if (!textarea) return;
  const name = prompt('Filename:', 'document.txt');
  if (!name) return;
  savedFiles.push({ name, type: 'text', content: textarea.value });
  saveState();
  createDesktopIcons();
  algoSpeak('Saved ' + name);
}

// ==================== JAVASCRIPT IDE ====================
const ALGO_API_CODE = `
// Extend global ALGO (don't shadow it - we need pubsub and bridge!)
ALGO.app = { name: 'App', icon: 'üì±' };
ALGO.title = (t) => { document.title = t; };
ALGO.html = (h) => { document.body.innerHTML = h; };
ALGO.createWindow = (opts) => createWindow(opts);
ALGO.notify = (msg) => algoSpeak(msg);
ALGO.state = ALGO.state || {};
ALGO.ui = ALGO.ui || {
  button: (text, onclick) => '<button onclick="(' + onclick + ')()">' + text + '</button>'
};
`;

const IDE_EXAMPLES = {
  'hello': {
    name: 'Hello World',
    code: '// Hello World\\nALGO.app.name = "Hello";\\nALGO.app.icon = "üëã";\\n\\nALGO.html("<h1>Hello, World!</h1>");'
  },
  'counter': {
    name: 'Counter',
    code: '// Counter App\\nALGO.app.name = "Counter";\\nALGO.app.icon = "üî¢";\\n\\nlet count = 0;\\n\\nfunction render() {\\n  ALGO.html(`\\n    <div style="text-align:center;padding:20px;">\\n      <h1>${count}</h1>\\n      <button onclick="count--;render()">-</button>\\n      <button onclick="count++;render()">+</button>\\n    </div>\\n  `);\\n}\\n\\nrender();'
  }
};

function openJSIDE(content, filename) {
  hideStartMenu();
  const id = winId;
  const code = content || '// Function Server App\\nALGO.app.name = "My App";\\nALGO.app.icon = "üì±";\\n\\nALGO.html("<h1>Hello!</h1>");';

  createWindow({
    title: filename || 'javascript.ide',
    icon: 'üíª',
    width: 700,
    height: 500,
    content:
      '<div class="ide-container">' +
        '<div class="ide-toolbar">' +
          '<button onclick="ideRun(' + id + ')">‚ñ∂ Run</button>' +
          '<button onclick="ideSave(' + id + ')">üíæ Save</button>' +
          '<select onchange="ideLoadExample(' + id + ',this.value)">' +
            '<option value="">Examples...</option>' +
            '<option value="hello">Hello World</option>' +
            '<option value="counter">Counter</option>' +
          '</select>' +
        '</div>' +
        '<div class="ide-main">' +
          '<textarea id="ide-code-' + id + '" class="ide-editor">' + escapeHtml(code) + '</textarea>' +
          '<div class="ide-preview" id="ide-preview-' + id + '"></div>' +
        '</div>' +
      '</div>'
  });
}

function ideRun(id) {
  const code = document.getElementById('ide-code-' + id).value;
  const preview = document.getElementById('ide-preview-' + id);

  try {
    preview.innerHTML = '<div id="app-root"></div>';
    const fullCode = ALGO_API_CODE + '\n' +
      'const ALGO_ROOT = document.getElementById("ide-preview-' + id + '").querySelector("#app-root");\n' +
      'ALGO.html = (h) => { ALGO_ROOT.innerHTML = h; };\n' +
      code;
    eval(fullCode);
  } catch (e) {
    preview.innerHTML = '<div style="color:red;padding:10px;">Error: ' + escapeHtml(e.message) + '</div>';
  }
}

function ideSave(id) {
  const code = document.getElementById('ide-code-' + id).value;
  const name = prompt('Filename:', 'app.js');
  if (!name) return;
  savedFiles.push({ name, type: 'text', content: code });
  saveState();
  createDesktopIcons();
  algoSpeak('Saved ' + name);
}

function ideLoadExample(id, key) {
  if (!key || !IDE_EXAMPLES[key]) return;
  document.getElementById('ide-code-' + id).value = IDE_EXAMPLES[key].code.replace(/\\\\n/g, '\\n');
}

// ==================== WEB BROWSER ====================
function openBrowser(url) {
  hideStartMenu();
  const id = winId;
  const startUrl = url || 'https://example.com';

  createWindow({
    title: 'Web Browser',
    icon: 'üåê',
    width: 800,
    height: 600,
    content:
      '<div class="browser-container">' +
        '<div class="browser-toolbar">' +
          '<button onclick="browserBack(' + id + ')">‚óÄ</button>' +
          '<button onclick="browserFwd(' + id + ')">‚ñ∂</button>' +
          '<input type="text" id="browser-url-' + id + '" value="' + escapeHtml(startUrl) + '" onkeypress="if(event.key===\'Enter\')browserGo(' + id + ')">' +
          '<button onclick="browserGo(' + id + ')">Go</button>' +
        '</div>' +
        '<iframe id="browser-frame-' + id + '" src="' + escapeHtml(startUrl) + '" class="browser-frame"></iframe>' +
      '</div>'
  });
}

function browserGo(id) {
  let url = document.getElementById('browser-url-' + id).value;
  if (!url.startsWith('http')) url = 'https://' + url;
  document.getElementById('browser-frame-' + id).src = url;
}

function browserBack(id) {
  try { document.getElementById('browser-frame-' + id).contentWindow.history.back(); } catch(e) {}
}

function browserFwd(id) {
  try { document.getElementById('browser-frame-' + id).contentWindow.history.forward(); } catch(e) {}
}

// ==================== DOCUMENTATION ====================
const DOCS = {
  'getting-started': {
    title: 'Getting Started',
    content: '<h2>Welcome to Function Server</h2><p>A cloud operating system in your browser.</p><h3>Quick Start</h3><ul><li>Double-click icons to open programs</li><li>Right-click for context menus</li><li>Use Start menu for all programs</li></ul>'
  },
  'apps': {
    title: 'Building Apps',
    content: '<h2>Building Apps</h2><p>Use JavaScript.IDE to create apps.</p><pre style="background:#e8e0f0;color:#222;padding:12px;border-radius:6px;">ALGO.app.name = "My App";\\nALGO.html("<h1>Hello!</h1>");</pre>'
  }
};

function openDocumentation() {
  hideStartMenu();
  createWindow({
    title: 'Documentation',
    icon: 'üìï',
    width: 500,
    height: 400,
    content:
      '<div class="docs-container">' +
        '<div class="docs-sidebar">' +
          Object.keys(DOCS).map(k => '<div class="docs-item" onclick="showDoc(\'' + k + '\')">' + DOCS[k].title + '</div>').join('') +
        '</div>' +
        '<div class="docs-content" id="docs-content">' +
          '<p>Select a topic from the sidebar.</p>' +
        '</div>' +
      '</div>'
  });
}

function showDoc(key) {
  const doc = DOCS[key];
  if (doc) {
    document.getElementById('docs-content').innerHTML = doc.content;
  }
}

function openHelp() {
  hideStartMenu();
  createWindow({
    title: 'Help',
    icon: 'üìô',
    width: 400,
    height: 300,
    content: '<div style="padding:20px;"><h2>Help</h2><p>Function Server is a cloud OS.</p><ul><li>Use Start menu for programs</li><li>System Apps load from /core/apps/</li><li>Create apps with JavaScript.IDE</li></ul></div>'
  });
}

// ==================== FILE HANDLING ====================
function openSavedFile(file) {
  if (file.name.endsWith('.js')) {
    openJSIDE(file.content, file.name);
  } else if (file.type === 'image') {
    viewImage(file);
  } else {
    openNotepad(file.content, file.name);
  }
}

function viewImage(file) {
  createWindow({
    title: file.name,
    icon: 'üñºÔ∏è',
    width: 500,
    height: 400,
    content: '<div style="display:flex;align-items:center;justify-content:center;height:100%;background:#222;"><img src="' + file.data + '" style="max-width:100%;max-height:100%;"></div>'
  });
}

// ==================== CONTEXT MENU ====================
function showDesktopContextMenu(e) {
  const menu = document.getElementById('context-menu');
  menu.innerHTML =
    '<div class="ctx-item" onclick="openNotepad()">üìù New Text File</div>' +
    '<div class="ctx-item" onclick="openJSIDE()">üìú New App</div>' +
    '<div class="ctx-separator"></div>' +
    '<div class="ctx-item" onclick="createDesktopIcons()">üîÑ Refresh</div>';
  menu.style.left = e.clientX + 'px';
  menu.style.top = e.clientY + 'px';
  menu.classList.add('visible');
}

function hideContextMenu() {
  document.getElementById('context-menu').classList.remove('visible');
}

// ==================== START MENU ====================
function toggleStartMenu() {
  document.getElementById('start-menu').classList.toggle('visible');
}

function hideStartMenu() {
  document.getElementById('start-menu').classList.remove('visible');
}

function openSubmenu(el) {
  if (submenuCloseTimeout) {
    clearTimeout(submenuCloseTimeout);
    submenuCloseTimeout = null;
  }
  document.querySelectorAll('.start-item.has-sub').forEach(item => {
    if (item !== el) item.classList.remove('submenu-open');
  });
  el.classList.add('submenu-open');

  // Fix submenu position to align with start menu bottom
  const submenu = el.querySelector('.start-submenu');
  if (submenu) {
    const startMenu = document.getElementById('start-menu');
    const startRect = startMenu.getBoundingClientRect();
    const taskbarHeight = window.innerHeight - document.getElementById('taskbar').getBoundingClientRect().top;

    // Use setProperty with !important to override CSS
    submenu.style.setProperty('position', 'fixed', 'important');
    submenu.style.setProperty('left', (startRect.right - 2) + 'px', 'important');
    submenu.style.setProperty('bottom', taskbarHeight + 'px', 'important');
    submenu.style.setProperty('top', 'auto', 'important');
    submenu.style.setProperty('max-height', (window.innerHeight - taskbarHeight - 20) + 'px', 'important');
  }
}

function closeSubmenuDelay(el) {
  submenuCloseTimeout = setTimeout(() => {
    el.classList.remove('submenu-open');
  }, 300);
}

function toggleSubmenu(e, el) {
  if (window.innerWidth <= 768) {
    e.stopPropagation();
    el.classList.toggle('submenu-open');
  }
}

// ==================== PROGRAMS MENU ====================
function updateProgramsMenu() {
  const el = document.getElementById('installed-programs-menu');
  if (!el) return;

  let html = '';

  // System apps
  const visibleSystemApps = systemApps.filter(a => !uninstalledSystemApps.includes(a.id));
  if (visibleSystemApps.length > 0) {
    html += '<div class="start-separator-label">System Apps</div>';
    html += visibleSystemApps.map(a =>
      '<div class="start-item" onclick="runSystemApp(\'' + a.id + '\')">' +
      '<span>' + (a.icon || 'üì±') + '</span> ' + escapeHtml(a.name) + '</div>'
    ).join('');
  }

  // User apps
  if (installedPrograms.length > 0) {
    if (visibleSystemApps.length > 0) html += '<div class="start-separator"></div>';
    html += '<div class="start-separator-label">My Apps</div>';
    html += installedPrograms.map(p =>
      '<div class="start-item" onclick="runUserApp(\'' + p.id + '\')">' +
      '<span>' + (p.icon || 'üéÆ') + '</span> ' + escapeHtml(p.name) + '</div>'
    ).join('');
  }

  el.innerHTML = html;
}

// ==================== APP RUNNING ====================
function loadSystemApps() {
  fetch(API_BASE + '/system-apps')
    .then(r => r.json())
    .then(data => {
      systemApps = data.apps || [];
      updateProgramsMenu();
    })
    .catch(() => {});
}

function runSystemApp(appId) {
  hideStartMenu();
  const app = systemApps.find(a => a.id === appId);
  if (app) runApp(app);
}

function runUserApp(appId) {
  hideStartMenu();
  const app = installedPrograms.find(a => a.id === appId);
  if (app) runApp(app);
}

function runApp(app) {
  if (app.code) {
    try {
      const fullCode = ALGO_API_CODE + '\n' + app.code;
      eval(fullCode);
    } catch (e) {
      algoSpeak('Error: ' + e.message);
    }
  }
}

// ==================== UTILITIES ====================
function globalClick(e) {
  if (!e.target.closest('#start-menu') && !e.target.closest('#start-btn')) {
    hideStartMenu();
  }
  if (!e.target.closest('#context-menu')) {
    hideContextMenu();
  }
}

function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent =
    now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
}

function algoSpeak(text) {
  const container = document.getElementById('toast-container');
  if (!container) return;
  const toast = document.createElement('div');
  toast.className = 'algo-toast';
  toast.innerHTML = '<span class="toast-icon">üñ•Ô∏è</span><span class="toast-text">' + escapeHtml(text) + '</span>';
  container.appendChild(toast);
  requestAnimationFrame(() => toast.classList.add('show'));
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, 3500);
}

function showAbout() {
  hideStartMenu();
  createWindow({
    title: 'About',
    icon: 'üñ•Ô∏è',
    width: 320,
    height: 220,
    content: '<div style="padding:20px;text-align:center;"><div style="font-size:48px;">üñ•Ô∏è</div><h2>Function Server</h2><p style="color:#666;">A Cloud Operating System</p><p style="font-size:11px;margin-top:15px;">MIT License ‚Ä¢ Open Source</p></div>'
  });
}

function openSettings() {
  hideStartMenu();
  const currentBg = localStorage.getItem('algo-bg-color') || '#008080';
  createWindow({
    title: 'Settings',
    icon: '‚öôÔ∏è',
    width: 350,
    height: 250,
    content:
      '<div style="padding:20px;">' +
        '<h3>Settings</h3>' +
        '<label>Background Color:</label><br>' +
        '<input type="color" id="settings-bg" value="' + currentBg + '">' +
        '<button onclick="applySettings()" style="margin-left:10px;">Apply</button>' +
      '</div>'
  });
}

function applySettings() {
  const bg = document.getElementById('settings-bg').value;
  localStorage.setItem('algo-bg-color', bg);
  document.getElementById('desktop').style.background = bg;
  algoSpeak('Settings applied');
}

// ==================== PERSISTENCE ====================
function saveState() {
  const state = {
    savedFiles,
    installedPrograms,
    uninstalledSystemApps,
    apiKeys,
    windowStates
  };
  localStorage.setItem('algo-state-' + currentUser, JSON.stringify(state));
}

function loadState() {
  try {
    const saved = localStorage.getItem('algo-state-' + currentUser);
    if (saved) {
      const state = JSON.parse(saved);
      savedFiles = state.savedFiles || [];
      installedPrograms = state.installedPrograms || [];
      uninstalledSystemApps = state.uninstalledSystemApps || [];
      apiKeys = state.apiKeys || {};
      windowStates = state.windowStates || {};
    }
  } catch (e) {}

  // Apply saved background
  const bg = localStorage.getItem('algo-bg-color');
  if (bg) document.getElementById('desktop').style.background = bg;
}

// ==================== BOOT ====================
checkSession();
</script>
</body>
</html>
