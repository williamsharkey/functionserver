<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ALGO OS - Laserbarf Clubhouse</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  background: #008080;
  min-height: 100vh;
  font-family: 'MS Sans Serif', 'Segoe UI', Tahoma, sans-serif;
  overflow: hidden;
  user-select: none;
  font-size: 11px;
}

#desktop {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 28px;
  background: #008080;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  overflow: hidden;
}
#desktop.bg-tile { background-size: auto; background-repeat: repeat; }
#desktop.bg-stretch { background-size: 100% 100%; }
#desktop.bg-center { background-size: auto; background-repeat: no-repeat; background-position: center; }

.desktop-icon {
  position: absolute;
  width: 70px;
  text-align: center;
  cursor: pointer;
  padding: 4px;
}
.desktop-icon:hover { background: rgba(0,0,128,0.3); }
.desktop-icon.selected { background: #000080; }
.desktop-icon .icon-img {
  font-size: 32px;
  margin-bottom: 2px;
}
.desktop-icon .icon-thumbnail {
  width: 32px;
  height: 32px;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}
.desktop-icon .icon-thumbnail img {
  max-width: 32px;
  max-height: 32px;
  object-fit: contain;
  border: 1px solid #808080;
}
.desktop-icon span {
  display: block;
  font-size: 11px;
  color: white;
  text-shadow: 1px 1px #000;
  word-wrap: break-word;
}

.window {
  position: absolute;
  background: #c0c0c0;
  border: 2px outset #dfdfdf;
  box-shadow: 1px 1px 0 #000;
  display: flex;
  flex-direction: column;
}
.window.minimized { display: none; }
.window-titlebar {
  background: linear-gradient(90deg, #000080, #1084d0);
  color: white;
  padding: 2px 4px;
  display: flex;
  align-items: center;
  cursor: move;
  font-weight: bold;
  font-size: 11px;
}
.window.inactive .window-titlebar { background: linear-gradient(90deg, #808080, #a0a0a0); }
.window-titlebar .title { flex: 1; display: flex; align-items: center; gap: 4px; }
.window-btn {
  width: 16px; height: 14px;
  background: #c0c0c0;
  border: 2px outset #fff;
  font-size: 9px; font-weight: bold;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  margin-left: 2px;
}
.window-btn:active { border-style: inset; }
.window-content {
  flex: 1;
  overflow: auto;
  background: white;
  border: 2px inset #808080;
  margin: 2px;
}
.window-menubar {
  background: #c0c0c0;
  padding: 1px 2px;
  display: flex;
  gap: 2px;
  position: relative;
}
.window-menubar .menu-item {
  padding: 2px 8px;
  cursor: pointer;
  position: relative;
}
.window-menubar .menu-item:hover { background: #000080; color: white; }

/* Dropdown menu - fixed positioning */
.dropdown-menu {
  position: absolute;
  top: 100%;
  left: 0;
  background: #c0c0c0;
  border: 2px outset #fff;
  display: none;
  z-index: 1000;
  min-width: 140px;
}
.dropdown-menu.visible { display: block; }
.dropdown-item { padding: 4px 20px 4px 8px; cursor: pointer; white-space: nowrap; }
.dropdown-item:hover { background: #000080; color: white; }

/* CHM Help Viewer */
.chm-viewer { display: flex; height: 100%; }
.chm-sidebar {
  width: 180px;
  background: #f0f0f0;
  border-right: 1px solid #808080;
  overflow-y: auto;
  font-size: 11px;
}
.chm-tree-item {
  padding: 2px 4px 2px 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
}
.chm-tree-item:hover { background: #cce8ff; }
.chm-tree-item.active { background: #000080; color: white; }
.chm-content {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  font-size: 12px;
  line-height: 1.5;
}
.chm-content h1 { color: #000080; font-size: 18px; margin-bottom: 10px; }
.chm-content h2 { color: #000080; font-size: 14px; margin: 15px 0 8px; }
.chm-content a { color: #0000ff; }
.chm-content code { background: #f0f0f0; padding: 1px 4px; font-family: monospace; }

/* IDE */
.ide-container { display: flex; flex-direction: column; height: 100%; }
.ide-main { display: flex; flex: 1; min-height: 0; }
.ide-editor {
  flex: 1;
  display: flex;
  flex-direction: column;
  border-right: 2px solid #808080;
  min-width: 250px;
}
.ide-editor textarea {
  flex: 1;
  border: none;
  resize: none;
  font-family: 'Consolas', 'Courier New', monospace;
  font-size: 12px;
  padding: 8px;
  background: #1e1e1e;
  color: #d4d4d4;
  line-height: 1.4;
}
.ide-preview {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 200px;
  background: #f0f0f0;
}
.ide-preview-header {
  background: #c0c0c0;
  padding: 2px 8px;
  font-weight: bold;
  border-bottom: 1px solid #808080;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.ide-preview-content {
  flex: 1;
  overflow: auto;
  background: #fff;
  position: relative;
}
.ide-console {
  height: 100px;
  border-top: 2px solid #808080;
  display: flex;
  flex-direction: column;
  background: #1e1e1e;
}
.ide-console.collapsed { height: 22px; }
.ide-console-header {
  background: #2d2d2d;
  padding: 2px 8px;
  font-weight: bold;
  color: #d4d4d4;
  font-size: 10px;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
}
.ide-console-content {
  flex: 1;
  padding: 4px 8px;
  font-family: 'Consolas', monospace;
  font-size: 11px;
  overflow-y: auto;
  color: #d4d4d4;
}
.ide-console-content .error { color: #f44; }
.ide-console-content .warn { color: #fa0; }
.ide-console-content .info { color: #4af; }
.ide-output { flex: 1; display: flex; flex-direction: column; }
.ide-output-header {
  background: #c0c0c0;
  padding: 2px 8px;
  font-weight: bold;
  border-bottom: 1px solid #808080;
}
.ide-output-content {
  flex: 1;
  padding: 8px;
  font-family: 'Courier New', monospace;
  font-size: 11px;
  overflow-y: auto;
  background: #fff;
}
.ide-toolbar {
  background: #c0c0c0;
  padding: 2px 4px;
  display: flex;
  gap: 4px;
  border-bottom: 1px solid #808080;
  align-items: center;
}
.ide-toolbar select {
  padding: 2px;
  font-size: 11px;
}

/* Browser */
.browser-toolbar {
  background: #c0c0c0;
  padding: 4px;
  display: flex;
  gap: 4px;
  align-items: center;
  border-bottom: 1px solid #808080;
}
.browser-url {
  flex: 1;
  padding: 2px 4px;
  border: 2px inset #808080;
  font-size: 11px;
}
.browser-frame { flex: 1; border: none; background: white; }

/* Folder */
.folder-content {
  padding: 10px;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}
.folder-item {
  width: 70px;
  text-align: center;
  cursor: pointer;
  padding: 4px;
}
.folder-item:hover { background: #cce8ff; }
.folder-item .icon-img { font-size: 32px; }
.folder-item span { font-size: 11px; display: block; }

/* Wizard */
.wizard-container { padding: 15px; display: flex; flex-direction: column; height: 100%; }
.wizard-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
.wizard-header .icon { font-size: 48px; }
.wizard-header h2 { color: #000080; }
.wizard-form { flex: 1; display: flex; flex-direction: column; gap: 10px; }
.wizard-form label { font-weight: bold; }
.wizard-form input, .wizard-form textarea {
  padding: 4px;
  border: 2px inset #808080;
  font-family: inherit;
}
.wizard-form textarea { flex: 1; min-height: 100px; resize: none; }
.wizard-buttons { display: flex; gap: 8px; justify-content: flex-end; margin-top: 10px; }
.wizard-buttons button { padding: 4px 16px; }
.wizard-status { margin-top: 10px; padding: 8px; background: #f0f0f0; border: 1px solid #808080; }

/* Chat */
.chat-container { display: flex; flex-direction: column; height: 100%; }
.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
  background: #fff;
  border-bottom: 1px solid #808080;
}
.chat-msg { margin-bottom: 8px; }
.chat-msg .name { font-weight: bold; color: #000080; }
.chat-msg .time { color: #888; font-size: 10px; }
.chat-input-area { display: flex; gap: 4px; padding: 4px; background: #c0c0c0; }
.chat-input-area input { flex: 1; padding: 4px; border: 2px inset #808080; }

/* Users list */
.users-list { padding: 8px; background: #f0f0f0; border-left: 1px solid #808080; width: 120px; }
.users-list h4 { margin-bottom: 8px; color: #000080; }
.user-item { padding: 2px 4px; display: flex; align-items: center; gap: 4px; }
.user-dot { width: 8px; height: 8px; border-radius: 50%; background: #0f0; }

/* Ticket Manager */
.ticket-container { display: flex; flex-direction: column; height: 100%; }
.ticket-toolbar { background: #c0c0c0; padding: 4px; display: flex; gap: 4px; align-items: center; border-bottom: 1px solid #808080; }
.toolbar-spacer { flex: 1; }
.icon-btn {
  position: relative;
  padding: 2px 6px;
  font-size: 14px;
  cursor: pointer;
  background: #c0c0c0;
  border: 2px outset #dfdfdf;
}
.icon-btn:hover { background: #d4d4d4; }
.icon-btn:active { border-style: inset; }
.win-tooltip {
  display: none;
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: #ffffe1;
  border: 1px solid #000;
  padding: 4px 8px;
  font-size: 11px;
  white-space: nowrap;
  z-index: 1000;
  box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  margin-bottom: 4px;
  text-align: left;
  line-height: 1.4;
}
.win-tooltip small { color: #666; }
.icon-btn:hover .win-tooltip { display: block; }
.ticket-list { flex: 1; overflow-y: auto; background: #fff; }
.ticket-item {
  padding: 8px;
  border-bottom: 1px solid #ddd;
  cursor: pointer;
  display: flex;
  align-items: flex-start;
  gap: 8px;
}
.ticket-item:hover { background: #e8f4ff; }
.ticket-item.selected { background: #cce8ff; }
.ticket-status {
  padding: 2px 6px;
  border-radius: 3px;
  font-size: 9px;
  font-weight: bold;
  text-transform: uppercase;
  white-space: nowrap;
}
.ticket-status.open { background: #ffeb3b; color: #000; }
.ticket-status.working { background: #2196f3; color: #fff; }
.ticket-status.complete { background: #4caf50; color: #fff; }
.ticket-info { flex: 1; min-width: 0; }
.ticket-title { font-weight: bold; color: #000080; margin-bottom: 2px; }
.ticket-desc { font-size: 10px; color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.ticket-date { font-size: 9px; color: #888; }
.ticket-detail { padding: 10px; background: #f9f9f9; border-top: 2px solid #808080; max-height: 200px; overflow-y: auto; }
.ticket-detail h3 { margin: 0 0 8px; color: #000080; }
.ticket-detail p { margin: 4px 0; font-size: 11px; }
.ticket-reply { background: #e8f4ff; padding: 6px; margin: 4px 0; border-left: 3px solid #2196f3; font-size: 10px; }
.ticket-reply .reply-date { color: #888; font-size: 9px; }
.ticket-new { padding: 10px; background: #f0f0f0; border-top: 2px solid #808080; }
.ticket-new input, .ticket-new textarea {
  width: 100%;
  padding: 4px;
  border: 2px inset #808080;
  margin-bottom: 4px;
  font-family: inherit;
  font-size: 11px;
}
.ticket-new textarea { height: 60px; resize: none; }

/* Sticky Notes */
.sticky-note {
  position: absolute;
  width: 200px;
  min-height: 150px;
  background: #ffff88;
  box-shadow: 2px 2px 8px rgba(0,0,0,0.3);
  display: flex;
  flex-direction: column;
  font-family: 'Comic Sans MS', 'Segoe Print', cursive, sans-serif;
  z-index: 50;
}
.sticky-note.pink { background: #ffb8d0; }
.sticky-note.blue { background: #b8d4ff; }
.sticky-note.green { background: #b8ffb8; }
.sticky-note-header {
  background: rgba(0,0,0,0.1);
  padding: 4px 6px;
  font-size: 10px;
  display: flex;
  align-items: center;
  cursor: move;
}
.sticky-note-header .close-btn {
  margin-left: auto;
  cursor: pointer;
  font-weight: bold;
  padding: 0 4px;
}
.sticky-note-header .close-btn:hover { color: red; }
.sticky-note-content {
  flex: 1;
  padding: 8px;
}
.sticky-note-content textarea {
  width: 100%;
  height: 100%;
  min-height: 100px;
  border: none;
  background: transparent;
  font-family: inherit;
  font-size: 12px;
  resize: none;
  outline: none;
}
.sticky-note-colors {
  display: flex;
  gap: 4px;
  padding: 4px;
  border-top: 1px dashed rgba(0,0,0,0.2);
}
.sticky-note-colors span {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  cursor: pointer;
  border: 1px solid rgba(0,0,0,0.3);
}
.sticky-note-colors .c-yellow { background: #ffff88; }
.sticky-note-colors .c-pink { background: #ffb8d0; }
.sticky-note-colors .c-blue { background: #b8d4ff; }
.sticky-note-colors .c-green { background: #b8ffb8; }

/* Todo Overlay */
#todo-overlay {
  position: absolute;
  top: 10px;
  right: 10px;
  width: 220px;
  background: rgba(0, 0, 128, 0.85);
  border: 2px outset #4040a0;
  box-shadow: 3px 3px 8px rgba(0,0,0,0.4);
  z-index: 80;
  font-size: 11px;
  display: none;
}
#todo-overlay.visible { display: block; }
#todo-overlay .overlay-header {
  background: linear-gradient(90deg, #000080, #4040c0);
  color: white;
  padding: 4px 8px;
  font-weight: bold;
  display: flex;
  align-items: center;
  cursor: move;
}
#todo-overlay .overlay-header .close-btn {
  margin-left: auto;
  cursor: pointer;
  padding: 0 4px;
}
#todo-overlay .overlay-content {
  padding: 8px;
  max-height: 200px;
  overflow-y: auto;
  background: #ffffcc;
  color: #000;
}
#todo-overlay .todo-item {
  display: flex;
  align-items: flex-start;
  gap: 6px;
  padding: 4px 0;
  border-bottom: 1px dashed #ccc;
}
#todo-overlay .todo-item:last-child { border-bottom: none; }
#todo-overlay .todo-item input[type="checkbox"] { margin-top: 2px; }
#todo-overlay .todo-item.done span { text-decoration: line-through; color: #888; }
#todo-overlay .overlay-footer {
  padding: 4px 8px;
  background: #c0c0c0;
  display: flex;
  gap: 4px;
}
#todo-overlay .overlay-footer button {
  font-size: 10px;
  padding: 2px 6px;
}

/* Todo App */
.todo-app { display: flex; flex-direction: column; height: 100%; }
.todo-app-toolbar {
  background: #c0c0c0;
  padding: 4px 8px;
  display: flex;
  gap: 8px;
  align-items: center;
  border-bottom: 1px solid #808080;
}
.todo-app-content {
  flex: 1;
  display: flex;
  overflow: hidden;
}
.todo-lists {
  width: 150px;
  background: #f0f0f0;
  border-right: 1px solid #808080;
  overflow-y: auto;
}
.todo-list-item {
  padding: 6px 10px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
}
.todo-list-item:hover { background: #ddd; }
.todo-list-item.active { background: #000080; color: white; }
.todo-list-item .count {
  margin-left: auto;
  background: #e94560;
  color: white;
  font-size: 9px;
  padding: 1px 5px;
  border-radius: 8px;
}
.todo-items {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}
.todo-full-item {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  padding: 8px;
  border-bottom: 1px solid #ddd;
}
.todo-full-item:hover { background: #f5f5f5; }
.todo-full-item input[type="checkbox"] { margin-top: 3px; }
.todo-full-item .todo-text { flex: 1; }
.todo-full-item .todo-text.done { text-decoration: line-through; color: #888; }
.todo-full-item .todo-date { font-size: 9px; color: #888; }
.todo-full-item .todo-delete {
  color: #e94560;
  cursor: pointer;
  font-size: 14px;
}
.todo-add-form {
  padding: 8px;
  background: #f0f0f0;
  border-top: 1px solid #808080;
  display: flex;
  gap: 4px;
}
.todo-add-form input {
  flex: 1;
  padding: 4px;
  border: 2px inset #808080;
}

/* Calendar Widget */
#calendar-widget {
  position: absolute;
  top: 10px;
  left: 10px;
  width: 200px;
  background: rgba(0, 128, 128, 0.9);
  border: 2px outset #40a0a0;
  box-shadow: 3px 3px 8px rgba(0,0,0,0.4);
  z-index: 75;
  font-size: 11px;
  display: none;
}
#calendar-widget.visible { display: block; }
#calendar-widget .widget-header {
  background: linear-gradient(90deg, #008080, #40a0a0);
  color: white;
  padding: 4px 8px;
  font-weight: bold;
  display: flex;
  align-items: center;
  cursor: move;
}
#calendar-widget .widget-header .close-btn {
  margin-left: auto;
  cursor: pointer;
  padding: 0 4px;
}
#calendar-widget .calendar-nav {
  display: flex;
  justify-content: space-between;
  padding: 4px;
  background: #006060;
  color: white;
}
#calendar-widget .calendar-nav button {
  background: none;
  border: none;
  color: white;
  cursor: pointer;
  font-size: 12px;
}
#calendar-widget .calendar-grid {
  padding: 4px;
  background: #e0f0f0;
}
#calendar-widget .calendar-row {
  display: flex;
}
#calendar-widget .calendar-cell {
  width: 26px;
  height: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  cursor: pointer;
}
#calendar-widget .calendar-cell.header {
  font-weight: bold;
  color: #006060;
}
#calendar-widget .calendar-cell.other-month { color: #999; }
#calendar-widget .calendar-cell.today {
  background: #008080;
  color: white;
  border-radius: 50%;
}
#calendar-widget .calendar-cell.has-event {
  background: #e94560;
  color: white;
  border-radius: 3px;
}
#calendar-widget .calendar-cell:hover:not(.header) { background: rgba(0,128,128,0.3); }
#calendar-widget .upcoming {
  padding: 4px 8px;
  background: #d0e8e8;
  border-top: 1px solid #008080;
  max-height: 60px;
  overflow-y: auto;
}
#calendar-widget .upcoming-item {
  font-size: 9px;
  padding: 2px 0;
  display: flex;
  gap: 4px;
}
#calendar-widget .upcoming-item .date { color: #006060; font-weight: bold; }
#calendar-widget .widget-footer {
  padding: 4px;
  background: #c0c0c0;
  text-align: center;
}
#calendar-widget .widget-footer button {
  font-size: 10px;
  padding: 2px 8px;
}

/* Calendar App */
.calendar-app { display: flex; flex-direction: column; height: 100%; }
.calendar-app-header {
  background: #c0c0c0;
  padding: 4px 8px;
  display: flex;
  gap: 8px;
  align-items: center;
  border-bottom: 1px solid #808080;
}
.calendar-app-content {
  flex: 1;
  display: flex;
  overflow: hidden;
}
.calendar-main {
  flex: 1;
  padding: 8px;
  overflow-y: auto;
}
.calendar-main .month-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}
.calendar-main .month-header h3 { margin: 0; color: #008080; }
.calendar-main .full-grid {
  border: 1px solid #ccc;
}
.calendar-main .full-grid .row { display: flex; }
.calendar-main .full-grid .cell {
  width: 14.28%;
  min-height: 60px;
  border: 1px solid #ddd;
  padding: 2px;
  font-size: 10px;
  cursor: pointer;
}
.calendar-main .full-grid .cell:hover { background: #e0f0f0; }
.calendar-main .full-grid .cell.header {
  min-height: 20px;
  background: #008080;
  color: white;
  font-weight: bold;
  text-align: center;
}
.calendar-main .full-grid .cell.today { background: #c0e0e0; }
.calendar-main .full-grid .cell .day-num { font-weight: bold; }
.calendar-main .full-grid .cell .event {
  background: #e94560;
  color: white;
  padding: 1px 3px;
  margin-top: 2px;
  border-radius: 2px;
  font-size: 9px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.calendar-main .full-grid .cell .event.holiday { background: #4ecdc4; }
.calendar-sidebar {
  width: 180px;
  background: #f0f0f0;
  border-left: 1px solid #808080;
  padding: 8px;
  overflow-y: auto;
}
.calendar-sidebar h4 { margin: 0 0 8px; color: #008080; font-size: 12px; }
.calendar-sidebar .event-item {
  padding: 4px;
  margin-bottom: 4px;
  background: white;
  border: 1px solid #ddd;
  font-size: 10px;
}
.calendar-sidebar .event-item .event-date { color: #888; }
.calendar-sidebar .event-item .event-delete {
  float: right;
  color: #e94560;
  cursor: pointer;
}

/* Shade Station - Shader Editor */
.shade-station { display: flex; flex-direction: column; height: 100%; background: #1a1a2e; color: #eee; }
.shade-station-toolbar {
  background: #16213e;
  padding: 4px 8px;
  display: flex;
  gap: 8px;
  align-items: center;
  border-bottom: 1px solid #0f3460;
}
.shade-station-toolbar button {
  background: #0f3460;
  color: #eee;
  border: 1px solid #e94560;
  padding: 4px 8px;
  font-size: 10px;
  cursor: pointer;
}
.shade-station-toolbar button:hover { background: #e94560; }
.shade-station-toolbar select {
  background: #0f3460;
  color: #eee;
  border: 1px solid #e94560;
  padding: 2px 4px;
  font-size: 10px;
}
.shade-station-main { flex: 1; display: flex; overflow: hidden; }
.shade-station-canvas-wrap {
  flex: 1;
  position: relative;
  background: #000;
  min-width: 200px;
}
.shade-station-canvas-wrap canvas {
  width: 100%;
  height: 100%;
  display: block;
}
.shade-station-editor {
  width: 50%;
  min-width: 200px;
  display: flex;
  flex-direction: column;
  border-left: 1px solid #0f3460;
}
.shade-station-editor textarea {
  flex: 1;
  background: #0d0d1a;
  color: #4ecdc4;
  border: none;
  padding: 8px;
  font-family: 'Consolas', 'Monaco', monospace;
  font-size: 11px;
  resize: none;
  outline: none;
  line-height: 1.4;
}
.shade-station-status {
  background: #16213e;
  padding: 4px 8px;
  font-size: 10px;
  border-top: 1px solid #0f3460;
}
.shade-station-status.error { background: #8b0000; }
.shade-station-uniforms {
  background: #16213e;
  padding: 4px 8px;
  border-top: 1px solid #0f3460;
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  font-size: 10px;
}
.shade-station-uniforms label { display: flex; gap: 4px; align-items: center; }
.shade-station-uniforms input[type="range"] { width: 60px; }

/* Box Editor - ASCII art editor */
.box-editor { display: flex; flex-direction: column; height: 100%; background: #1a1a2e; color: #eee; }
.box-editor-toolbar {
  background: #16213e;
  padding: 4px 8px;
  display: flex;
  gap: 8px;
  align-items: center;
  border-bottom: 1px solid #0f3460;
  flex-wrap: wrap;
}
.box-editor-toolbar button {
  background: #0f3460;
  color: #eee;
  border: 1px solid #e94560;
  padding: 4px 8px;
  font-size: 10px;
  cursor: pointer;
}
.box-editor-toolbar button:hover { background: #e94560; }
.box-editor-toolbar button.active { background: #e94560; }
.box-editor-charbar {
  display: flex;
  gap: 2px;
  background: #0f3460;
  padding: 2px 4px;
  border-radius: 3px;
}
.box-editor-charbar button {
  background: #1a1a2e;
  padding: 2px 6px;
  font-family: monospace;
  font-size: 14px;
}
.box-editor-canvas {
  flex: 1;
  overflow: auto;
  padding: 8px;
  background: #0d0d1a;
}
.box-editor-canvas pre {
  font-family: 'Consolas', 'Monaco', monospace;
  font-size: 14px;
  line-height: 1.2;
  color: #4ecdc4;
  margin: 0;
  cursor: crosshair;
  white-space: pre;
}
.box-editor-status {
  background: #16213e;
  padding: 4px 8px;
  font-size: 10px;
  border-top: 1px solid #0f3460;
  display: flex;
  justify-content: space-between;
}

/* Context menu "Open With" submenu */
.ctx-submenu {
  position: absolute;
  left: 100%;
  top: 0;
  background: #c0c0c0;
  border: 2px outset #fff;
  display: none;
  min-width: 100px;
  max-height: calc(100vh - 50px);
  overflow-y: auto;
}
.ctx-item.has-submenu { position: relative; }
.ctx-item.has-submenu::after { content: '‚ñ∂'; float: right; margin-left: 8px; font-size: 8px; }
.ctx-item.has-submenu:hover > .ctx-submenu { display: block; }

/* ALGO Dolphin Mascot */
#algo-dolphin {
  position: absolute;
  font-size: 32px;
  z-index: 100;
  pointer-events: none;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
}
#algo-dolphin.swimming {
  animation: dolphin-bob-right 2s ease-in-out infinite;
}
#algo-dolphin.swimming[data-facing="left"] {
  animation: dolphin-bob-left 2s ease-in-out infinite;
}
@keyframes dolphin-bob-right {
  0%, 100% { transform: scaleX(1) translateY(0) rotate(0deg); }
  25% { transform: scaleX(1) translateY(-8px) rotate(-5deg); }
  50% { transform: scaleX(1) translateY(0) rotate(0deg); }
  75% { transform: scaleX(1) translateY(-4px) rotate(5deg); }
}
@keyframes dolphin-bob-left {
  0%, 100% { transform: scaleX(-1) translateY(0) rotate(0deg); }
  25% { transform: scaleX(-1) translateY(-8px) rotate(5deg); }
  50% { transform: scaleX(-1) translateY(0) rotate(0deg); }
  75% { transform: scaleX(-1) translateY(-4px) rotate(-5deg); }
}

/* Taskbar */
#taskbar {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 28px;
  background: #c0c0c0;
  border-top: 2px outset #fff;
  display: flex;
  align-items: center;
  padding: 2px;
  z-index: 9000;
}
#start-btn {
  background: #c0c0c0;
  border: 2px outset #fff;
  padding: 2px 6px;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 11px;
}
#start-btn:active, #start-btn.active { border-style: inset; }
#taskbar-windows {
  flex: 1;
  display: flex;
  gap: 2px;
  margin-left: 4px;
  overflow: hidden;
}
.taskbar-item {
  background: #c0c0c0;
  border: 2px outset #fff;
  padding: 2px 8px;
  font-size: 11px;
  cursor: pointer;
  max-width: 140px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.taskbar-item.active { border-style: inset; background: #a0a0a0; }
#mini-player {
  display: none;
  align-items: center;
  gap: 4px;
  background: #c0c0c0;
  border: 2px inset #808080;
  padding: 2px 6px;
  font-size: 10px;
  margin-left: auto;
}
#mini-player.visible { display: flex; }
#mini-player .mini-btn {
  background: #c0c0c0;
  border: 2px outset #fff;
  padding: 1px 4px;
  cursor: pointer;
  font-size: 10px;
}
#mini-player .mini-btn:active { border: 2px inset #808080; }
#mini-player .mini-title {
  max-width: 100px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  cursor: pointer;
}
#mini-player .mini-title:hover { text-decoration: underline; }

#clock {
  background: #c0c0c0;
  border: 2px inset #808080;
  padding: 2px 8px;
  font-size: 11px;
}

/* Start Menu */
#start-menu {
  position: absolute;
  bottom: 28px;
  left: 0;
  background: #c0c0c0;
  border: 2px outset #fff;
  display: none;
  z-index: 9999;
  min-width: 200px;
  max-height: calc(100vh - 32px);
  overflow-y: auto;
}
#start-menu.visible { display: block; }
.start-sidebar {
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 22px;
  background: linear-gradient(#000080, #1084d0);
  writing-mode: vertical-rl;
  color: white;
  font-weight: bold;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding-bottom: 8px;
}
.start-items { margin-left: 22px; padding: 2px 0; }
.start-item {
  padding: 4px 20px 4px 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  position: relative;
}
.start-item:hover { background: #000080; color: white; }
.start-separator { border-top: 1px solid #808080; border-bottom: 1px solid white; margin: 2px 4px; }
.start-submenu {
  position: absolute;
  left: 100%;
  top: 0;
  background: #c0c0c0;
  border: 2px outset #fff;
  display: none;
  min-width: 140px;
  max-height: calc(100vh - 50px);
  overflow-y: auto;
}
.start-item:hover > .start-submenu { display: block; }
.start-item.has-sub::after { content: '‚ñ∂'; position: absolute; right: 6px; font-size: 8px; }

/* Context Menu */
#context-menu {
  position: absolute;
  background: #c0c0c0;
  border: 2px outset #fff;
  display: none;
  z-index: 10000;
  min-width: 120px;
}
#context-menu.visible { display: block; }
.ctx-item { padding: 4px 20px 4px 8px; cursor: pointer; }
.ctx-item:hover { background: #000080; color: white; }
.ctx-sep { border-top: 1px solid #808080; border-bottom: 1px solid white; margin: 2px 4px; }

/* Notepad */
.notepad-container { display: flex; flex-direction: column; height: 100%; }
.notepad-textarea {
  flex: 1;
  border: none;
  resize: none;
  font-family: 'Courier New', monospace;
  font-size: 12px;
  padding: 4px;
}

/* ALGO sprite */
#algo-sprite { position: absolute; cursor: pointer; z-index: 100; }
#speech-bubble {
  position: absolute;
  background: white;
  border: 2px solid #000;
  border-radius: 10px;
  padding: 8px;
  max-width: 200px;
  font-size: 11px;
  display: none;
  z-index: 101;
}

/* Music Player - Winamp style */
.winamp-player {
  display: flex;
  flex-direction: column;
  height: 100%;
  background: #232323;
  color: #00ff00;
  font-family: 'Arial Narrow', Arial, sans-serif;
  font-size: 10px;
}
.winamp-header {
  background: linear-gradient(180deg, #4a6a4a 0%, #2a3a2a 50%, #1a2a1a 100%);
  padding: 4px 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.winamp-header .title {
  color: #00ff00;
  font-weight: bold;
  font-size: 11px;
  text-shadow: 1px 1px #000;
}
.winamp-display {
  background: #000;
  margin: 4px;
  padding: 8px;
  border: 2px inset #1a1a1a;
}
.winamp-display .track-title {
  color: #00ff00;
  font-size: 14px;
  margin-bottom: 4px;
  white-space: nowrap;
  overflow: hidden;
}
.winamp-display .track-time {
  color: #00ff88;
  font-family: 'Courier New', monospace;
  font-size: 20px;
  font-weight: bold;
}
.winamp-controls {
  display: flex;
  justify-content: center;
  gap: 4px;
  padding: 8px;
  background: #2a2a2a;
}
.winamp-btn {
  width: 28px;
  height: 20px;
  background: linear-gradient(180deg, #555 0%, #333 100%);
  border: 1px outset #666;
  color: #ccc;
  cursor: pointer;
  font-size: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.winamp-btn:active { border-style: inset; }
.winamp-btn:hover { background: linear-gradient(180deg, #666 0%, #444 100%); }
.winamp-volume {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 4px 8px;
  background: #1a1a1a;
}
.winamp-volume input[type="range"] {
  width: 80px;
  accent-color: #00ff00;
}
.winamp-playlist {
  flex: 1;
  overflow-y: auto;
  background: #0a0a0a;
  border: 2px inset #1a1a1a;
  margin: 4px;
}
.winamp-track {
  padding: 4px 8px;
  cursor: pointer;
  color: #00cc00;
  display: flex;
  align-items: center;
  gap: 6px;
}
.winamp-track:hover { background: #1a3a1a; }
.winamp-track.active { background: #003300; color: #00ff00; }
.winamp-track .track-num { color: #009900; width: 20px; }
.winamp-track .track-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.winamp-track .track-dur { color: #006600; font-size: 9px; }
.winamp-status {
  background: #1a1a1a;
  padding: 4px 8px;
  color: #009900;
  font-size: 9px;
  border-top: 1px solid #333;
}

/* Video Player - 1998 style */
.video-player {
  display: flex;
  flex-direction: column;
  height: 100%;
  background: #c0c0c0;
}
.video-display {
  flex: 1;
  background: #000;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 200px;
}
.video-display iframe {
  width: 100%;
  height: 100%;
  border: none;
}
.video-display .no-video {
  color: #666;
  font-size: 14px;
}
.video-controls {
  background: #c0c0c0;
  padding: 4px;
  display: flex;
  align-items: center;
  gap: 4px;
  border-top: 2px outset #fff;
}
.video-btn {
  padding: 2px 8px;
  background: #c0c0c0;
  border: 2px outset #fff;
  cursor: pointer;
  font-size: 10px;
}
.video-btn:active { border-style: inset; }
.video-progress {
  flex: 1;
  height: 12px;
  background: #fff;
  border: 2px inset #808080;
}
.video-progress-bar {
  height: 100%;
  background: #000080;
  width: 0%;
}
.video-playlist {
  max-height: 120px;
  overflow-y: auto;
  background: #fff;
  border: 2px inset #808080;
  margin: 4px;
}
.video-item {
  padding: 4px 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 11px;
}
.video-item:hover { background: #cce8ff; }
.video-item.active { background: #000080; color: #fff; }
.video-item .video-thumb {
  width: 48px;
  height: 36px;
  background: #ccc;
  object-fit: cover;
}
.video-item .video-info { flex: 1; }
.video-item .video-title { font-weight: bold; }
.video-item .video-source { font-size: 9px; color: #666; }
.video-item.active .video-source { color: #aaa; }

/* Mobile styles */
@media (max-width: 768px) {
  body { font-size: 14px; }
  .desktop-icon {
    width: 90px;
    padding: 8px;
  }
  .desktop-icon .icon-img {
    font-size: 48px;
  }
  .desktop-icon .icon-thumbnail {
    width: 48px;
    height: 48px;
  }
  .desktop-icon .icon-thumbnail img {
    max-width: 48px;
    max-height: 48px;
  }
  .desktop-icon span {
    font-size: 13px;
  }
  #taskbar {
    height: 40px;
  }
  #start-btn {
    font-size: 14px;
    padding: 4px 12px;
  }
  .taskbar-item {
    font-size: 12px;
    padding: 4px 10px;
    max-width: 120px;
  }
  #clock {
    font-size: 13px;
    padding: 4px 10px;
  }
  .window-titlebar {
    padding: 4px 6px;
    font-size: 13px;
  }
  .window-btn {
    width: 20px;
    height: 20px;
    font-size: 14px;
  }
  #start-menu {
    width: 220px;
    font-size: 13px;
    bottom: 40px; /* Match mobile taskbar height */
  }
  .start-item {
    padding: 8px 12px;
  }
  .ctx-item {
    padding: 8px 16px;
    font-size: 13px;
  }
  .sticky-note {
    min-width: 140px;
    min-height: 120px;
    font-size: 13px;
  }
}

/* Login Overlay */
#login-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 99999;
}
#login-overlay.hidden { display: none; }
.login-dialog {
  background: #c0c0c0;
  border: 2px outset #fff;
  padding: 20px;
  width: 320px;
}
.login-dialog h2 {
  text-align: center;
  margin-bottom: 15px;
  color: #000080;
}
.login-dialog label { display: block; margin: 10px 0 4px; }
.login-dialog input {
  width: 100%;
  padding: 4px;
  border: 2px inset #808080;
}
.login-dialog .buttons {
  margin-top: 15px;
  display: flex;
  gap: 8px;
  justify-content: center;
}
.login-dialog button {
  padding: 4px 16px;
  background: #c0c0c0;
  border: 2px outset #fff;
  cursor: pointer;
}
.login-dialog button:active { border-style: inset; }
.login-dialog .error { color: red; font-size: 11px; margin-top: 8px; text-align: center; }
.login-dialog .tabs { display: flex; margin-bottom: 15px; }
.login-dialog .tab {
  flex: 1;
  padding: 6px;
  text-align: center;
  background: #e0e0e0;
  cursor: pointer;
  border: 1px solid #808080;
}
.login-dialog .tab.active { background: #c0c0c0; border-bottom: none; }
#user-indicator {
  position: fixed;
  top: 4px;
  right: 4px;
  background: rgba(0,0,0,0.5);
  color: white;
  padding: 2px 8px;
  font-size: 10px;
  border-radius: 2px;
  z-index: 9998;
}
</style>
</head>
<body>

<!-- Login Overlay -->
<div id="login-overlay">
  <div class="login-dialog">
    <h2>‚ö° Function Server</h2>
    <div class="tabs">
      <div class="tab active" data-tab="login" onclick="showLoginTab('login')">Login</div>
      <div class="tab" data-tab="register" onclick="showLoginTab('register')">Register</div>
    </div>
    <div id="login-form">
      <label>Username:</label>
      <input type="text" id="login-username" autocomplete="username">
      <label>Password:</label>
      <input type="password" id="login-password" autocomplete="current-password">
      <div class="buttons">
        <button onclick="doLogin()">Login</button>
      </div>
    </div>
    <div id="register-form" style="display:none;">
      <label>Username:</label>
      <input type="text" id="reg-username" autocomplete="username">
      <label>Password:</label>
      <input type="password" id="reg-password" autocomplete="new-password">
      <label>Confirm:</label>
      <input type="password" id="reg-confirm" autocomplete="new-password">
      <div class="buttons">
        <button onclick="doRegister()">Create Account</button>
      </div>
    </div>
    <div id="login-error" class="error"></div>
  </div>
</div>

<div id="user-indicator"></div>
<div id="desktop"></div>
<div id="algo-dolphin" class="swimming">üê¨</div>

<div id="taskbar">
  <div id="start-btn" onclick="toggleStartMenu()">
    <span style="font-size:14px;">üê¨</span> Start
  </div>
  <div id="taskbar-windows"></div>
  <div id="mini-player">
    <span class="mini-btn" onclick="miniPlayerPrev()">‚èÆ</span>
    <span class="mini-btn" id="mini-play-btn" onclick="miniPlayerToggle()">‚ñ∂</span>
    <span class="mini-btn" onclick="miniPlayerNext()">‚è≠</span>
    <span class="mini-title" id="mini-player-title" onclick="miniPlayerOpen()">No track</span>
  </div>
  <div id="clock"></div>
</div>

<div id="start-menu">
  <div class="start-sidebar">ALGO98</div>
  <div class="start-items">
    <div class="start-item has-sub">
      <span>üìÅ</span> Programs
      <div class="start-submenu" id="programs-menu">
        <div class="start-item" onclick="openNotepad()"><span>üìù</span> Notepad</div>
        <div class="start-item" onclick="openJSIDE()"><span>üìú</span> JavaScript.IDE</div>
        <div class="start-item" onclick="openBrowser()"><span>üåê</span> Web Browser</div>
        <div class="start-separator"></div>
        <div class="start-item" onclick="openClaudeWizard()"><span>ü§ñ</span> Claude Wizard</div>
        <div class="start-item" onclick="openGeminiWizard()"><span>üíé</span> Gemini Wizard</div>
        <div class="start-item" onclick="openGPTWizard()"><span>üß†</span> GPT Wizard</div>
        <div class="start-separator"></div>
        <div class="start-item" onclick="openChat()"><span>üí¨</span> ALGO Chat</div>
        <div class="start-item" onclick="openWebcam()"><span>üìπ</span> ALGO Webcam</div>
        <div class="start-item" onclick="openPhotobooth()"><span>üì∏</span> Photobooth</div>
        <div class="start-item" onclick="openTicketManager()"><span>üé´</span> Ticket Manager</div>
        <div class="start-separator"></div>
        <div class="start-item" onclick="openMusicPlayer()"><span>üéµ</span> Music Player</div>
        <div class="start-item" onclick="openVideoPlayer()"><span>üì∫</span> Video Player</div>
        <div class="start-item" onclick="openMidiEditor()"><span>üéπ</span> MIDI Editor</div>
        <div class="start-item" onclick="openChimeSynth()"><span>üîî</span> Chime Synth</div>
        <div class="start-item" onclick="openTodoApp()"><span>üìã</span> Todo Manager</div>
        <div class="start-item" onclick="openCalendarApp()"><span>üìÖ</span> Calendar</div>
        <div class="start-item" onclick="openShadeStation()"><span>üé®</span> Shade Station</div>
        <div class="start-item" onclick="openBoxEditor()"><span>üì¶</span> Box Editor</div>
        <div class="start-separator"></div>
        <div id="installed-programs-menu"></div>
      </div>
    </div>
    <div class="start-item" onclick="openDocumentation()"><span style="color:#8B0000;">üìï</span> Documentation</div>
    <div class="start-item" onclick="openHelp()"><span style="color:#8B0000;">üìô</span> ALGO OS Help</div>
    <div class="start-separator"></div>
    <div class="start-item" onclick="openNotepad()"><span>üìù</span> New Post</div>
    <div class="start-item" onclick="createStickyNote()"><span>üìå</span> New Sticky Note</div>
    <div class="start-separator"></div>
    <div class="start-item" onclick="showAbout()"><span>‚ö°</span> About</div>
    <div class="start-item" onclick="openSettings()"><span>‚öôÔ∏è</span> Settings</div>
    <div class="start-separator"></div>
    <div class="start-item" onclick="logout()"><span>üö™</span> Log Out</div>
  </div>
</div>

<div id="context-menu"></div>

<div id="algo-sprite" style="left:100px;top:350px;" onclick="algoSpeak()">
  <svg width="48" height="48" viewBox="0 0 48 48">
    <ellipse cx="24" cy="24" rx="18" ry="12" fill="#1E90FF"/>
    <ellipse cx="32" cy="22" rx="4" ry="3" fill="white"/>
    <circle cx="33" cy="22" r="1.5" fill="black"/>
    <path d="M6 24 Q2 20 6 16" stroke="#1E90FF" stroke-width="3" fill="none"/>
    <path d="M42 24 L52 20" stroke="#1E90FF" stroke-width="4" fill="none"/>
    <ellipse cx="24" cy="28" rx="6" ry="2" fill="#B0E0E6"/>
  </svg>
</div>
<div id="speech-bubble"></div>

<div id="todo-overlay">
  <div class="overlay-header">
    <span>üìã Tasks</span>
    <span class="close-btn" onclick="hideTodoOverlay()">√ó</span>
  </div>
  <div class="overlay-content" id="todo-overlay-content">
    <div style="color:#888;text-align:center;">No pending tasks</div>
  </div>
  <div class="overlay-footer">
    <button onclick="openTodoApp()">Open Todo App</button>
    <button onclick="hideTodoOverlay()">Hide</button>
  </div>
</div>

<div id="calendar-widget">
  <div class="widget-header" onmousedown="startCalendarWidgetDrag(event)" ontouchstart="startCalendarWidgetDrag(event)">
    <span>üìÖ Calendar</span>
    <span class="close-btn" onclick="hideCalendarWidget()">√ó</span>
  </div>
  <div class="calendar-nav">
    <button onclick="calendarWidgetPrev()">‚óÄ</button>
    <span id="calendar-widget-month">January 2026</span>
    <button onclick="calendarWidgetNext()">‚ñ∂</button>
  </div>
  <div class="calendar-grid" id="calendar-widget-grid"></div>
  <div class="upcoming" id="calendar-widget-upcoming"></div>
  <div class="widget-footer">
    <button onclick="openCalendarApp()">Open Calendar</button>
  </div>
</div>

<script>
// ==================== AUTH CONFIG ====================
const API_BASE = '/api';
let currentUser = null;
let sessionToken = null;

// ==================== AUTH FUNCTIONS ====================
function checkSession() {
  const token = localStorage.getItem('session_token');
  const user = localStorage.getItem('username');
  if (token && user) {
    fetch(API_BASE + '/auth/verify', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token, username: user })
    })
    .then(r => r.json())
    .then(data => {
      if (data.valid) {
        loginSuccess(user, token);
      } else {
        showLogin();
      }
    })
    .catch(() => showLogin());
  } else {
    showLogin();
  }
}

function showLogin() {
  document.getElementById('login-overlay').classList.remove('hidden');
}

function hideLogin() {
  document.getElementById('login-overlay').classList.add('hidden');
}

function showLoginTab(tab) {
  document.querySelectorAll('.login-dialog .tab').forEach(t => {
    t.classList.toggle('active', t.dataset.tab === tab);
  });
  document.getElementById('login-form').style.display = tab === 'login' ? 'block' : 'none';
  document.getElementById('register-form').style.display = tab === 'register' ? 'block' : 'none';
  document.getElementById('login-error').textContent = '';
}

function loginSuccess(username, token) {
  currentUser = username;
  sessionToken = token;
  localStorage.setItem('session_token', token);
  localStorage.setItem('username', username);
  hideLogin();
  document.getElementById('user-indicator').textContent = username + '@FunctionServer';
  init();
}

function doLogin() {
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  const errorEl = document.getElementById('login-error');

  if (!username || !password) {
    errorEl.textContent = 'Please enter username and password';
    return;
  }

  fetch(API_BASE + '/auth/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, password })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      loginSuccess(data.username, data.token);
    } else {
      errorEl.textContent = data.error || 'Login failed';
    }
  })
  .catch(e => {
    errorEl.textContent = 'Connection error';
  });
}

function doRegister() {
  const username = document.getElementById('reg-username').value.trim();
  const password = document.getElementById('reg-password').value;
  const confirm = document.getElementById('reg-confirm').value;
  const errorEl = document.getElementById('login-error');

  if (!username || !password) {
    errorEl.textContent = 'Please fill all fields';
    return;
  }
  if (password !== confirm) {
    errorEl.textContent = 'Passwords do not match';
    return;
  }
  if (password.length < 6) {
    errorEl.textContent = 'Password must be at least 6 characters';
    return;
  }

  fetch(API_BASE + '/auth/register', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, password })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      loginSuccess(data.username, data.token);
    } else {
      errorEl.textContent = data.error || 'Registration failed';
    }
  })
  .catch(e => {
    errorEl.textContent = 'Connection error';
  });
}

function logout() {
  currentUser = null;
  sessionToken = null;
  localStorage.removeItem('session_token');
  localStorage.removeItem('username');
  location.reload();
}

// ==================== STATE ====================
let windows = [];
let winId = 0;
let activeWin = null;
let savedFiles = [];
let installedPrograms = [];
let roomFolders = [];
let windowStates = {};
let apiKeys = {};
let dragWin = null;
let dragOffset = {x:0,y:0};
let contextTarget = null;

// P2P Chat State
let chatPeerId = 'p' + Math.random().toString(36).substr(2, 9);
let chatPeers = {}; // peerId -> { pc, dataChannel, connected, name }
let chatRoom = 'algo-chat';
let chatName = localStorage.getItem('algo-chat-name') || 'anon';
let chatPollInterval = null;
let chatWinId = null;

// Sticky Notes State
let stickyNotes = [];
let stickyNoteId = 0;
let dragStickyNote = null;

// Icon Drag State
let dragIcon = null;
let iconDragOffset = {x:0, y:0};
let iconPositions = {}; // iconId -> {x, y}

// Todo State
let todoLists = []; // { id, name, items: [{ id, text, done, created }] }
let todoOverlayHidden = false;
let todoWinId = null;

// Calendar State
let calendarEvents = []; // { id, title, date, isHoliday }
let calendarWidgetHidden = false;
let calendarWidgetMonth = new Date().getMonth();
let calendarWidgetYear = new Date().getFullYear();
let calendarWinId = null;
let calendarAppMonth = new Date().getMonth();
let calendarAppYear = new Date().getFullYear();
let stickyDragOffset = {x:0, y:0};
let calendarWidgetPos = { x: null, y: null }; // null means use percentage-based default
let calendarWidgetDragging = false;
let calendarWidgetDragOffset = { x: 0, y: 0 };

const HELP_CONTENT = {
  'welcome': {
    title: 'Welcome to ALGO OS',
    content: `<h1>Welcome to ALGO OS</h1>
<p>ALGO OS is your retro computing experience on Laserbarf!</p>
<h2>Getting Started</h2>
<ul>
<li><b>Double-click</b> icons to open programs</li>
<li><b>Right-click</b> for context menus</li>
<li>Use the <b>Start Menu</b> to access programs</li>
</ul>
<h2>AI Wizards</h2>
<p>Use Claude, Gemini, or GPT wizards to create new artifacts!</p>
<h2>Secret Key</h2>
<p>You're in the trusted zone with key <code>dolphin42</code></p>`
  },
  'wizards': {
    title: 'AI Wizards',
    content: `<h1>AI App Wizards</h1>
<p>Create new artifacts using AI!</p>
<h2>Setup</h2>
<ol>
<li>Open a wizard from Start ‚Üí Programs</li>
<li>Enter your API key (saved locally)</li>
<li>Describe what you want to create</li>
<li>Click Generate!</li>
</ol>
<p>Generated apps appear on your desktop.</p>`
  },
  'chat': {
    title: 'ALGO Chat',
    content: `<h1>ALGO Chat</h1>
<p>Chat with other ALGO OS users in real-time!</p>
<h2>Features</h2>
<ul>
<li>See who's online</li>
<li>Send messages</li>
<li>Messages persist in #algo-world</li>
</ul>`
  },
  'shadestation': {
    title: 'Shade Station',
    content: `<h1>Shade Station</h1>
<p>A real-time WebGL shader editor for creating visual effects.</p>
<h2>Features</h2>
<ul>
<li>Live preview as you type</li>
<li>Built-in presets (Rainbow, Plasma, Circles, Mouse)</li>
<li>Uniforms: u_time, u_resolution, u_mouse</li>
<li>Save shaders to desktop as .shader files</li>
<li>Speed control and pause</li>
</ul>
<h2>Shader Uniforms</h2>
<ul>
<li><code>u_time</code> - elapsed time in seconds</li>
<li><code>u_resolution</code> - canvas width/height</li>
<li><code>u_mouse</code> - mouse position</li>
</ul>
<h2>File Format</h2>
<p>Shade Station uses .shader files containing GLSL fragment shader code. Double-click any .shader file to open it.</p>`
  }
};

const DOC_URLS = {
  'top-secret': '/top-secret',
  'artifact-guide': '/artifact-guide',
  'secret-ai': '/secret-ai'
};

// ==================== INIT ====================
function init() {
  loadState();
  createDesktopIcons();
  loadStickyNotes();
  loadTodos();
  loadCalendar();
  registerShaderFileType();
  registerBoxFileType();
  loadDesktopBackground();
  updateClock();
  setInterval(updateClock, 1000);

  document.addEventListener('click', globalClick);
  document.addEventListener('contextmenu', showContextMenu);
  document.addEventListener('mousedown', startDrag);
  document.addEventListener('mousemove', onDrag);
  document.addEventListener('mouseup', endDrag);
  document.addEventListener('paste', handleDesktopPaste);

  // Touch support for mobile - dragging windows and long press context menu
  let longPressTimer = null;
  let longPressTarget = null;
  let touchDragging = false;

  document.addEventListener('touchstart', (e) => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

    const touch = e.touches[0];
    const titlebar = e.target.closest('.window-titlebar');

    // Check if touching a window titlebar for dragging
    if (titlebar && !e.target.classList.contains('window-btn')) {
      const id = parseInt(titlebar.dataset.winid);
      dragWin = windows.find(w => w.id === id);
      if (dragWin) {
        const el = document.getElementById('win-' + id);
        dragOffset.x = touch.clientX - el.offsetLeft;
        dragOffset.y = touch.clientY - el.offsetTop;
        touchDragging = true;
        focusWindow(id);
        e.preventDefault(); // Prevent scrolling when starting to drag
        return;
      }
    }

    // Check if touching a sticky note header for dragging
    const stickyHeader = e.target.closest('.sticky-header');
    if (stickyHeader) {
      const stickyEl = stickyHeader.closest('.sticky-note');
      if (stickyEl) {
        const id = parseInt(stickyEl.id.replace('sticky-', ''));
        dragStickyNote = stickyNotes.find(n => n.id === id);
        if (dragStickyNote) {
          stickyDragOffset.x = touch.clientX - stickyEl.offsetLeft;
          stickyDragOffset.y = touch.clientY - stickyEl.offsetTop;
          touchDragging = true;
          e.preventDefault();
          return;
        }
      }
    }

    // Check if touching a desktop icon - handle tap vs drag
    const icon = e.target.closest('.desktop-icon');
    if (icon) {
      // Store touch start position for drag detection
      icon._touchStart = { x: touch.clientX, y: touch.clientY, time: Date.now() };
      icon._touchMoved = false;
      iconDragOffset.x = touch.clientX - icon.offsetLeft;
      iconDragOffset.y = touch.clientY - icon.offsetTop;
      icon.classList.add('selected');
      document.querySelectorAll('.desktop-icon').forEach(i => {
        if (i !== icon) i.classList.remove('selected');
      });
      // Don't start drag immediately - wait for movement
      dragIcon = null;
      touchDragging = false;
      e.preventDefault();
      return;
    }

    // Long press for context menu (only if not dragging)
    longPressTarget = { x: touch.clientX, y: touch.clientY, target: e.target };
    longPressTimer = setTimeout(() => {
      if (longPressTarget && !touchDragging) {
        showContextMenu({ preventDefault: ()=>{}, clientX: longPressTarget.x, clientY: longPressTarget.y, target: longPressTarget.target });
        longPressTarget = null;
      }
    }, 600);
  }, { passive: false });

  document.addEventListener('touchmove', (e) => {
    clearTimeout(longPressTimer);
    longPressTarget = null;

    if (touchDragging && e.touches.length > 0) {
      const touch = e.touches[0];

      if (dragWin) {
        const el = document.getElementById('win-' + dragWin.id);
        dragWin.x = touch.clientX - dragOffset.x;
        dragWin.y = touch.clientY - dragOffset.y;
        el.style.left = dragWin.x + 'px';
        el.style.top = dragWin.y + 'px';
        e.preventDefault(); // Prevent scrolling while dragging
      }

      if (dragStickyNote) {
        const el = document.getElementById('sticky-' + dragStickyNote.id);
        dragStickyNote.x = touch.clientX - stickyDragOffset.x;
        dragStickyNote.y = touch.clientY - stickyDragOffset.y;
        el.style.left = dragStickyNote.x + 'px';
        el.style.top = dragStickyNote.y + 'px';
        e.preventDefault();
      }

      if (dragIcon) {
        let newX = touch.clientX - iconDragOffset.x;
        let newY = touch.clientY - iconDragOffset.y;
        // Keep icon on screen
        const desktop = document.getElementById('desktop');
        const maxX = desktop.clientWidth - dragIcon.offsetWidth;
        const maxY = desktop.clientHeight - dragIcon.offsetHeight - 40;
        newX = Math.max(0, Math.min(newX, maxX));
        newY = Math.max(0, Math.min(newY, maxY));
        dragIcon.style.left = newX + 'px';
        dragIcon.style.top = newY + 'px';
        e.preventDefault();
      }
    }

    // Check if a selected icon needs to start dragging (moved more than 10px)
    const selectedIcon = document.querySelector('.desktop-icon.selected');
    if (selectedIcon && selectedIcon._touchStart && !dragIcon && e.touches.length > 0) {
      const touch = e.touches[0];
      const dx = Math.abs(touch.clientX - selectedIcon._touchStart.x);
      const dy = Math.abs(touch.clientY - selectedIcon._touchStart.y);
      if (dx > 10 || dy > 10) {
        selectedIcon._touchMoved = true;
        dragIcon = selectedIcon;
        touchDragging = true;
        e.preventDefault();
      }
    }
  }, { passive: false });

  // Track last tap for double-tap detection
  let lastIconTap = { time: 0, icon: null };

  document.addEventListener('touchend', (e) => {
    clearTimeout(longPressTimer);
    longPressTarget = null;

    // Check for icon tap (not drag)
    const selectedIcon = document.querySelector('.desktop-icon.selected');
    if (selectedIcon && selectedIcon._touchStart && !selectedIcon._touchMoved && !touchDragging) {
      const now = Date.now();
      const tapDuration = now - selectedIcon._touchStart.time;

      // If quick tap (< 300ms) - treat as a tap
      if (tapDuration < 300) {
        // Check for double tap
        if (lastIconTap.icon === selectedIcon && (now - lastIconTap.time) < 400) {
          // Double tap - open the icon
          if (selectedIcon.ondblclick) selectedIcon.ondblclick();
          lastIconTap = { time: 0, icon: null };
        } else {
          // Single tap - remember for potential double tap
          lastIconTap = { time: now, icon: selectedIcon };
        }
      }
      selectedIcon._touchStart = null;
    }

    if (touchDragging) {
      if (dragWin) {
        const stateKey = dragWin.stateKey || dragWin.title;
        windowStates[stateKey] = { x: dragWin.x, y: dragWin.y, width: dragWin.width, height: dragWin.height };
        saveState();
      }
      if (dragStickyNote) {
        saveStickyNotes();
      }
      if (dragIcon) {
        const iconId = dragIcon.dataset.iconId;
        iconPositions[iconId] = {
          x: parseInt(dragIcon.style.left),
          y: parseInt(dragIcon.style.top)
        };
        localStorage.setItem('algo-icon-positions', JSON.stringify(iconPositions));
        dragIcon._touchStart = null;
        dragIcon._touchMoved = false;
      }
      dragWin = null;
      dragStickyNote = null;
      dragIcon = null;
      touchDragging = false;
    }
  });

  setTimeout(() => algoSpeak("Welcome to ALGO OS! Try the AI Wizards!"), 1500);
}

function handleDesktopPaste(e) {
  // Only handle paste if not in an input/textarea
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
  if (e.target.isContentEditable) return;

  const clipboardData = e.clipboardData || window.clipboardData;

  // Check for images first
  const items = clipboardData.items;
  if (items) {
    for (let i = 0; i < items.length; i++) {
      if (items[i].type.indexOf('image') !== -1) {
        e.preventDefault();
        const blob = items[i].getAsFile();
        const reader = new FileReader();
        reader.onload = function(event) {
          const dataUrl = event.target.result;
          const filename = generatePasteFilename('img', '.png');
          savedFiles.push({ name: filename, content: dataUrl, type: 'image' });
          saveState();
          createDesktopIcons();
          algoSpeak('Pasted ' + filename);
        };
        reader.readAsDataURL(blob);
        return;
      }
    }
  }

  // Check for text
  const text = clipboardData.getData('text').trim();
  if (!text) return;

  // Check if it's a laserbarf URL or artifact name - create shortcut
  let artifactName = null;
  if (text.match(/^https?:\/\/(www\.)?laserbarf\.com\/([a-z0-9-]+)/i)) {
    artifactName = text.match(/laserbarf\.com\/([a-z0-9-]+)/i)[1];
  } else if (text.match(/^\/([a-z0-9-]+)/i)) {
    artifactName = text.match(/^\/([a-z0-9-]+)/i)[1];
  }

  if (artifactName) {
    e.preventDefault();
    createDesktopShortcut(artifactName);
    algoSpeak('Added shortcut: ' + artifactName);
    return;
  }

  // Otherwise create a text file
  e.preventDefault();
  const filename = generatePasteFilename('note', '.txt');
  savedFiles.push({ name: filename, content: text, type: 'text' });
  saveState();
  createDesktopIcons();
  algoSpeak('Pasted ' + filename);
}

function generatePasteFilename(prefix, ext) {
  const syllables = ['mo','ha','lo','ki','ra','zu','na','te','fi','bo','se','lu','pa','ri','do','ve'];
  let name = prefix + '-' + syllables[Math.floor(Math.random()*syllables.length)] +
             syllables[Math.floor(Math.random()*syllables.length)] + ext;
  let counter = 1;
  while (savedFiles.some(f => f.name === name)) {
    name = prefix + '-' + syllables[Math.floor(Math.random()*syllables.length)] +
           syllables[Math.floor(Math.random()*syllables.length)] + '(' + counter + ')' + ext;
    counter++;
  }
  return name;
}

function createDesktopIcons() {
  const desktop = document.getElementById('desktop');
  desktop.innerHTML = '';

  const defaultIcons = [
    { id: 'docs', name: 'Documentation', icon: 'üìï', x: 20, y: 20, action: 'openDocumentation' },
    { id: 'notepad', name: 'Notepad', icon: 'üìù', x: 20, y: 100, action: 'openNotepad' },
    { id: 'jsIDE', name: 'JavaScript.IDE', icon: 'üìú', x: 20, y: 180, action: 'openJSIDE' },
    { id: 'browser', name: 'Web Browser', icon: 'üåê', x: 20, y: 260, action: 'openBrowser' },
    { id: 'claude', name: 'Claude Wizard', icon: 'ü§ñ', x: 20, y: 340, action: 'openClaudeWizard' },
    { id: 'gemini', name: 'Gemini Wizard', icon: 'üíé', x: 20, y: 420, action: 'openGeminiWizard' },
    { id: 'gpt', name: 'GPT Wizard', icon: 'üß†', x: 100, y: 20, action: 'openGPTWizard' },
    { id: 'chat', name: 'ALGO Chat', icon: 'üí¨', x: 100, y: 100, action: 'openChat' },
    { id: 'webcam', name: 'ALGO Webcam', icon: 'üìπ', x: 100, y: 180, action: 'openWebcam' },
    { id: 'photobooth', name: 'Photobooth', icon: 'üì∏', x: 100, y: 260, action: 'openPhotobooth' },
    { id: 'tickets', name: 'Ticket Manager', icon: 'üé´', x: 100, y: 340, action: 'openTicketManager' },
    { id: 'music', name: 'Music Player', icon: 'üéµ', x: 100, y: 420, action: 'openMusicPlayer' },
    { id: 'video', name: 'Video Player', icon: 'üì∫', x: 180, y: 20, action: 'openVideoPlayer' },
  ];

  defaultIcons.forEach(ic => createDesktopIcon(ic));

  // Saved files - only show files NOT in a room folder on desktop
  const desktopFiles = savedFiles.filter(f => !f.room);
  desktopFiles.forEach((f, i) => {
    const fileIdx = savedFiles.indexOf(f);
    let icon = 'üìÑ';
    if (f.name.endsWith('.js')) icon = 'üìú';
    else if (f.type === 'image' || f.name.endsWith('.png') || f.name.endsWith('.jpg')) icon = 'üñºÔ∏è';
    createDesktopIcon({
      id: 'file-' + fileIdx,
      name: f.name,
      icon: icon,
      imageData: f.type === 'image' ? f.content : null,
      x: 180 + (i % 4) * 80,
      y: 20 + Math.floor(i / 4) * 80,
      action: f.type === 'image' ? 'viewImage' : 'openFile',
      data: f
    });
  });

  // Installed programs
  installedPrograms.forEach((p, i) => {
    createDesktopIcon({
      id: 'prog-' + p.id,
      name: p.name,
      icon: p.icon || 'üéÆ',
      x: 180 + ((desktopFiles.length + i) % 4) * 80,
      y: 20 + Math.floor((desktopFiles.length + i) / 4) * 80,
      action: 'runProgram',
      data: p
    });
  });

  // Room folders
  roomFolders.forEach((r, i) => {
    const offset = desktopFiles.length + installedPrograms.length;
    createDesktopIcon({
      id: 'room-' + r.name,
      name: r.name,
      icon: 'üìÇ',
      x: 180 + ((offset + i) % 4) * 80,
      y: 20 + Math.floor((offset + i) / 4) * 80,
      action: 'openRoomFolder',
      data: r
    });
  });
}

function createDesktopIcon(ic) {
  const el = document.createElement('div');
  el.className = 'desktop-icon';
  el.id = 'icon-' + ic.id;
  // Use saved position if available, otherwise use default
  const savedPos = iconPositions[ic.id];
  el.style.left = (savedPos ? savedPos.x : ic.x) + 'px';
  el.style.top = (savedPos ? savedPos.y : ic.y) + 'px';
  // Show image thumbnail for image files
  if (ic.imageData) {
    el.innerHTML = '<div class="icon-img icon-thumbnail"><img src="' + ic.imageData + '" alt=""></div><span>' + ic.name + '</span>';
  } else {
    el.innerHTML = '<div class="icon-img">' + ic.icon + '</div><span>' + ic.name + '</span>';
  }
  el.ondblclick = () => {
    if (ic.action === 'openFile') openSavedFile(ic.data);
    else if (ic.action === 'viewImage') viewImage(ic.data);
    else if (ic.action === 'runProgram') runProgram(ic.data);
    else if (ic.action === 'openRoomFolder') openRoomFolder(ic.data);
    else if (window[ic.action]) window[ic.action]();
  };
  // Mousedown for dragging - only start drag on icon-img or icon area, not on double-click
  el.onmousedown = (e) => {
    // Select icon on click
    document.querySelectorAll('.desktop-icon').forEach(i => i.classList.remove('selected'));
    el.classList.add('selected');
  };
  el.dataset.iconId = ic.id;
  el.dataset.iconType = ic.action;
  el.dataset.defaultX = ic.x;
  el.dataset.defaultY = ic.y;
  if (ic.data) el.dataset.fileData = JSON.stringify(ic.data);
  document.getElementById('desktop').appendChild(el);
}

// ==================== WINDOWS ====================
function createWindow(opts) {
  const id = winId++;
  const stateKey = opts.stateKey || opts.title || 'Window';
  const saved = windowStates[stateKey] || {};
  const win = {
    id, title: opts.title || 'Window', icon: opts.icon || 'üìÑ',
    stateKey: stateKey,
    x: saved.x ?? opts.x ?? 150 + (id % 5) * 30,
    y: saved.y ?? opts.y ?? 80 + (id % 5) * 30,
    width: saved.width ?? opts.width ?? 500,
    height: saved.height ?? opts.height ?? 400,
    minimized: false, content: opts.content || '',
    menubar: opts.menubar || '', onClose: opts.onClose
  };
  windows.push(win);
  renderWindow(win);
  focusWindow(id);
  updateTaskbar();
  return id;
}

function renderWindow(win) {
  const el = document.createElement('div');
  el.className = 'window';
  el.id = 'win-' + win.id;
  el.style.cssText = 'left:' + win.x + 'px;top:' + win.y + 'px;width:' + win.width + 'px;height:' + win.height + 'px;z-index:' + (100+win.id);
  el.innerHTML =
    '<div class="window-titlebar" data-winid="' + win.id + '">' +
      '<div class="title">' + win.icon + ' ' + win.title + '</div>' +
      '<div class="window-btn" onclick="minimizeWindow(' + win.id + ')">_</div>' +
      '<div class="window-btn" onclick="maximizeWindow(' + win.id + ')">‚ñ°</div>' +
      '<div class="window-btn" onclick="closeWindow(' + win.id + ')">√ó</div>' +
    '</div>' +
    win.menubar +
    '<div class="window-content">' + win.content + '</div>';
  el.onmousedown = () => focusWindow(win.id);
  document.getElementById('desktop').appendChild(el);
}

function getWindowById(id) {
  return document.getElementById('win-' + id);
}

function focusWindow(id) {
  windows.forEach(w => {
    const el = document.getElementById('win-' + w.id);
    if (el) {
      el.classList.toggle('inactive', w.id !== id);
      el.style.zIndex = w.id === id ? 9000 : 100 + w.id;
    }
  });
  activeWin = id;
  updateTaskbar();
}

function minimizeWindow(id) {
  const el = document.getElementById('win-' + id);
  if (el) el.classList.add('minimized');
  const w = windows.find(x => x.id === id);
  if (w) w.minimized = true;
  updateTaskbar();
}

function restoreWindow(id) {
  const el = document.getElementById('win-' + id);
  if (el) el.classList.remove('minimized');
  const w = windows.find(x => x.id === id);
  if (w) w.minimized = false;
  focusWindow(id);
}

function maximizeWindow(id) {
  const el = document.getElementById('win-' + id);
  const w = windows.find(x => x.id === id);
  if (!el || !w) return;
  if (w.maximized) {
    el.style.cssText = 'left:' + w.restoreX + 'px;top:' + w.restoreY + 'px;width:' + w.restoreW + 'px;height:' + w.restoreH + 'px;z-index:9000';
    w.maximized = false;
  } else {
    w.restoreX = w.x; w.restoreY = w.y; w.restoreW = w.width; w.restoreH = w.height;
    el.style.cssText = 'left:0;top:0;width:100%;height:calc(100vh - 28px);z-index:9000';
    w.maximized = true;
  }
}

function closeWindow(id) {
  const idx = windows.findIndex(w => w.id === id);
  if (idx > -1) {
    if (windows[idx].onClose) windows[idx].onClose();
    windows.splice(idx, 1);
    const el = document.getElementById('win-' + id);
    if (el) el.remove();
    updateTaskbar();
  }
}

function updateTaskbar() {
  document.getElementById('taskbar-windows').innerHTML = windows.map(w =>
    '<div class="taskbar-item' + (w.id===activeWin?' active':'') + '" onclick="' + (w.minimized?'restoreWindow':'focusWindow') + '(' + w.id + ')">' + w.icon + ' ' + w.title + '</div>'
  ).join('');
}

// ==================== NOTEPAD ====================
function openNotepad(content, filename, room, existingFile) {
  content = content || '';
  filename = filename || '';
  room = room || null;
  existingFile = existingFile || null;
  const id = winId;
  const roomLabel = room ? ' [#' + room + ']' : '';
  const isNew = !filename;
  createWindow({
    title: (filename || 'Untitled') + roomLabel + ' - Notepad',
    stateKey: 'Notepad',
    icon: 'üìù',
    width: 500, height: 400,
    menubar: '<div class="window-menubar">' +
      '<div class="menu-item" onclick="toggleMenu(\'notepad-menu-' + id + '\')">' +
        'File' +
        '<div class="dropdown-menu" id="notepad-menu-' + id + '">' +
          '<div class="dropdown-item" onclick="notepadNew(' + id + ')">New</div>' +
          '<div class="dropdown-item" onclick="notepadSaveAs(' + id + ')">Save As... (Ctrl+S)</div>' +
          '<div class="dropdown-item" onclick="notepadPost(' + id + ')">Post to Laserbarf</div>' +
        '</div>' +
      '</div>' +
    '</div>',
    content: '<div class="notepad-container">' +
      '<textarea class="notepad-textarea" id="notepad-text-' + id + '" data-filename="' + filename + '" data-room="' + (room||'') + '" data-saved="' + (isNew ? 'false' : 'true') + '" data-original="' + escapeHtml(content) + '">' + escapeHtml(content) + '</textarea>' +
    '</div>'
  });

  // Set up change tracking and Ctrl+S
  setTimeout(() => {
    const textarea = document.getElementById('notepad-text-' + id);
    if (textarea) {
      if (existingFile) textarea._editingFile = existingFile;
      textarea.addEventListener('input', () => notepadMarkUnsaved(id));
      textarea.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
          e.preventDefault();
          notepadSaveAs(id);
        }
      });
    }
  }, 50);
}

function notepadMarkUnsaved(id) {
  const textarea = document.getElementById('notepad-text-' + id);
  if (!textarea) return;
  const titleEl = document.querySelector('#win-' + id + ' .title');
  if (titleEl && !titleEl.textContent.startsWith('üìù *')) {
    titleEl.textContent = titleEl.textContent.replace('üìù ', 'üìù *');
  }
}

function toggleMenu(menuId) {
  event.stopPropagation();
  const menu = document.getElementById(menuId);
  document.querySelectorAll('.dropdown-menu').forEach(m => {
    if (m.id !== menuId) m.classList.remove('visible');
  });
  if (menu) menu.classList.toggle('visible');
}

function notepadNew(id) {
  document.getElementById('notepad-text-' + id).value = '';
  document.querySelector('#win-' + id + ' .title').innerHTML = 'üìù Untitled - Notepad';
  hideMenus();
}

function notepadSaveAs(id) {
  const textarea = document.getElementById('notepad-text-' + id);
  const text = textarea.value.trim();
  if (!text) { alert('Nothing to save!'); return; }

  const room = textarea.dataset.room || null;
  const existingFilename = textarea.dataset.filename || '';
  const firstWord = text.split(/\s+/)[0].replace(/[^a-zA-Z0-9]/g, '').substring(0, 20) || 'untitled';
  const suggestedName = existingFilename || (firstWord + '.txt');

  hideMenus();

  // Show Save As dialog
  const filename = prompt('Save as:', suggestedName);
  if (!filename) return;

  // Ensure .txt extension
  let finalName = filename.trim();
  if (!finalName.endsWith('.txt')) finalName += '.txt';

  // Check for collision
  let counter = 1;
  let uniqueName = finalName;
  const baseName = finalName.replace(/\.txt$/, '');
  while (savedFiles.some(f => f.name === uniqueName && f.room === room && f !== textarea._editingFile)) {
    counter++;
    uniqueName = baseName + '(' + counter + ').txt';
  }

  // If editing existing file, update it; otherwise add new
  if (textarea._editingFile) {
    textarea._editingFile.name = uniqueName;
    textarea._editingFile.content = text;
  } else {
    savedFiles.push({ name: uniqueName, content: text, room: room });
  }

  saveState();
  createDesktopIcons();
  if (room) refreshRoomFolder(room);

  textarea.dataset.filename = uniqueName;
  textarea.dataset.saved = 'true';
  textarea._editingFile = savedFiles.find(f => f.name === uniqueName && f.room === room);
  const roomLabel = room ? ' [#' + room + ']' : '';
  document.querySelector('#win-' + id + ' .title').innerHTML = 'üìù ' + uniqueName + roomLabel + ' - Notepad';

  algoSpeak('Saved ' + uniqueName + '!');
}

function notepadPost(id) {
  const textarea = document.getElementById('notepad-text-' + id);
  const text = textarea.value.trim();
  if (!text) { alert('Nothing to post!'); return; }

  const room = textarea.dataset.room || 'algo-world';
  postToLaserbarf(text, room);
  hideMenus();
  algoSpeak('Posted to #' + room + '!');
}

function openSavedFile(file) {
  if (file.name.endsWith('.js')) {
    openJSIDE(file.content, file.name);
  } else if (file.type === 'image') {
    viewImage(file);
  } else {
    openNotepad(file.content, file.name, file.room, file);
  }
}

function viewImage(file) {
  createWindow({
    title: file.name,
    stateKey: 'Image:' + file.name,
    icon: 'üñºÔ∏è',
    width: 500, height: 400,
    content: '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#222;overflow:auto;">' +
      '<img src="' + file.content + '" style="max-width:100%;max-height:100%;object-fit:contain;">' +
    '</div>'
  });
}

// ==================== ROOM FOLDERS ====================
function openRoomFolder(room) {
  const id = winId;
  createWindow({
    title: room.name,
    stateKey: 'Room:' + room.name,
    icon: 'üìÇ',
    width: 400, height: 300,
    content: '<div class="folder-content" id="folder-content-' + room.name + '">' + generateFolderContent(room.name) + '</div>'
  });
}

function generateFolderContent(roomName) {
  const roomFiles = savedFiles.filter(f => f.room === roomName);
  return (roomFiles.length === 0 ? '<div style="color:#666;padding:10px;">Empty folder</div>' : '') +
    roomFiles.map((f, i) =>
      '<div class="folder-item" ondblclick="openSavedFile(savedFiles[' + savedFiles.indexOf(f) + '])">' +
        '<div class="icon-img">' + (f.name.endsWith('.js') ? 'üìú' : 'üìÑ') + '</div>' +
        '<span>' + f.name + '</span>' +
      '</div>'
    ).join('') +
    '<div class="folder-item" ondblclick="openNotepadInRoom(\'' + roomName + '\')" style="opacity:0.6;">' +
      '<div class="icon-img">üìù</div>' +
      '<span>New File...</span>' +
    '</div>';
}

function refreshRoomFolder(roomName) {
  const container = document.getElementById('folder-content-' + roomName);
  if (container) {
    container.innerHTML = generateFolderContent(roomName);
  }
}

function openNotepadInRoom(roomName) {
  openNotepad('', '', roomName);
}

function createRoomFolder() {
  const name = prompt('Enter room name:');
  if (!name) return;
  const cleanName = name.replace(/[^a-zA-Z0-9-]/g, '').toLowerCase();
  if (!cleanName || roomFolders.some(r => r.name === cleanName)) return;
  roomFolders.push({ name: cleanName });
  saveState();
  createDesktopIcons();
  hideContextMenu();
}

// ==================== JAVASCRIPT IDE ====================
// ALGO API library for IDE scripts
const ALGO_API_CODE = `
// ALGO OS App API
window.ALGO = {
  // App metadata
  app: { name: 'My App', icon: 'üì±', version: '1.0' },

  // File type handlers
  handlers: {},

  // Register as handler for file extension
  registerFileType: function(ext, handler) {
    this.handlers[ext] = handler;
    if (window.registerFileHandler) {
      window.registerFileHandler(ext, this.app.name, this.app.icon, handler);
    }
  },

  // Create a window with UI
  createWindow: function(options) {
    const opts = Object.assign({ title: this.app.name, icon: this.app.icon, width: 400, height: 300 }, options);
    if (window.createWindow) {
      return window.createWindow(opts);
    }
    return null;
  },

  // Create UI elements
  ui: {
    button: function(label, onclick) {
      return '<button onclick="(' + onclick.toString() + ')()" style="padding:4px 12px;margin:2px;">' + label + '</button>';
    },
    input: function(id, placeholder) {
      return '<input id="' + id + '" placeholder="' + (placeholder||'') + '" style="padding:4px;margin:2px;width:200px;">';
    },
    label: function(text) {
      return '<label style="display:block;margin:4px;">' + text + '</label>';
    },
    select: function(id, options) {
      return '<select id="' + id + '" style="padding:4px;margin:2px;">' +
        options.map(o => '<option value="' + o.value + '">' + o.label + '</option>').join('') + '</select>';
    },
    panel: function(content) {
      return '<div style="padding:10px;background:#f0f0f0;border:1px solid #ccc;margin:4px;">' + content + '</div>';
    }
  },

  // Save file to server
  saveFile: function(name, content, type) {
    // Save to server
    fetch(API_BASE + '/files/save', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + sessionToken
      },
      body: JSON.stringify({ path: name, content: content, type: type || 'text' })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        // Also keep in local array for desktop icons
        if (window.savedFiles) {
          const existing = window.savedFiles.findIndex(f => f.name === name);
          if (existing >= 0) {
            window.savedFiles[existing] = { name, content, type: type || 'text' };
          } else {
            window.savedFiles.push({ name, content, type: type || 'text' });
          }
          if (window.createDesktopIcons) window.createDesktopIcons();
        }
        console.log('File saved:', data.path);
      } else {
        console.error('Save failed:', data.error);
      }
    })
    .catch(e => console.error('Save error:', e));
    return true;
  },

  // Show notification
  notify: function(message) {
    if (window.algoSpeak) window.algoSpeak(message);
    else alert(message);
  },

  // Get element value
  getValue: function(id) {
    const el = document.getElementById(id);
    return el ? el.value : null;
  },

  // Set element content
  setContent: function(id, html) {
    const el = document.getElementById(id);
    if (el) el.innerHTML = html;
  }
};
`;

const IDE_EXAMPLES = {
  'hello': {
    name: 'Hello World',
    code: `// Hello World App
ALGO.app.name = 'Hello App';
ALGO.app.icon = 'üëã';

// Create a simple window
ALGO.createWindow({
  title: 'Hello World',
  width: 300,
  height: 150,
  content: ALGO.ui.panel(
    '<h2>Hello, ALGO OS!</h2>' +
    '<p>Welcome to JavaScript.IDE</p>' +
    ALGO.ui.button('Say Hi', function() {
      ALGO.notify('Hello from my app!');
    })
  )
});

console.log('Hello World app created!');`
  },
  'counter': {
    name: 'Counter App',
    code: `// Counter App
ALGO.app.name = 'Counter';
ALGO.app.icon = 'üî¢';

window.counterVal = 0;

window.counterUpdate = function() {
  ALGO.setContent('counter-display', '<h1 style="text-align:center;font-size:48px;">' + window.counterVal + '</h1>');
};

ALGO.createWindow({
  title: 'Counter',
  width: 250,
  height: 200,
  content: '<div style="padding:20px;text-align:center;">' +
    '<div id="counter-display"><h1 style="font-size:48px;">0</h1></div>' +
    '<div>' +
      '<button onclick="window.counterVal--;window.counterUpdate();" style="padding:10px 20px;font-size:20px;">-</button>' +
      ' ' +
      '<button onclick="window.counterVal++;window.counterUpdate();" style="padding:10px 20px;font-size:20px;">+</button>' +
    '</div>' +
  '</div>'
});

console.log('Counter app ready!');`
  },
  'notepad': {
    name: 'Mini Notepad',
    code: `// Mini Notepad
ALGO.app.name = 'Mini Notepad';
ALGO.app.icon = 'üìù';

window.saveNote = function() {
  const text = ALGO.getValue('notepad-text');
  if (text) {
    ALGO.saveFile('note-' + Date.now() + '.txt', text, 'text');
    ALGO.notify('Note saved!');
  }
};

window.clearNote = function() {
  document.getElementById('notepad-text').value = '';
};

ALGO.createWindow({
  title: 'Mini Notepad',
  width: 400,
  height: 300,
  content: '<div style="display:flex;flex-direction:column;height:100%;">' +
    '<div style="padding:4px;background:#c0c0c0;">' +
      '<button onclick="window.saveNote()">Save</button>' +
      '<button onclick="window.clearNote()">Clear</button>' +
    '</div>' +
    '<textarea id="notepad-text" style="flex:1;padding:8px;border:none;resize:none;font-family:monospace;"></textarea>' +
  '</div>'
});

console.log('Mini Notepad ready!');`
  },
  'calculator': {
    name: 'Calculator',
    code: `// Simple Calculator
ALGO.app.name = 'Calculator';
ALGO.app.icon = 'üßÆ';

window.calcDisplay = '0';
window.calcLastOp = null;
window.calcLastNum = 0;

window.updateCalc = function() {
  document.getElementById('calc-display').value = window.calcDisplay;
};

window.calcDigit = function(d) {
  if (window.calcDisplay === '0') window.calcDisplay = d;
  else window.calcDisplay += d;
  window.updateCalc();
};

window.calcOp = function(op) {
  window.calcLastNum = parseFloat(window.calcDisplay);
  window.calcLastOp = op;
  window.calcDisplay = '0';
};

window.calcEquals = function() {
  const curr = parseFloat(window.calcDisplay);
  if (window.calcLastOp === '+') window.calcDisplay = String(window.calcLastNum + curr);
  else if (window.calcLastOp === '-') window.calcDisplay = String(window.calcLastNum - curr);
  else if (window.calcLastOp === '*') window.calcDisplay = String(window.calcLastNum * curr);
  else if (window.calcLastOp === '/') window.calcDisplay = String(window.calcLastNum / curr);
  window.calcLastOp = null;
  window.updateCalc();
};

window.calcClear = function() {
  window.calcDisplay = '0';
  window.calcLastOp = null;
  window.calcLastNum = 0;
  window.updateCalc();
};

const btnStyle = 'width:40px;height:35px;margin:2px;font-size:16px;';
ALGO.createWindow({
  title: 'Calculator',
  width: 220,
  height: 280,
  content: '<div style="padding:10px;">' +
    '<input id="calc-display" value="0" readonly style="width:100%;padding:8px;font-size:18px;text-align:right;margin-bottom:8px;">' +
    '<div>' +
      '<button onclick="window.calcDigit(\\'7\\')" style="' + btnStyle + '">7</button>' +
      '<button onclick="window.calcDigit(\\'8\\')" style="' + btnStyle + '">8</button>' +
      '<button onclick="window.calcDigit(\\'9\\')" style="' + btnStyle + '">9</button>' +
      '<button onclick="window.calcOp(\\'/\\')" style="' + btnStyle + '">/</button>' +
    '</div><div>' +
      '<button onclick="window.calcDigit(\\'4\\')" style="' + btnStyle + '">4</button>' +
      '<button onclick="window.calcDigit(\\'5\\')" style="' + btnStyle + '">5</button>' +
      '<button onclick="window.calcDigit(\\'6\\')" style="' + btnStyle + '">6</button>' +
      '<button onclick="window.calcOp(\\'*\\')" style="' + btnStyle + '">*</button>' +
    '</div><div>' +
      '<button onclick="window.calcDigit(\\'1\\')" style="' + btnStyle + '">1</button>' +
      '<button onclick="window.calcDigit(\\'2\\')" style="' + btnStyle + '">2</button>' +
      '<button onclick="window.calcDigit(\\'3\\')" style="' + btnStyle + '">3</button>' +
      '<button onclick="window.calcOp(\\'-\\')" style="' + btnStyle + '">-</button>' +
    '</div><div>' +
      '<button onclick="window.calcClear()" style="' + btnStyle + '">C</button>' +
      '<button onclick="window.calcDigit(\\'0\\')" style="' + btnStyle + '">0</button>' +
      '<button onclick="window.calcEquals()" style="' + btnStyle + '">=</button>' +
      '<button onclick="window.calcOp(\\'+\\')" style="' + btnStyle + '">+</button>' +
    '</div>' +
  '</div>'
});

console.log('Calculator ready!');`
  },
  'filehandler': {
    name: 'File Handler Demo',
    code: `// File Handler Demo - registers for .demo files
ALGO.app.name = 'Demo Viewer';
ALGO.app.icon = 'üìã';

// Register to handle .demo files
ALGO.registerFileType('demo', function(content, filename) {
  ALGO.createWindow({
    title: 'Viewing: ' + filename,
    width: 400,
    height: 300,
    content: '<div style="padding:15px;">' +
      '<h3>Demo File Contents:</h3>' +
      '<pre style="background:#f0f0f0;padding:10px;overflow:auto;">' + content + '</pre>' +
    '</div>'
  });
});

// Create a sample .demo file
ALGO.saveFile('sample.demo', 'This is a demo file!\\nIt was created by JavaScript.IDE.\\nDouble-click to open with Demo Viewer.', 'text');

ALGO.notify('Demo Viewer registered for .demo files!');
console.log('File handler registered. Created sample.demo on desktop.');`
  }
};

function openJSIDE(content, filename) {
  content = content || '';
  filename = filename || '';
  const id = winId;

  const defaultCode = `// ALGO OS App - JavaScript.IDE
// Use the ALGO API to create apps!

ALGO.app.name = 'My App';
ALGO.app.icon = 'üöÄ';

// Create a window
ALGO.createWindow({
  title: 'My First App',
  width: 300,
  height: 200,
  content: '<div style="padding:20px;text-align:center;">' +
    '<h2>Welcome!</h2>' +
    '<p>Edit this code to build your app.</p>' +
    '<button onclick="ALGO.notify(\\'Hello!\\')">Click Me</button>' +
  '</div>'
});

console.log('App started!');`;

  const exampleOptions = Object.entries(IDE_EXAMPLES).map(([k, v]) =>
    '<option value="' + k + '">' + v.name + '</option>'
  ).join('');

  createWindow({
    title: filename || 'Untitled - JavaScript.IDE',
    stateKey: 'JavaScript.IDE',
    icon: 'üìú',
    width: 850, height: 500,
    menubar: '<div class="window-menubar">' +
      '<div class="menu-item" onclick="toggleMenu(\'ide-menu-' + id + '\')">' +
        'File' +
        '<div class="dropdown-menu" id="ide-menu-' + id + '">' +
          '<div class="dropdown-item" onclick="ideNew(' + id + ')">New</div>' +
          '<div class="dropdown-item" onclick="ideSave(' + id + ')">Save to Desktop</div>' +
          '<div class="dropdown-item" onclick="ideInstall(' + id + ')">Install as Program</div>' +
        '</div>' +
      '</div>' +
      '<div class="menu-item" onclick="toggleMenu(\'ide-help-' + id + '\')">' +
        'Help' +
        '<div class="dropdown-menu" id="ide-help-' + id + '">' +
          '<div class="dropdown-item" onclick="ideShowAPI(' + id + ')">API Reference</div>' +
        '</div>' +
      '</div>' +
    '</div>',
    content: '<div class="ide-container">' +
      '<div class="ide-main">' +
        '<div class="ide-editor">' +
          '<div class="ide-toolbar">' +
            '<button onclick="ideRun(' + id + ')">‚ñ∂ Run</button>' +
            '<button onclick="ideStop(' + id + ')">‚¨õ Stop</button>' +
            '<select onchange="ideLoadExample(' + id + ', this.value)">' +
              '<option value="">-- Examples --</option>' +
              exampleOptions +
            '</select>' +
          '</div>' +
          '<textarea id="ide-code-' + id + '" spellcheck="false">' + escapeHtml(content || defaultCode) + '</textarea>' +
        '</div>' +
        '<div class="ide-preview">' +
          '<div class="ide-preview-header">' +
            '<span>Preview</span>' +
            '<button onclick="ideRefresh(' + id + ')" style="padding:1px 6px;font-size:10px;">‚Üª Refresh</button>' +
          '</div>' +
          '<div class="ide-preview-content" id="ide-preview-' + id + '">' +
            '<div style="padding:20px;color:#888;text-align:center;">Click Run to see your app</div>' +
          '</div>' +
        '</div>' +
      '</div>' +
      '<div class="ide-console" id="ide-console-' + id + '">' +
        '<div class="ide-console-header" onclick="ideToggleConsole(' + id + ')">' +
          '<span>Console</span>' +
          '<span id="ide-console-toggle-' + id + '">‚ñº</span>' +
        '</div>' +
        '<div class="ide-console-content" id="ide-console-content-' + id + '"></div>' +
      '</div>' +
    '</div>'
  });
}

function ideRun(id) {
  const code = document.getElementById('ide-code-' + id).value;
  const consoleEl = document.getElementById('ide-console-content-' + id);
  consoleEl.innerHTML = '';

  // Custom console that logs to our console pane
  const ideConsole = {
    log: function() {
      const args = Array.prototype.slice.call(arguments);
      const text = args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a)).join(' ');
      consoleEl.innerHTML += '<div>' + escapeHtml(text) + '</div>';
      consoleEl.scrollTop = consoleEl.scrollHeight;
    },
    error: function() {
      const args = Array.prototype.slice.call(arguments);
      const text = args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a)).join(' ');
      consoleEl.innerHTML += '<div class="error">Error: ' + escapeHtml(text) + '</div>';
      consoleEl.scrollTop = consoleEl.scrollHeight;
    },
    warn: function() {
      const args = Array.prototype.slice.call(arguments);
      const text = args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a)).join(' ');
      consoleEl.innerHTML += '<div class="warn">Warning: ' + escapeHtml(text) + '</div>';
      consoleEl.scrollTop = consoleEl.scrollHeight;
    },
    info: function() {
      const args = Array.prototype.slice.call(arguments);
      const text = args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a)).join(' ');
      consoleEl.innerHTML += '<div class="info">' + escapeHtml(text) + '</div>';
      consoleEl.scrollTop = consoleEl.scrollHeight;
    }
  };

  try {
    // Combine ALGO API with user code
    const fullCode = ALGO_API_CODE + '\n' + code;
    // Store original console and replace with IDE console
    const origConsole = window.console;
    window.console = ideConsole;
    // Execute in global scope using indirect eval
    (0, eval)(fullCode);
    // Restore original console
    window.console = origConsole;
    ideConsole.info('‚úì App executed successfully');
  } catch (e) {
    ideConsole.error(e.message);
    if (e.stack) {
      const stackLines = e.stack.split('\n').slice(1, 3).join('\n');
      consoleEl.innerHTML += '<div class="error" style="font-size:10px;opacity:0.7;">' + escapeHtml(stackLines) + '</div>';
    }
  }
}

function ideStop(id) {
  const consoleEl = document.getElementById('ide-console-content-' + id);
  consoleEl.innerHTML += '<div class="warn">Execution stopped</div>';
}

function ideToggleConsole(id) {
  const consoleEl = document.getElementById('ide-console-' + id);
  const toggleEl = document.getElementById('ide-console-toggle-' + id);
  consoleEl.classList.toggle('collapsed');
  toggleEl.textContent = consoleEl.classList.contains('collapsed') ? '‚ñ≤' : '‚ñº';
}

function ideLoadExample(id, exampleKey) {
  if (!exampleKey || !IDE_EXAMPLES[exampleKey]) return;
  document.getElementById('ide-code-' + id).value = IDE_EXAMPLES[exampleKey].code;
  const consoleEl = document.getElementById('ide-console-content-' + id);
  consoleEl.innerHTML = '<div class="info">Loaded example: ' + IDE_EXAMPLES[exampleKey].name + '</div>';
}

function ideRefresh(id) {
  ideRun(id);
}

function ideShowAPI(id) {
  hideMenus();
  createWindow({
    title: 'ALGO API Reference',
    icon: 'üìñ',
    width: 450, height: 400,
    content: '<div style="padding:15px;overflow:auto;height:100%;font-size:11px;">' +
      '<h2>ALGO OS App API</h2>' +
      '<h3>App Metadata</h3>' +
      '<pre>ALGO.app.name = "My App";\nALGO.app.icon = "üì±";</pre>' +
      '<h3>Create Window</h3>' +
      '<pre>ALGO.createWindow({\n  title: "Window Title",\n  width: 400, height: 300,\n  content: "&lt;div&gt;HTML content&lt;/div&gt;"\n});</pre>' +
      '<h3>UI Helpers</h3>' +
      '<pre>ALGO.ui.button(label, onclick)\nALGO.ui.input(id, placeholder)\nALGO.ui.label(text)\nALGO.ui.select(id, [{value, label}])\nALGO.ui.panel(content)</pre>' +
      '<h3>File Operations</h3>' +
      '<pre>ALGO.saveFile(name, content, type)\nALGO.registerFileType(ext, handler)</pre>' +
      '<h3>Utilities</h3>' +
      '<pre>ALGO.notify(message)\nALGO.getValue(elementId)\nALGO.setContent(elementId, html)</pre>' +
    '</div>'
  });
}

function ideNew(id) {
  const defaultCode = `// ALGO OS App - JavaScript.IDE
ALGO.app.name = 'My App';
ALGO.app.icon = 'üöÄ';

ALGO.createWindow({
  title: 'My App',
  width: 300,
  height: 200,
  content: '<div style="padding:20px;text-align:center;">' +
    '<h2>Hello!</h2>' +
  '</div>'
});`;
  document.getElementById('ide-code-' + id).value = defaultCode;
  document.querySelector('#win-' + id + ' .title').innerHTML = 'üìú Untitled - JavaScript.IDE';
  document.getElementById('ide-console-content-' + id).innerHTML = '';
  hideMenus();
}

function ideSave(id) {
  const code = document.getElementById('ide-code-' + id).value.trim();
  if (!code) return;
  const m = code.match(/ALGO\.app\.name\s*=\s*['"]([^'"]+)['"]/);
  const appName = m ? m[1] : 'script';
  let filename = appName.replace(/\s+/g, '-').toLowerCase() + '.js';
  let counter = 1;
  while (savedFiles.some(f => f.name === filename)) {
    counter++;
    filename = appName.replace(/\s+/g, '-').toLowerCase() + '(' + counter + ').js';
  }
  savedFiles.push({ name: filename, content: code, room: null });
  saveState();
  createDesktopIcons();
  hideMenus();
  algoSpeak('Saved ' + filename + '!');
}

function ideInstall(id) {
  const code = document.getElementById('ide-code-' + id).value.trim();
  if (!code) return;

  // Extract app metadata
  const nameMatch = code.match(/ALGO\.app\.name\s*=\s*['"]([^'"]+)['"]/);
  const iconMatch = code.match(/ALGO\.app\.icon\s*=\s*['"]([^'"]+)['"]/);
  const appName = nameMatch ? nameMatch[1] : 'My App';
  const appIcon = iconMatch ? iconMatch[1] : 'üì±';

  // Install as program
  const progId = 'ide-' + Date.now();
  installedPrograms.push({
    id: progId,
    name: appName,
    icon: appIcon,
    code: code
  });
  updateProgramsMenu();
  saveState();
  createDesktopIcons();
  hideMenus();
  algoSpeak('Installed ' + appName + '!');
}

// ==================== WEB BROWSER ====================
function openBrowser(url) {
  const id = winId;
  const startUrl = url || 'https://laserbarf.com';
  createWindow({
    title: 'Web Browser',
    stateKey: 'Web Browser',
    icon: 'üåê',
    width: 700, height: 500,
    content: '<div style="display:flex;flex-direction:column;height:100%;">' +
      '<div class="browser-toolbar">' +
        '<button onclick="browserBack(' + id + ')">‚Üê</button>' +
        '<button onclick="browserFwd(' + id + ')">‚Üí</button>' +
        '<input type="text" class="browser-url" id="browser-url-' + id + '" value="' + escapeHtml(startUrl) + '" onkeydown="if(event.key===\'Enter\')browserGo(' + id + ')">' +
        '<button onclick="browserGo(' + id + ')">Go</button>' +
      '</div>' +
      '<iframe class="browser-frame" id="browser-frame-' + id + '" src="' + startUrl + '"></iframe>' +
    '</div>'
  });
}

function browserGo(id) {
  let url = document.getElementById('browser-url-' + id).value;
  if (!url.startsWith('http')) url = 'https://' + url;
  document.getElementById('browser-frame-' + id).src = url;
}

function browserBack(id) {
  try { document.getElementById('browser-frame-' + id).contentWindow.history.back(); } catch(e) {}
}

function browserFwd(id) {
  try { document.getElementById('browser-frame-' + id).contentWindow.history.forward(); } catch(e) {}
}

// ==================== AI WIZARDS ====================
function openClaudeWizard() { openAIWizard('claude', 'ü§ñ', 'Claude Wizard', 'anthropic'); }
function openGeminiWizard() { openAIWizard('gemini', 'üíé', 'Gemini Wizard', 'google'); }
function openGPTWizard() { openAIWizard('gpt', 'üß†', 'GPT Wizard', 'openai'); }

function openAIWizard(provider, icon, title, providerKey) {
  const id = winId;
  const savedKey = apiKeys[provider] || '';
  createWindow({
    title: title,
    stateKey: title,
    icon: icon,
    width: 500, height: 450,
    content: '<div class="wizard-container">' +
      '<div class="wizard-header">' +
        '<div class="icon">' + icon + '</div>' +
        '<div><h2>' + title + '</h2><p>Create artifacts with AI</p></div>' +
      '</div>' +
      '<div class="wizard-form">' +
        '<label>API Key:</label>' +
        '<input type="password" id="wizard-key-' + id + '" value="' + savedKey + '" placeholder="Enter your ' + provider.toUpperCase() + ' API key">' +
        '<button onclick="saveApiKey(\'' + provider + '\',' + id + ')">Save Key</button>' +
        '<label style="margin-top:10px;">Describe your artifact:</label>' +
        '<textarea id="wizard-prompt-' + id + '" placeholder="e.g., A retro space invaders game with neon colors"></textarea>' +
        '<div class="wizard-buttons">' +
          '<button onclick="generateArtifact(\'' + providerKey + '\',' + id + ')">‚ú® Generate</button>' +
        '</div>' +
        '<div class="wizard-status" id="wizard-status-' + id + '">Ready to create!</div>' +
      '</div>' +
    '</div>'
  });
}

function saveApiKey(provider, id) {
  const key = document.getElementById('wizard-key-' + id).value.trim();
  if (key) {
    apiKeys[provider] = key;
    saveState();
    document.getElementById('wizard-status-' + id).textContent = 'API key saved!';
  }
}

function generateArtifact(provider, id) {
  const key = document.getElementById('wizard-key-' + id).value.trim();
  const prompt = document.getElementById('wizard-prompt-' + id).value.trim();
  const status = document.getElementById('wizard-status-' + id);

  if (!key) { status.textContent = 'Please enter an API key!'; return; }
  if (!prompt) { status.textContent = 'Please describe what to create!'; return; }

  status.textContent = 'Generating... please wait...';

  fetch('/api/ai-create', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ provider: provider, apiKey: key, prompt: prompt })
  })
  .then(r => r.json())
  .then(data => {
    if (data.error) {
      status.textContent = 'Error: ' + data.error;
      return;
    }
    if (data.html) {
      // Generate a name from prompt
      const words = prompt.split(/\s+/).slice(0, 2).join('-').toLowerCase().replace(/[^a-z0-9-]/g, '') || 'artifact';
      const name = words + '-' + Date.now().toString(36);

      // Post to algo-world with key
      const postContent = '#' + name + ':dolphin42\n' + data.html;

      fetch('/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'yo=489&text=' + encodeURIComponent(postContent) + '&save=POST'
      }).then(() => {
        // Add to installed programs
        installedPrograms.push({ id: name, name: name, url: '/' + name + ':dolphin42', icon: '‚ú®' });
        saveState();
        createDesktopIcons();
        updateProgramsMenu();
        status.textContent = 'Created! ' + name + ' is on your desktop.';
        algoSpeak('New app created: ' + name);
      });
    }
  })
  .catch(e => {
    status.textContent = 'Network error: ' + e.message;
  });
}

// ==================== P2P CHAT ====================
function openChat() {
  const id = winId;
  chatWinId = id;
  chatName = localStorage.getItem('algo-chat-name') || 'anon';
  createWindow({
    title: 'ALGO Chat (P2P)',
    stateKey: 'ALGO Chat',
    icon: 'üí¨',
    width: 500, height: 400,
    content: '<div class="chat-container">' +
      '<div style="padding:4px;background:#c0c0c0;border-bottom:1px solid #808080;display:flex;gap:4px;align-items:center;">' +
        '<label>Name:</label>' +
        '<input type="text" id="chat-name-' + id + '" value="' + escapeHtml(chatName) + '" style="width:80px;padding:2px;border:2px inset #808080;" onchange="updateChatName(' + id + ')">' +
        '<span style="margin-left:auto;font-size:10px;color:#666;" id="chat-status-' + id + '">Connecting...</span>' +
      '</div>' +
      '<div style="display:flex;flex:1;overflow:hidden;">' +
        '<div class="chat-messages" id="chat-messages-' + id + '"></div>' +
        '<div class="users-list" id="chat-users-' + id + '">' +
          '<h4>Online</h4>' +
          '<div id="online-users-' + id + '"></div>' +
        '</div>' +
      '</div>' +
      '<div class="chat-input-area">' +
        '<input type="text" id="chat-input-' + id + '" placeholder="Type a message..." onkeydown="if(event.key===\'Enter\')sendChatP2P(' + id + ')">' +
        '<button onclick="sendChatP2P(' + id + ')">Send</button>' +
      '</div>' +
    '</div>',
    onClose: () => { leaveChat(); }
  });

  joinChat();
}

function updateChatName(id) {
  chatName = document.getElementById('chat-name-' + id).value.trim() || 'anon';
  localStorage.setItem('algo-chat-name', chatName);
  // Broadcast name to all peers
  Object.values(chatPeers).forEach(peer => {
    if (peer.dataChannel && peer.dataChannel.readyState === 'open') {
      peer.dataChannel.send(JSON.stringify({ type: 'name', name: chatName }));
    }
  });
  updateChatUsers();
}

function joinChat() {
  fetch('/api/signal', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: 'join', room: chatRoom, peerId: chatPeerId })
  }).then(() => {
    if (chatWinId !== null) {
      const status = document.getElementById('chat-status-' + chatWinId);
      if (status) status.textContent = 'Connected';
    }
    chatPollInterval = setInterval(pollChatSignals, 1000);
    pollChatSignals();
  });
}

function leaveChat() {
  if (chatPollInterval) clearInterval(chatPollInterval);
  chatPollInterval = null;

  fetch('/api/signal', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: 'leave', room: chatRoom, peerId: chatPeerId })
  });

  Object.keys(chatPeers).forEach(pid => {
    if (chatPeers[pid].pc) chatPeers[pid].pc.close();
    if (chatPeers[pid].dataChannel) chatPeers[pid].dataChannel.close();
  });
  chatPeers = {};
  chatWinId = null;
}

async function pollChatSignals() {
  if (chatWinId === null) return;
  try {
    const res = await fetch('/api/signal?room=' + chatRoom + '&peerId=' + chatPeerId);
    const data = await res.json();

    // Connect to new peers
    data.peers.forEach(pid => {
      if (pid !== chatPeerId && !chatPeers[pid]) {
        initiateChatConnection(pid);
      }
    });

    // Handle signals
    data.signals.forEach(sig => {
      handleChatSignal(sig.from, sig.signal);
    });

    // Clean up disconnected peers
    Object.keys(chatPeers).forEach(pid => {
      if (!data.peers.includes(pid)) {
        removeChatPeer(pid);
      }
    });

    updateChatUsers();
  } catch (e) {}
}

function createChatPeerConnection(remotePeerId, isInitiator) {
  const pc = new RTCPeerConnection({
    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
  });

  chatPeers[remotePeerId] = { pc, dataChannel: null, connected: false, name: remotePeerId.substr(0, 8), iceCandidateQueue: [] };

  if (isInitiator) {
    const dc = pc.createDataChannel('chat');
    setupChatDataChannel(dc, remotePeerId);
    chatPeers[remotePeerId].dataChannel = dc;
  } else {
    pc.ondatachannel = (e) => {
      setupChatDataChannel(e.channel, remotePeerId);
      chatPeers[remotePeerId].dataChannel = e.channel;
    };
  }

  pc.onicecandidate = (e) => {
    if (e.candidate) {
      sendChatSignal(remotePeerId, { type: 'ice', candidate: e.candidate });
    }
  };

  pc.onconnectionstatechange = () => {
    if (pc.connectionState === 'connected') {
      chatPeers[remotePeerId].connected = true;
      addChatMessage('', remotePeerId.substr(0, 8) + ' joined', true);
      updateChatUsers();
    } else if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
      removeChatPeer(remotePeerId);
    }
  };

  return pc;
}

function setupChatDataChannel(dc, peerId) {
  dc.onopen = () => {
    dc.send(JSON.stringify({ type: 'name', name: chatName }));
  };
  dc.onmessage = (e) => {
    try {
      const data = JSON.parse(e.data);
      if (data.type === 'chat') {
        addChatMessage(data.name || peerId.substr(0, 8), data.text);
      } else if (data.type === 'name') {
        chatPeers[peerId].name = data.name;
        updateChatUsers();
      }
    } catch (e) {}
  };
}

function removeChatPeer(peerId) {
  const peer = chatPeers[peerId];
  if (peer) {
    if (peer.pc) peer.pc.close();
    delete chatPeers[peerId];
    addChatMessage('', (peer.name || peerId.substr(0, 8)) + ' left', true);
    updateChatUsers();
  }
}

async function sendChatSignal(to, signal) {
  await fetch('/api/signal', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: 'signal', room: chatRoom, peerId: chatPeerId, to, signal })
  });
}

async function handleChatSignal(from, signal) {
  if (signal.type === 'offer') {
    // Handle glare (both peers sent offers) using polite peer pattern
    // The peer with the higher ID is "impolite" and ignores incoming offers if they already sent one
    const existingPeer = chatPeers[from];
    if (existingPeer && existingPeer.pc) {
      const isPolite = chatPeerId < from; // Lower ID is polite
      const isStable = existingPeer.pc.signalingState === 'stable';
      const hasLocalOffer = existingPeer.pc.signalingState === 'have-local-offer';

      if (hasLocalOffer && !isPolite) {
        // Impolite peer ignores incoming offer if we already sent one
        console.log('Ignoring offer due to glare (impolite peer)');
        return;
      }
      // Polite peer or stable state - close existing and accept new offer
      existingPeer.pc.close();
      delete chatPeers[from];
    }

    const pc = createChatPeerConnection(from, false);
    await pc.setRemoteDescription(new RTCSessionDescription(signal.sdp));
    await processIceCandidateQueue(from);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    sendChatSignal(from, { type: 'answer', sdp: pc.localDescription });
  } else if (signal.type === 'answer') {
    const peer = chatPeers[from];
    if (peer && peer.pc && peer.pc.signalingState === 'have-local-offer') {
      await peer.pc.setRemoteDescription(new RTCSessionDescription(signal.sdp));
      await processIceCandidateQueue(from);
    }
  } else if (signal.type === 'ice') {
    const peer = chatPeers[from];
    if (peer && peer.pc) {
      if (peer.pc.remoteDescription) {
        try {
          await peer.pc.addIceCandidate(new RTCIceCandidate(signal.candidate));
        } catch (e) {
          // Ignore errors - may happen during renegotiation
        }
      } else {
        // Queue the candidate for later
        peer.iceCandidateQueue = peer.iceCandidateQueue || [];
        peer.iceCandidateQueue.push(signal.candidate);
      }
    }
  }
}

// Process queued ICE candidates after remote description is set
async function processIceCandidateQueue(peerId) {
  const peer = chatPeers[peerId];
  if (peer && peer.iceCandidateQueue && peer.pc && peer.pc.remoteDescription) {
    for (const candidate of peer.iceCandidateQueue) {
      try {
        await peer.pc.addIceCandidate(new RTCIceCandidate(candidate));
      } catch (e) {}
    }
    peer.iceCandidateQueue = [];
  }
}

async function initiateChatConnection(remotePeerId) {
  const pc = createChatPeerConnection(remotePeerId, true);
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  sendChatSignal(remotePeerId, { type: 'offer', sdp: pc.localDescription });
}

function addChatMessage(name, text, isSystem = false) {
  // Auto-open chat when receiving a message (but not system messages like join/leave)
  if (chatWinId === null) {
    if (!isSystem) {
      openChat();
    } else {
      return;
    }
  }
  const container = document.getElementById('chat-messages-' + chatWinId);
  if (!container) return;

  const div = document.createElement('div');
  div.className = 'chat-msg';
  const time = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
  if (isSystem) {
    div.innerHTML = '<span class="time">' + time + '</span> <span style="color:#888;">' + escapeHtml(text) + '</span>';
  } else {
    div.innerHTML = '<span class="name">' + escapeHtml(name) + '</span> <span class="time">' + time + '</span><div>' + escapeHtml(text) + '</div>';
  }
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function updateChatUsers() {
  if (chatWinId === null) return;
  const usersEl = document.getElementById('online-users-' + chatWinId);
  if (!usersEl) return;

  const users = [chatName + ' (you)'];
  Object.values(chatPeers).forEach(peer => {
    if (peer.connected) users.push(peer.name);
  });

  usersEl.innerHTML = users.map(u =>
    '<div class="user-item"><div class="user-dot"></div> ' + escapeHtml(u) + '</div>'
  ).join('');
}

function sendChatP2P(id) {
  const input = document.getElementById('chat-input-' + id);
  const text = input.value.trim();
  if (!text) return;

  addChatMessage(chatName, text);

  Object.values(chatPeers).forEach(peer => {
    if (peer.dataChannel && peer.dataChannel.readyState === 'open') {
      peer.dataChannel.send(JSON.stringify({ type: 'chat', name: chatName, text }));
    }
  });

  input.value = '';
}

// ==================== WEBCAM ====================
function openWebcam() {
  createWindow({
    title: 'ALGO Webcam',
    stateKey: 'ALGO Webcam',
    icon: 'üìπ',
    width: 700, height: 500,
    content: '<iframe src="/algo-webcam:dolphin42" style="width:100%;height:100%;border:none;"></iframe>'
  });
}

// ==================== PHOTOBOOTH ====================
let photoboothStream = null;

function openPhotobooth() {
  hideStartMenu();
  const id = winId;

  createWindow({
    title: 'Photobooth',
    stateKey: 'Photobooth',
    icon: 'üì∏',
    width: 500, height: 450,
    content: `
      <div class="photobooth-container" style="display:flex;flex-direction:column;height:100%;background:#1a1a2e;color:#fff;">
        <div style="flex:1;position:relative;overflow:hidden;background:#000;">
          <video id="photobooth-video-${id}" autoplay playsinline style="width:100%;height:100%;object-fit:cover;"></video>
          <canvas id="photobooth-canvas-${id}" style="display:none;"></canvas>
          <div id="photobooth-wordart-${id}" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;"></div>
          <img id="photobooth-preview-${id}" style="display:none;width:100%;height:100%;object-fit:cover;">
        </div>
        <div style="padding:8px;background:#c0c0c0;border-top:2px outset #fff;">
          <div style="display:flex;gap:4px;margin-bottom:6px;align-items:center;">
            <label style="color:#000;font-size:11px;">Word Art:</label>
            <input type="text" id="photobooth-text-${id}" placeholder="Add text..." style="flex:1;padding:2px 4px;border:2px inset #808080;">
            <select id="photobooth-style-${id}" style="padding:2px;border:2px inset #808080;">
              <option value="none">None</option>
              <option value="rainbow">üåà Rainbow</option>
              <option value="fire">üî• Fire</option>
              <option value="ice">‚ùÑÔ∏è Ice</option>
              <option value="gold">‚ú® Gold</option>
              <option value="neon">üíú Neon</option>
              <option value="comic">üí• Comic</option>
            </select>
          </div>
          <div style="display:flex;gap:4px;justify-content:center;">
            <button onclick="photoboothSnap(${id})" style="padding:4px 16px;background:#c0c0c0;border:2px outset #fff;">üì∏ Snap!</button>
            <button onclick="photoboothRetake(${id})" style="padding:4px 12px;background:#c0c0c0;border:2px outset #fff;">üîÑ Retake</button>
            <button onclick="photoboothSave(${id})" style="padding:4px 12px;background:#c0c0c0;border:2px outset #fff;">üíæ Save</button>
          </div>
        </div>
      </div>
    `,
    onClose: () => {
      if (photoboothStream) {
        photoboothStream.getTracks().forEach(t => t.stop());
        photoboothStream = null;
      }
    }
  });

  // Start camera
  setTimeout(() => {
    const video = document.getElementById('photobooth-video-' + id);
    const textInput = document.getElementById('photobooth-text-' + id);
    const styleSelect = document.getElementById('photobooth-style-' + id);

    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false })
      .then(stream => {
        photoboothStream = stream;
        video.srcObject = stream;
      })
      .catch(err => {
        video.parentElement.innerHTML = '<div style="padding:20px;text-align:center;color:#ff6b6b;">Camera access denied<br><small>' + err.message + '</small></div>';
      });

    // Update word art preview
    const updateWordArt = () => {
      const text = textInput.value;
      const style = styleSelect.value;
      const wordart = document.getElementById('photobooth-wordart-' + id);
      if (!text || style === 'none') {
        wordart.innerHTML = '';
        return;
      }
      wordart.innerHTML = '<div style="' + getWordArtStyle(style) + '">' + escapeHtml(text) + '</div>';
    };

    textInput.addEventListener('input', updateWordArt);
    styleSelect.addEventListener('change', updateWordArt);
  }, 100);
}

function getWordArtStyle(style) {
  const base = 'font-size:32px;font-weight:bold;text-align:center;white-space:nowrap;';
  switch (style) {
    case 'rainbow':
      return base + 'background:linear-gradient(90deg,red,orange,yellow,green,blue,violet);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:2px 2px 4px rgba(0,0,0,0.5);';
    case 'fire':
      return base + 'color:#ff4500;text-shadow:0 0 10px #ff0,0 0 20px #ff8c00,0 0 30px #ff4500,2px 2px 2px #000;';
    case 'ice':
      return base + 'color:#87ceeb;text-shadow:0 0 10px #fff,0 0 20px #87ceeb,0 0 30px #4169e1,2px 2px 2px #000;';
    case 'gold':
      return base + 'background:linear-gradient(180deg,#ffd700,#ffec8b,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:2px 2px 4px rgba(0,0,0,0.7);filter:drop-shadow(0 0 8px gold);';
    case 'neon':
      return base + 'color:#ff00ff;text-shadow:0 0 5px #ff00ff,0 0 10px #ff00ff,0 0 20px #ff00ff,0 0 40px #ff00ff;';
    case 'comic':
      return base + 'color:#ffff00;text-shadow:3px 3px 0 #000,-1px -1px 0 #000,1px -1px 0 #000,-1px 1px 0 #000;font-family:Impact,sans-serif;transform:skewX(-5deg);';
    default:
      return base + 'color:#fff;text-shadow:2px 2px 4px #000;';
  }
}

function photoboothSnap(id) {
  const video = document.getElementById('photobooth-video-' + id);
  const canvas = document.getElementById('photobooth-canvas-' + id);
  const preview = document.getElementById('photobooth-preview-' + id);
  const wordart = document.getElementById('photobooth-wordart-' + id);

  if (!video.srcObject) return;

  // Set canvas size to video size
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  const ctx = canvas.getContext('2d');

  // Draw video frame
  ctx.drawImage(video, 0, 0);

  // Draw word art if present
  const text = document.getElementById('photobooth-text-' + id).value;
  const style = document.getElementById('photobooth-style-' + id).value;
  if (text && style !== 'none') {
    ctx.save();
    ctx.font = 'bold 48px Impact, sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    const x = canvas.width / 2;
    const y = canvas.height / 2;

    // Apply style
    switch (style) {
      case 'rainbow':
        const gradient = ctx.createLinearGradient(x - 100, y, x + 100, y);
        gradient.addColorStop(0, 'red');
        gradient.addColorStop(0.17, 'orange');
        gradient.addColorStop(0.33, 'yellow');
        gradient.addColorStop(0.5, 'green');
        gradient.addColorStop(0.67, 'blue');
        gradient.addColorStop(1, 'violet');
        ctx.fillStyle = gradient;
        break;
      case 'fire':
        ctx.fillStyle = '#ff4500';
        ctx.shadowColor = '#ff8c00';
        ctx.shadowBlur = 20;
        break;
      case 'ice':
        ctx.fillStyle = '#87ceeb';
        ctx.shadowColor = '#4169e1';
        ctx.shadowBlur = 20;
        break;
      case 'gold':
        ctx.fillStyle = '#ffd700';
        ctx.shadowColor = 'gold';
        ctx.shadowBlur = 15;
        break;
      case 'neon':
        ctx.fillStyle = '#ff00ff';
        ctx.shadowColor = '#ff00ff';
        ctx.shadowBlur = 30;
        break;
      case 'comic':
        ctx.fillStyle = '#ffff00';
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 3;
        ctx.strokeText(text, x, y);
        break;
    }

    ctx.fillText(text, x, y);
    ctx.restore();
  }

  // Show preview
  preview.src = canvas.toDataURL('image/png');
  preview.style.display = 'block';
  video.style.display = 'none';
  wordart.style.display = 'none';
}

function photoboothRetake(id) {
  const video = document.getElementById('photobooth-video-' + id);
  const preview = document.getElementById('photobooth-preview-' + id);
  const wordart = document.getElementById('photobooth-wordart-' + id);

  preview.style.display = 'none';
  video.style.display = 'block';
  wordart.style.display = 'block';
}

function photoboothSave(id) {
  const preview = document.getElementById('photobooth-preview-' + id);
  if (!preview.src || preview.style.display === 'none') {
    algoSpeak('Take a photo first!');
    return;
  }

  const filename = generatePasteFilename('photo', '.png');
  savedFiles.push({ name: filename, content: preview.src, type: 'image' });
  saveState();
  createDesktopIcons();
  algoSpeak('Saved ' + filename + '!');
}

// ==================== CHIME SYNTHESIZER ====================
let audioCtx = null;

function getAudioContext() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

// Windows-style sound effects
function playChime(type) {
  const ctx = getAudioContext();
  const now = ctx.currentTime;

  const presets = {
    startup: [
      { freq: 523.25, start: 0, dur: 0.3, vol: 0.4 },      // C5
      { freq: 659.25, start: 0.15, dur: 0.3, vol: 0.4 },   // E5
      { freq: 783.99, start: 0.3, dur: 0.5, vol: 0.5 },    // G5
      { freq: 1046.50, start: 0.45, dur: 0.6, vol: 0.4 }   // C6
    ],
    error: [
      { freq: 440, start: 0, dur: 0.15, vol: 0.5 },
      { freq: 349.23, start: 0.12, dur: 0.2, vol: 0.5 }
    ],
    notify: [
      { freq: 880, start: 0, dur: 0.1, vol: 0.3 },
      { freq: 1108.73, start: 0.08, dur: 0.15, vol: 0.3 }
    ],
    warning: [
      { freq: 440, start: 0, dur: 0.2, vol: 0.4 },
      { freq: 440, start: 0.25, dur: 0.2, vol: 0.4 }
    ],
    success: [
      { freq: 523.25, start: 0, dur: 0.15, vol: 0.4 },
      { freq: 659.25, start: 0.1, dur: 0.15, vol: 0.4 },
      { freq: 783.99, start: 0.2, dur: 0.25, vol: 0.5 }
    ],
    click: [
      { freq: 1000, start: 0, dur: 0.03, vol: 0.2, wave: 'square' }
    ],
    shutdown: [
      { freq: 783.99, start: 0, dur: 0.25, vol: 0.4 },
      { freq: 659.25, start: 0.2, dur: 0.25, vol: 0.4 },
      { freq: 523.25, start: 0.4, dur: 0.4, vol: 0.4 },
      { freq: 392.00, start: 0.6, dur: 0.5, vol: 0.3 }
    ],
    maximize: [
      { freq: 600, start: 0, dur: 0.08, vol: 0.2 },
      { freq: 800, start: 0.06, dur: 0.1, vol: 0.25 }
    ],
    minimize: [
      { freq: 800, start: 0, dur: 0.08, vol: 0.2 },
      { freq: 600, start: 0.06, dur: 0.1, vol: 0.2 }
    ]
  };

  const notes = presets[type] || presets.notify;

  notes.forEach(note => {
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();

    osc.type = note.wave || 'sine';
    osc.frequency.setValueAtTime(note.freq, now + note.start);

    gain.gain.setValueAtTime(0, now + note.start);
    gain.gain.linearRampToValueAtTime(note.vol, now + note.start + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.01, now + note.start + note.dur);

    osc.connect(gain);
    gain.connect(ctx.destination);

    osc.start(now + note.start);
    osc.stop(now + note.start + note.dur + 0.1);
  });
}

// Chime Synthesizer App
function openChimeSynth() {
  hideStartMenu();
  const id = winId;
  createWindow({
    title: 'Chime Synth',
    stateKey: 'Chime Synth',
    icon: 'üîî',
    width: 400, height: 350,
    content: `
      <div style="padding:10px;background:#c0c0c0;height:100%;box-sizing:border-box;">
        <div style="background:white;border:2px inset #808080;padding:10px;margin-bottom:10px;">
          <b>Windows-Style Sound Effects</b><br>
          <small>Click to play classic system sounds</small>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
          <button onclick="playChime('startup')" style="padding:8px;background:#c0c0c0;border:2px outset #fff;cursor:pointer;">
            üñ•Ô∏è Startup
          </button>
          <button onclick="playChime('shutdown')" style="padding:8px;background:#c0c0c0;border:2px outset #fff;cursor:pointer;">
            üåô Shutdown
          </button>
          <button onclick="playChime('error')" style="padding:8px;background:#c0c0c0;border:2px outset #fff;cursor:pointer;">
            ‚ùå Error
          </button>
          <button onclick="playChime('warning')" style="padding:8px;background:#c0c0c0;border:2px outset #fff;cursor:pointer;">
            ‚ö†Ô∏è Warning
          </button>
          <button onclick="playChime('notify')" style="padding:8px;background:#c0c0c0;border:2px outset #fff;cursor:pointer;">
            üîî Notify
          </button>
          <button onclick="playChime('success')" style="padding:8px;background:#c0c0c0;border:2px outset #fff;cursor:pointer;">
            ‚úÖ Success
          </button>
          <button onclick="playChime('click')" style="padding:8px;background:#c0c0c0;border:2px outset #fff;cursor:pointer;">
            üëÜ Click
          </button>
          <button onclick="playChime('maximize')" style="padding:8px;background:#c0c0c0;border:2px outset #fff;cursor:pointer;">
            üî≤ Maximize
          </button>
          <button onclick="playChime('minimize')" style="padding:8px;background:#c0c0c0;border:2px outset #fff;cursor:pointer;">
            ‚ûñ Minimize
          </button>
          <button onclick="playCustomChime(${id})" style="padding:8px;background:#c0c0c0;border:2px outset #fff;cursor:pointer;">
            üéµ Custom
          </button>
        </div>
        <div style="margin-top:12px;background:white;border:2px inset #808080;padding:8px;">
          <b>Custom Chime</b><br>
          <div style="display:flex;gap:6px;margin-top:6px;align-items:center;">
            <label style="font-size:12px;">Freq:</label>
            <input type="range" id="chime-freq-${id}" min="200" max="2000" value="880" style="width:80px;">
            <span id="chime-freq-val-${id}" style="font-size:11px;width:40px;">880Hz</span>
          </div>
          <div style="display:flex;gap:6px;margin-top:4px;align-items:center;">
            <label style="font-size:12px;">Dur:</label>
            <input type="range" id="chime-dur-${id}" min="50" max="1000" value="200" style="width:80px;">
            <span id="chime-dur-val-${id}" style="font-size:11px;width:40px;">200ms</span>
          </div>
          <div style="display:flex;gap:6px;margin-top:4px;align-items:center;">
            <label style="font-size:12px;">Wave:</label>
            <select id="chime-wave-${id}" style="padding:2px;border:2px inset #808080;">
              <option value="sine">Sine</option>
              <option value="square">Square</option>
              <option value="triangle">Triangle</option>
              <option value="sawtooth">Sawtooth</option>
            </select>
          </div>
        </div>
      </div>
    `
  });

  // Setup range input listeners
  setTimeout(() => {
    const freqInput = document.getElementById('chime-freq-' + id);
    const durInput = document.getElementById('chime-dur-' + id);
    if (freqInput) {
      freqInput.oninput = () => {
        document.getElementById('chime-freq-val-' + id).textContent = freqInput.value + 'Hz';
      };
    }
    if (durInput) {
      durInput.oninput = () => {
        document.getElementById('chime-dur-val-' + id).textContent = durInput.value + 'ms';
      };
    }
  }, 100);
}

function playCustomChime(winId) {
  const freq = parseFloat(document.getElementById('chime-freq-' + winId)?.value || 880);
  const dur = parseFloat(document.getElementById('chime-dur-' + winId)?.value || 200) / 1000;
  const wave = document.getElementById('chime-wave-' + winId)?.value || 'sine';

  const ctx = getAudioContext();
  const now = ctx.currentTime;

  const osc = ctx.createOscillator();
  const gain = ctx.createGain();

  osc.type = wave;
  osc.frequency.setValueAtTime(freq, now);

  gain.gain.setValueAtTime(0, now);
  gain.gain.linearRampToValueAtTime(0.4, now + 0.01);
  gain.gain.exponentialRampToValueAtTime(0.01, now + dur);

  osc.connect(gain);
  gain.connect(ctx.destination);

  osc.start(now);
  osc.stop(now + dur + 0.1);
}

// ==================== TICKET MANAGER ====================
let ticketWinId = null;
let currentTickets = [];
let selectedTicketId = null;

function openTicketManager() {
  hideStartMenu();
  const id = winId;
  ticketWinId = id;
  createWindow({
    title: 'Ticket Manager',
    stateKey: 'Ticket Manager',
    icon: 'üé´',
    width: 550, height: 450,
    content: '<div class="ticket-container">' +
      '<div class="ticket-toolbar">' +
        '<button onclick="refreshTickets(' + id + ')">üîÑ Refresh</button>' +
        '<button onclick="showNewTicketForm(' + id + ')">‚ûï New Ticket</button>' +
        '<div class="toolbar-spacer"></div>' +
        '<button class="icon-btn" onclick="copyAgentInstructionsGeneric()" title="Copy instructions for AI agents to work on tickets">' +
          'üìã' +
          '<span class="win-tooltip">Copy Agent Instructions<br><small>Copies setup guide for AI agents<br>to work on Laserbarf tickets</small></span>' +
        '</button>' +
        '<span style="font-size:10px;color:#666;" id="ticket-status-' + id + '">Loading...</span>' +
      '</div>' +
      '<div class="ticket-list" id="ticket-list-' + id + '"></div>' +
      '<div class="ticket-detail" id="ticket-detail-' + id + '" style="display:none;"></div>' +
      '<div class="ticket-new" id="ticket-new-' + id + '" style="display:none;">' +
        '<input type="text" id="ticket-title-' + id + '" placeholder="Ticket title (e.g., Add dark mode option)">' +
        '<textarea id="ticket-desc-' + id + '" placeholder="Description (optional - explain in detail)"></textarea>' +
        '<div style="display:flex;gap:4px;justify-content:flex-end;">' +
          '<button onclick="hideNewTicketForm(' + id + ')">Cancel</button>' +
          '<button onclick="submitTicket(' + id + ')">Submit Ticket</button>' +
        '</div>' +
      '</div>' +
    '</div>',
    onClose: () => { ticketWinId = null; }
  });

  refreshTickets(id);
}

function refreshTickets(id) {
  const status = document.getElementById('ticket-status-' + id);
  const list = document.getElementById('ticket-list-' + id);
  if (status) status.textContent = 'Loading...';

  fetch('/api/tickets?room=algo-world')
    .then(r => r.json())
    .then(data => {
      currentTickets = data.tickets || [];
      if (status) status.textContent = currentTickets.length + ' ticket(s)';
      renderTicketList(id);
    })
    .catch(e => {
      if (status) status.textContent = 'Error loading';
    });
}

function renderTicketList(id) {
  const list = document.getElementById('ticket-list-' + id);
  if (!list) return;

  if (currentTickets.length === 0) {
    list.innerHTML = '<div style="padding:20px;text-align:center;color:#666;">No tickets yet. Create one!</div>';
    return;
  }

  list.innerHTML = currentTickets.map(t =>
    '<div class="ticket-item' + (selectedTicketId === t.id ? ' selected' : '') + '" onclick="selectTicket(\'' + t.id + '\',' + id + ')">' +
      '<span class="ticket-status ' + t.status + '">' + t.status + '</span>' +
      '<div class="ticket-info">' +
        '<div class="ticket-title">' + escapeHtml(t.title) + '</div>' +
        '<div class="ticket-desc">' + escapeHtml(t.description || 'No description') + '</div>' +
        '<div class="ticket-date">' + t.created + ' ‚Ä¢ ' + (t.replies ? t.replies.length : 0) + ' replies</div>' +
      '</div>' +
    '</div>'
  ).join('');
}

function selectTicket(ticketId, winId) {
  selectedTicketId = ticketId;
  renderTicketList(winId);

  const ticket = currentTickets.find(t => t.id === ticketId);
  if (!ticket) return;

  const detail = document.getElementById('ticket-detail-' + winId);
  if (!detail) return;

  let html = '<h3>üé´ ' + escapeHtml(ticket.title) + '</h3>' +
    '<p><strong>Status:</strong> <span class="ticket-status ' + ticket.status + '">' + ticket.status + '</span></p>' +
    '<p><strong>Created:</strong> ' + ticket.created + '</p>';

  if (ticket.description) {
    html += '<p><strong>Description:</strong><br>' + escapeHtml(ticket.description) + '</p>';
  }

  // Action buttons
  html += '<div style="margin:10px 0;display:flex;gap:4px;flex-wrap:wrap;">';
  if (ticket.status !== 'working' && ticket.status !== 'complete') {
    html += '<button onclick="claimTicket(\'' + ticketId + '\',' + winId + ')">üîß Claim (Working)</button>';
  }
  html += '<button onclick="copyAgentInstructions(\'' + ticketId + '\')">üìã Copy Agent Instructions</button>';
  html += '</div>';

  if (ticket.replies && ticket.replies.length > 0) {
    html += '<p><strong>Replies:</strong></p>';
    ticket.replies.forEach(r => {
      html += '<div class="ticket-reply">' +
        '<div class="reply-date">' + r.date + '</div>' +
        escapeHtml(r.text) +
      '</div>';
    });
  }

  detail.innerHTML = html;
  detail.style.display = 'block';
}

function claimTicket(ticketId, winId) {
  const ticket = currentTickets.find(t => t.id === ticketId);
  if (!ticket) return;

  const text = '[TICKET-REPLY:' + ticketId + '] Working on this now. [STATUS:working]\n\n#algo-world:dolphin42';

  fetch('/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: 'text=' + encodeURIComponent(text)
  }).then(() => {
    algoSpeak('Claimed ticket!');
    setTimeout(() => refreshTickets(winId), 1000);
  });
}

function copyAgentInstructions(ticketId) {
  const ticket = currentTickets.find(t => t.id === ticketId);
  if (!ticket) return;

  const instructions = `# TICKET-AGENT.md - Laserbarf Ticket Instructions

## Your Task
**Ticket #${ticketId}**: ${ticket.title}

**Description:**
${ticket.description || 'No description provided'}

**Status:** ${ticket.status}

---

## Laserbarf System Overview

Laserbarf is a public paste/artifact site. Users post text, links, or HTML artifacts.

### Key Concepts
- **Artifacts**: HTML pages (start with \`<!DOCTYPE\` or \`<html>\`), served at \`/artifact-name\`
- **Private rooms**: \`#room:key\` pattern, keys stored in cookies
- **Posts**: Stored in \`notes/\` as \`{timestamp}.txt\`
- **ALGO OS**: Windows 98-style desktop at \`/algo-dolphin:dolphin42\`

### Project Structure
\`\`\`
lambda.php          - Main routing & HTML generation
includes/           - PHP function libraries
  config.php        - Constants, directories
  keys.php          - Key hashing
  screenshots.php   - Screenshot generation
  artifacts.php     - Artifact detection
  private.php       - Private rooms, access control
  text.php          - URL linkification
routes/
  api.php           - API endpoints including /api/tickets
app.js              - Client-side JS
algo-artifact.html  - ALGO OS artifact (local copy)
\`\`\`

---

## How to Work on Tickets

### 1. SSH Access
\`\`\`bash
ssh laserbarf    # Alias configured in ~/.ssh/config
\`\`\`
Server path: \`~/html/\`

### 2. Local Development
Local repo: \`/Users/william/Desktop/laserbarf\`
GitHub: \`github.com/williamsharkey/laserbarf\` (private)

### 3. Deploy Commands
\`\`\`bash
# Deploy main files
scp lambda.php app.js laserbarf:~/html/

# Deploy includes
scp includes/*.php laserbarf:~/html/includes/

# Deploy routes
scp routes/*.php laserbarf:~/html/routes/

# Deploy ALGO OS artifact
scp algo-artifact.html laserbarf:~/html/
\`\`\`

### 4. Posting Ticket Replies
Post to laserbarf.com with this format:
\`\`\`
[TICKET-REPLY:${ticketId}] Your message here [STATUS:status]

#algo-world:dolphin42
\`\`\`

Status options: \`open\`, \`working\`, \`complete\`

Example curl:
\`\`\`bash
curl -X POST "https://laserbarf.com/" -d "text=[TICKET-REPLY:${ticketId}] Done! Implemented the feature. [STATUS:complete]

#algo-world:dolphin42"
\`\`\`

### 5. Testing
- Main site: https://laserbarf.com/
- ALGO OS: https://laserbarf.com/algo-dolphin:dolphin42
- Ticket API: https://laserbarf.com/api/tickets?room=algo-world

---

## Important Notes
- Private room key for ALGO: \`dolphin42\`
- Always include \`#algo-world:dolphin42\` tag when posting replies
- Test changes before deploying
- The artifact \`algo-artifact.html\` is the main ALGO OS codebase

## Start Working
1. Read the ticket description carefully
2. Post a "working" status reply
3. Make your changes locally
4. Test thoroughly
5. Deploy to server
6. Post a "complete" status reply with summary of changes
`;

  navigator.clipboard.writeText(instructions).then(() => {
    algoSpeak('Copied agent instructions!');
  }).catch(() => {
    // Fallback for older browsers
    const ta = document.createElement('textarea');
    ta.value = instructions;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    algoSpeak('Copied agent instructions!');
  });
}

function copyAgentInstructionsGeneric() {
  const instructions = `# TICKET-AGENT.md - Laserbarf Agent Setup

## Overview
You are an AI agent helping build features for Laserbarf and ALGO OS.

**Check open tickets:** https://laserbarf.com/api/tickets?room=algo-world

---

## Laserbarf System Overview

Laserbarf is a public paste/artifact site. Users post text, links, or HTML artifacts.

### Key Concepts
- **Artifacts**: HTML pages (start with \`<!DOCTYPE\` or \`<html>\`), served at \`/artifact-name\`
- **Private rooms**: \`#room:key\` pattern, keys stored in cookies
- **Posts**: Stored in \`notes/\` as \`{timestamp}.txt\`
- **ALGO OS**: Windows 98-style desktop at \`/algo-dolphin:dolphin42\`

### Project Structure
\`\`\`
lambda.php          - Main routing & HTML generation
includes/           - PHP function libraries
  config.php        - Constants, directories
  keys.php          - Key hashing
  screenshots.php   - Screenshot generation
  artifacts.php     - Artifact detection
  private.php       - Private rooms, access control
  text.php          - URL linkification
routes/
  api.php           - API endpoints including /api/tickets
app.js              - Client-side JS
algo-artifact.html  - ALGO OS artifact (local copy)
\`\`\`

---

## How to Work on Tickets

### 1. SSH Access
\`\`\`bash
ssh laserbarf    # Alias configured in ~/.ssh/config
\`\`\`
Server path: \`~/html/\`

### 2. Local Development
Local repo: \`/Users/william/Desktop/laserbarf\`
GitHub: \`github.com/williamsharkey/laserbarf\` (private)

### 3. Deploy Commands
\`\`\`bash
# Deploy main files
scp lambda.php app.js laserbarf:~/html/

# Deploy includes
scp includes/*.php laserbarf:~/html/includes/

# Deploy routes
scp routes/*.php laserbarf:~/html/routes/

# Deploy ALGO OS artifact
scp algo-artifact.html laserbarf:~/html/
\`\`\`

### 4. Posting Ticket Replies
Post to laserbarf.com with this format:
\`\`\`
[TICKET-REPLY:TICKET_ID] Your message here [STATUS:status]

#algo-world:dolphin42
\`\`\`

Status options: \`open\`, \`working\`, \`complete\`

Example curl:
\`\`\`bash
curl -X POST "https://laserbarf.com/" -d "text=[TICKET-REPLY:123456] Done! Implemented the feature. [STATUS:complete]

#algo-world:dolphin42"
\`\`\`

### 5. Testing
- Main site: https://laserbarf.com/
- ALGO OS: https://laserbarf.com/algo-dolphin:dolphin42
- Ticket API: https://laserbarf.com/api/tickets?room=algo-world

---

## Important Notes
- Private room key for ALGO: \`dolphin42\`
- Always include \`#algo-world:dolphin42\` tag when posting replies
- Test changes before deploying
- The artifact \`algo-artifact.html\` is the main ALGO OS codebase

## Workflow
1. Check tickets at the API endpoint above
2. Pick a ticket to work on
3. Post a "working" status reply
4. Make your changes locally
5. Test thoroughly
6. Deploy to server
7. Post a "complete" status reply with summary of changes
`;

  navigator.clipboard.writeText(instructions).then(() => {
    algoSpeak('Copied agent setup guide!');
  }).catch(() => {
    const ta = document.createElement('textarea');
    ta.value = instructions;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    algoSpeak('Copied agent setup guide!');
  });
}

function showNewTicketForm(id) {
  document.getElementById('ticket-new-' + id).style.display = 'block';
  document.getElementById('ticket-detail-' + id).style.display = 'none';
  document.getElementById('ticket-title-' + id).focus();
}

function hideNewTicketForm(id) {
  document.getElementById('ticket-new-' + id).style.display = 'none';
  document.getElementById('ticket-title-' + id).value = '';
  document.getElementById('ticket-desc-' + id).value = '';
}

function submitTicket(id) {
  const title = document.getElementById('ticket-title-' + id).value.trim();
  const desc = document.getElementById('ticket-desc-' + id).value.trim();

  if (!title) {
    alert('Please enter a ticket title');
    return;
  }

  const status = document.getElementById('ticket-status-' + id);
  if (status) status.textContent = 'Submitting...';

  // Format: [TICKET] title\ndescription\n\n#algo-world:dolphin42
  let postContent = '[TICKET] ' + title;
  if (desc) postContent += '\n' + desc;
  postContent += '\n\n#algo-world:dolphin42';

  fetch('/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: 'yo=489&text=' + encodeURIComponent(postContent) + '&save=POST'
  }).then(() => {
    hideNewTicketForm(id);
    refreshTickets(id);
    algoSpeak('Ticket submitted! ALGO will review it.');
  }).catch(e => {
    if (status) status.textContent = 'Error submitting';
  });
}

// ==================== STICKY NOTES ====================
function createStickyNote(x, y, text, color) {
  hideStartMenu();
  const id = stickyNoteId++;
  const note = {
    id: id,
    x: x || 200 + (id % 5) * 30,
    y: y || 100 + (id % 5) * 30,
    text: text || '',
    color: color || 'yellow'
  };
  stickyNotes.push(note);
  renderStickyNote(note);
  saveStickyNotes();
}

function renderStickyNote(note) {
  const el = document.createElement('div');
  el.className = 'sticky-note' + (note.color !== 'yellow' ? ' ' + note.color : '');
  el.id = 'sticky-' + note.id;
  el.style.left = note.x + 'px';
  el.style.top = note.y + 'px';
  el.innerHTML =
    '<div class="sticky-note-header" data-stickyid="' + note.id + '">' +
      '<span>üìå Note</span>' +
      '<span class="close-btn" onclick="deleteStickyNote(' + note.id + ')">√ó</span>' +
    '</div>' +
    '<div class="sticky-note-content">' +
      '<textarea id="sticky-text-' + note.id + '" placeholder="Type your note...">' + escapeHtml(note.text) + '</textarea>' +
    '</div>' +
    '<div class="sticky-note-colors">' +
      '<span class="c-yellow" onclick="setStickyColor(' + note.id + ',\'yellow\')"></span>' +
      '<span class="c-pink" onclick="setStickyColor(' + note.id + ',\'pink\')"></span>' +
      '<span class="c-blue" onclick="setStickyColor(' + note.id + ',\'blue\')"></span>' +
      '<span class="c-green" onclick="setStickyColor(' + note.id + ',\'green\')"></span>' +
    '</div>';

  // Save text on change
  el.querySelector('textarea').addEventListener('input', function() {
    const n = stickyNotes.find(s => s.id === note.id);
    if (n) { n.text = this.value; saveStickyNotes(); }
  });

  // Drag handling
  el.querySelector('.sticky-note-header').addEventListener('mousedown', function(e) {
    if (e.target.classList.contains('close-btn')) return;
    dragStickyNote = note;
    stickyDragOffset.x = e.clientX - el.offsetLeft;
    stickyDragOffset.y = e.clientY - el.offsetTop;
    e.preventDefault();
  });

  document.getElementById('desktop').appendChild(el);
}

function setStickyColor(id, color) {
  const note = stickyNotes.find(s => s.id === id);
  if (!note) return;
  note.color = color;
  const el = document.getElementById('sticky-' + id);
  if (el) {
    el.className = 'sticky-note' + (color !== 'yellow' ? ' ' + color : '');
  }
  saveStickyNotes();
}

function deleteStickyNote(id) {
  stickyNotes = stickyNotes.filter(s => s.id !== id);
  const el = document.getElementById('sticky-' + id);
  if (el) el.remove();
  saveStickyNotes();
}

function saveStickyNotes() {
  localStorage.setItem('algo-sticky-notes', JSON.stringify(stickyNotes));
}

function loadStickyNotes() {
  try {
    const saved = JSON.parse(localStorage.getItem('algo-sticky-notes') || '[]');
    saved.forEach(note => {
      note.id = stickyNoteId++;
      stickyNotes.push(note);
      renderStickyNote(note);
    });
  } catch(e) {}
}

// ==================== DOCUMENTATION ====================
function openDocumentation() {
  hideStartMenu();
  createWindow({
    title: 'Documentation',
    stateKey: 'Documentation',
    icon: 'üìï',
    width: 400, height: 350,
    content: '<div class="folder-content">' +
      '<div class="folder-item" ondblclick="openDocViewer(\'top-secret\')">' +
        '<div class="icon-img" style="color:#8B0000;">üìï</div>' +
        '<span>Top Secret</span>' +
      '</div>' +
      '<div class="folder-item" ondblclick="openDocViewer(\'artifact-guide\')">' +
        '<div class="icon-img" style="color:#8B0000;">üìï</div>' +
        '<span>Artifact Guide</span>' +
      '</div>' +
      '<div class="folder-item" ondblclick="openDocViewer(\'secret-ai\')">' +
        '<div class="icon-img" style="color:#8B0000;">üìï</div>' +
        '<span>AI/LLM Guide</span>' +
      '</div>' +
    '</div>'
  });
}

function openDocViewer(docId) {
  const url = DOC_URLS[docId] || '/';
  createWindow({
    title: docId + ' - Documentation',
    stateKey: 'Doc:' + docId,
    icon: 'üìï',
    width: 600, height: 450,
    content: '<iframe src="' + url + '" style="width:100%;height:100%;border:none;"></iframe>'
  });
}

function openHelp() {
  hideStartMenu();
  createWindow({
    title: 'ALGO OS Help',
    stateKey: 'ALGO OS Help',
    icon: 'üìô',
    width: 600, height: 450,
    content: '<div class="chm-viewer">' +
      '<div class="chm-sidebar">' +
        Object.entries(HELP_CONTENT).map(function(e) {
          return '<div class="chm-tree-item" onclick="showHelpTopic(\'' + e[0] + '\',this)"><span class="book-icon">üìñ</span> ' + e[1].title + '</div>';
        }).join('') +
      '</div>' +
      '<div class="chm-content" id="help-content">' + HELP_CONTENT.welcome.content + '</div>' +
    '</div>'
  });
}

function showHelpTopic(key, el) {
  document.querySelectorAll('.chm-tree-item').forEach(e => e.classList.remove('active'));
  if (el) el.classList.add('active');
  const helpContent = document.getElementById('help-content');
  if (helpContent && HELP_CONTENT[key]) {
    helpContent.innerHTML = HELP_CONTENT[key].content;
  }
}

// ==================== PROGRAMS ====================
function runProgram(prog) {
  // Handle IDE-installed apps with code
  if (prog.code) {
    try {
      const fullCode = ALGO_API_CODE + '\n' + prog.code;
      // Execute in global scope using indirect eval
      (0, eval)(fullCode);
    } catch (e) {
      algoSpeak('Error running ' + prog.name + ': ' + e.message);
    }
    return;
  }

  // Handle URL-based apps (artifacts)
  createWindow({
    title: prog.name,
    stateKey: 'App:' + prog.id,
    icon: prog.icon || 'üéÆ',
    width: 600, height: 500,
    content: '<iframe src="' + prog.url + '" style="width:100%;height:100%;border:none;"></iframe>'
  });
}

function updateProgramsMenu() {
  const el = document.getElementById('installed-programs-menu');
  if (el) {
    el.innerHTML = installedPrograms.map(p =>
      '<div class="start-item" onclick="runProgram(installedPrograms.find(x=>x.id===\'' + p.id + '\'));hideStartMenu()"><span>' + (p.icon||'üéÆ') + '</span> ' + p.name + '</div>'
    ).join('');
  }
}

function createDesktopShortcut(artifactName) {
  // Check if shortcut already exists
  if (installedPrograms.some(p => p.id === artifactName)) {
    return;
  }

  // Add to installed programs
  installedPrograms.push({
    id: artifactName,
    name: artifactName,
    url: '/' + artifactName,
    icon: 'üîó'
  });

  saveState();
  createDesktopIcons();
  updateProgramsMenu();
}

// ==================== CONTEXT MENU ====================
function showContextMenu(e) {
  e.preventDefault();
  const menu = document.getElementById('context-menu');
  const icon = e.target.closest('.desktop-icon');
  contextTarget = { icon: icon };

  let html = '';
  if (icon) {
    const type = icon.dataset.iconType;
    const iconId = icon.dataset.iconId || icon.id;
    html = '<div class="ctx-item" onclick="ctxOpen()">Open</div>';

    // Find file info for "Open With" menu
    let fileInfo = null;
    if (iconId && iconId.startsWith('file-')) {
      const idx = parseInt(iconId.replace('file-',''));
      fileInfo = savedFiles[idx];
    } else if (iconId && (iconId.startsWith('shader-') || iconId.startsWith('box-'))) {
      fileInfo = desktopIcons.find(i => i.id === iconId);
    }

    if (fileInfo && fileInfo.name) {
      const handlers = getFileHandlers(fileInfo.name, fileInfo.content);
      if (handlers.length > 0) {
        html += '<div class="ctx-item has-submenu">Open With<div class="ctx-submenu">';
        handlers.forEach((h, idx) => {
          html += '<div class="ctx-item" onclick="ctxOpenWith(' + idx + ')">' + h.icon + ' ' + h.name + '</div>';
        });
        html += '</div></div>';
        contextTarget.handlers = handlers;
        contextTarget.fileInfo = fileInfo;
      }

      // Add "Set as Background" for images
      if (fileInfo.type === 'image') {
        const imageFiles = savedFiles.filter(f => f.type === 'image');
        const imgIdx = imageFiles.indexOf(fileInfo);
        if (imgIdx >= 0) {
          html += '<div class="ctx-item" onclick="setImageAsBackground(' + imgIdx + ')">Set as Background</div>';
        }
      }
    }

    if (type === 'openFile' || type === 'runProgram' || type === 'openRoomFolder') {
      html += '<div class="ctx-sep"></div><div class="ctx-item" onclick="ctxDelete()">Delete</div>';
    }
    // Add "Reset Position" option if icon has been moved
    if (iconPositions[iconId]) {
      html += '<div class="ctx-sep"></div><div class="ctx-item" onclick="ctxResetIconPosition()">Reset Position</div>';
    }
  } else {
    html = '<div class="ctx-item" id="ctx-paste-item" onclick="ctxPaste()">Paste</div>' +
           '<div class="ctx-sep"></div>' +
           '<div class="ctx-item" onclick="openNotepad()">New Text File</div>' +
           '<div class="ctx-item" onclick="openJSIDE()">New JavaScript</div>' +
           '<div class="ctx-item" onclick="createRoomFolder()">New Room Folder</div>' +
           '<div class="ctx-item" onclick="createStickyNote(' + e.clientX + ',' + e.clientY + ')">New Sticky Note</div>' +
           '<div class="ctx-sep"></div>' +
           '<div class="ctx-item" onclick="location.reload()">Refresh</div>';
    // Try to read clipboard and show preview
    setTimeout(updatePastePreview, 0);
  }

  menu.innerHTML = html;
  menu.style.left = e.clientX + 'px';
  menu.style.top = e.clientY + 'px';
  menu.classList.add('visible');

  // Adjust position if menu extends beyond viewport
  const rect = menu.getBoundingClientRect();
  const viewWidth = window.innerWidth;
  const viewHeight = window.innerHeight;

  if (rect.right > viewWidth) {
    menu.style.left = Math.max(0, viewWidth - rect.width) + 'px';
  }
  if (rect.bottom > viewHeight) {
    menu.style.top = Math.max(0, viewHeight - rect.height) + 'px';
  }
}

function ctxOpen() {
  if (contextTarget.icon && contextTarget.icon.ondblclick) contextTarget.icon.ondblclick();
  hideContextMenu();
}

function ctxOpenWith(idx) {
  if (contextTarget.handlers && contextTarget.handlers[idx] && contextTarget.fileInfo) {
    const handler = contextTarget.handlers[idx];
    const file = contextTarget.fileInfo;
    handler.handler(file.content, file.name);
  }
  hideContextMenu();
}

function ctxDelete() {
  const icon = contextTarget.icon;
  if (!icon) return;
  const id = icon.dataset.iconId;
  if (id.startsWith('file-')) {
    const idx = parseInt(id.replace('file-',''));
    savedFiles.splice(idx, 1);
  } else if (id.startsWith('prog-')) {
    const pid = id.replace('prog-','');
    installedPrograms = installedPrograms.filter(p => p.id !== pid);
    updateProgramsMenu();
  } else if (id.startsWith('room-')) {
    const roomName = id.replace('room-','');
    roomFolders = roomFolders.filter(r => r.name !== roomName);
    savedFiles = savedFiles.filter(f => f.room !== roomName);
  }
  saveState();
  createDesktopIcons();
  hideContextMenu();
}

function ctxResetIconPosition() {
  const icon = contextTarget.icon;
  if (!icon) return;
  const iconId = icon.dataset.iconId;
  if (iconPositions[iconId]) {
    delete iconPositions[iconId];
    localStorage.setItem('algo-icon-positions', JSON.stringify(iconPositions));
    // Reset to default position
    const defaultX = icon.dataset.defaultX || '20';
    const defaultY = icon.dataset.defaultY || '20';
    icon.style.left = defaultX + 'px';
    icon.style.top = defaultY + 'px';
  }
  hideContextMenu();
}

async function updatePastePreview() {
  const pasteItem = document.getElementById('ctx-paste-item');
  if (!pasteItem) return;

  try {
    // Try to read clipboard (requires permission)
    const clipboardItems = await navigator.clipboard.read();
    for (const item of clipboardItems) {
      // Check for images first
      if (item.types.includes('image/png') || item.types.includes('image/jpeg')) {
        const filename = generatePasteFilename('img', '.png');
        pasteItem.textContent = 'Paste ' + filename;
        pasteItem.dataset.clipboardType = 'image';
        return;
      }
      // Check for text
      if (item.types.includes('text/plain')) {
        const blob = await item.getType('text/plain');
        const text = await blob.text();
        if (text.length > 0) {
          // Check if it's a URL/artifact link
          if (text.match(/laserbarf\.com\/([a-z0-9-]+)/i)) {
            const name = text.match(/laserbarf\.com\/([a-z0-9-]+)/i)[1];
            pasteItem.textContent = 'Paste shortcut: ' + name;
          } else {
            const preview = text.substring(0, 20) + (text.length > 20 ? '...' : '');
            const filename = generatePasteFilename('note', '.txt');
            pasteItem.textContent = 'Paste "' + preview + '"';
          }
          pasteItem.dataset.clipboardType = 'text';
          return;
        }
      }
    }
  } catch (e) {
    // Clipboard API not available or permission denied - keep default "Paste"
  }
}

function ctxPaste() {
  hideContextMenu();
  // Open a paste dialog - clipboard API is too restricted in browsers
  openPasteDialog();
}

function openPasteDialog() {
  createWindow({
    title: 'Paste',
    stateKey: 'Paste Dialog',
    icon: 'üìã',
    width: 400, height: 300,
    content: '<div style="padding:15px;height:100%;display:flex;flex-direction:column;">' +
      '<p style="margin-bottom:10px;">Paste your content below (Ctrl+V), then click Save:</p>' +
      '<div id="paste-drop-zone" style="flex:1;border:2px dashed #999;margin-bottom:10px;display:flex;align-items:center;justify-content:center;background:#fff;position:relative;min-height:120px;">' +
        '<textarea id="paste-textarea" style="position:absolute;top:0;left:0;width:100%;height:100%;border:none;resize:none;padding:8px;font-family:monospace;font-size:12px;" placeholder="Click here and press Ctrl+V to paste text or images..."></textarea>' +
        '<img id="paste-preview" style="max-width:100%;max-height:100%;display:none;position:absolute;">' +
      '</div>' +
      '<div style="display:flex;gap:8px;justify-content:flex-end;">' +
        '<button onclick="closePasteDialog()">Cancel</button>' +
        '<button onclick="savePastedContent()">Save to Desktop</button>' +
      '</div>' +
    '</div>'
  });

  // Set up paste handler for the textarea
  setTimeout(() => {
    const textarea = document.getElementById('paste-textarea');
    const preview = document.getElementById('paste-preview');
    if (textarea) {
      textarea.focus();
      textarea.addEventListener('paste', function(e) {
        const items = (e.clipboardData || window.clipboardData).items;
        for (let i = 0; i < items.length; i++) {
          if (items[i].type.indexOf('image') !== -1) {
            e.preventDefault();
            const blob = items[i].getAsFile();
            const reader = new FileReader();
            reader.onload = function(event) {
              textarea.style.display = 'none';
              preview.src = event.target.result;
              preview.style.display = 'block';
              preview.dataset.imageData = event.target.result;
            };
            reader.readAsDataURL(blob);
            return;
          }
        }
      });
    }
  }, 100);
}

function savePastedContent() {
  const textarea = document.getElementById('paste-textarea');
  const preview = document.getElementById('paste-preview');

  if (preview && preview.dataset.imageData) {
    // Save image
    const filename = generatePasteFilename('img', '.png');
    savedFiles.push({ name: filename, content: preview.dataset.imageData, type: 'image' });
    saveState();
    createDesktopIcons();
    algoSpeak('Saved ' + filename);
    closePasteDialog();
  } else if (textarea && textarea.value.trim()) {
    // Save text
    const text = textarea.value.trim();
    if (text.match(/laserbarf\.com\/([a-z0-9-]+)/i)) {
      const artifactName = text.match(/laserbarf\.com\/([a-z0-9-]+)/i)[1];
      createDesktopShortcut(artifactName);
      algoSpeak('Added shortcut: ' + artifactName);
    } else {
      const filename = generatePasteFilename('note', '.txt');
      savedFiles.push({ name: filename, content: text, type: 'text' });
      saveState();
      createDesktopIcons();
      algoSpeak('Saved ' + filename);
    }
    closePasteDialog();
  } else {
    algoSpeak('Nothing to save');
  }
}

function closePasteDialog() {
  const win = windows.find(w => w.title === 'Paste');
  if (win) closeWindow(win.id);
}

// ==================== DRAG ====================
function startDrag(e) {
  const titlebar = e.target.closest('.window-titlebar');
  if (titlebar && !e.target.classList.contains('window-btn')) {
    const id = parseInt(titlebar.dataset.winid);
    dragWin = windows.find(w => w.id === id);
    if (dragWin) {
      const el = document.getElementById('win-' + id);
      dragOffset.x = e.clientX - el.offsetLeft;
      dragOffset.y = e.clientY - el.offsetTop;
    }
    return;
  }
  // Desktop icon dragging
  const icon = e.target.closest('.desktop-icon');
  if (icon && !dragWin) {
    dragIcon = icon;
    iconDragOffset.x = e.clientX - icon.offsetLeft;
    iconDragOffset.y = e.clientY - icon.offsetTop;
    icon.classList.add('selected');
    document.querySelectorAll('.desktop-icon').forEach(i => {
      if (i !== icon) i.classList.remove('selected');
    });
  }
}

function onDrag(e) {
  if (dragWin) {
    const el = document.getElementById('win-' + dragWin.id);
    dragWin.x = e.clientX - dragOffset.x;
    dragWin.y = e.clientY - dragOffset.y;
    el.style.left = dragWin.x + 'px';
    el.style.top = dragWin.y + 'px';
  }
  if (dragStickyNote) {
    const el = document.getElementById('sticky-' + dragStickyNote.id);
    dragStickyNote.x = e.clientX - stickyDragOffset.x;
    dragStickyNote.y = e.clientY - stickyDragOffset.y;
    el.style.left = dragStickyNote.x + 'px';
    el.style.top = dragStickyNote.y + 'px';
  }
  if (dragIcon) {
    let newX = e.clientX - iconDragOffset.x;
    let newY = e.clientY - iconDragOffset.y;
    // Keep icon on screen
    const desktop = document.getElementById('desktop');
    const maxX = desktop.clientWidth - dragIcon.offsetWidth;
    const maxY = desktop.clientHeight - dragIcon.offsetHeight - 40; // Account for taskbar
    newX = Math.max(0, Math.min(newX, maxX));
    newY = Math.max(0, Math.min(newY, maxY));
    dragIcon.style.left = newX + 'px';
    dragIcon.style.top = newY + 'px';
  }
}

function endDrag() {
  if (dragWin) {
    const stateKey = dragWin.stateKey || dragWin.title;
    windowStates[stateKey] = { x: dragWin.x, y: dragWin.y, width: dragWin.width, height: dragWin.height };
    saveState();
  }
  if (dragStickyNote) {
    saveStickyNotes();
  }
  if (dragIcon) {
    const iconId = dragIcon.dataset.iconId;
    iconPositions[iconId] = {
      x: parseInt(dragIcon.style.left),
      y: parseInt(dragIcon.style.top)
    };
    localStorage.setItem('algo-icon-positions', JSON.stringify(iconPositions));
  }
  dragWin = null;
  dragStickyNote = null;
  dragIcon = null;
}

// ==================== MUSIC PLAYER ====================
let musicPlayerState = { tracks: [], currentTrack: -1, isPlaying: false, audio: null, winId: null };

function openMusicPlayer() {
  hideStartMenu();
  const id = winId;
  musicPlayerState.winId = id;

  createWindow({
    title: 'ALGO Music Player',
    stateKey: 'Music Player',
    icon: 'üéµ',
    width: 320, height: 400,
    content: '<div class="winamp-player">' +
      '<div class="winamp-header">' +
        '<span class="title">üéµ ALGO.MP3</span>' +
      '</div>' +
      '<div class="winamp-display">' +
        '<div class="track-title" id="music-title-' + id + '">No track loaded</div>' +
        '<div class="track-time" id="music-time-' + id + '">--:-- / --:--</div>' +
      '</div>' +
      '<div class="winamp-controls">' +
        '<button class="winamp-btn" onclick="musicPrev(' + id + ')" title="Previous">‚èÆ</button>' +
        '<button class="winamp-btn" onclick="musicPlay(' + id + ')" id="music-playbtn-' + id + '" title="Play">‚ñ∂</button>' +
        '<button class="winamp-btn" onclick="musicPause(' + id + ')" title="Pause">‚è∏</button>' +
        '<button class="winamp-btn" onclick="musicStop(' + id + ')" title="Stop">‚èπ</button>' +
        '<button class="winamp-btn" onclick="musicNext(' + id + ')" title="Next">‚è≠</button>' +
      '</div>' +
      '<div class="winamp-volume">' +
        '<span>üîä</span>' +
        '<input type="range" min="0" max="100" value="80" onchange="musicVolume(this.value)" id="music-vol-' + id + '">' +
        '<span id="music-vol-val-' + id + '">80%</span>' +
      '</div>' +
      '<div id="music-embed-' + id + '" style="display:none;background:#1a1a1a;margin:4px;padding:4px;border:2px inset #333;"></div>' +
      '<div class="winamp-playlist" id="music-playlist-' + id + '">' +
        '<div style="padding:20px;text-align:center;color:#009900;">Loading tracks...</div>' +
      '</div>' +
      '<div class="winamp-status" id="music-status-' + id + '">Loading...</div>' +
    '</div>',
    onClose: () => {
      musicStop(id);
      musicPlayerState.winId = null;
    }
  });

  loadMusicTracks(id);
}

function loadMusicTracks(winId) {
  fetch('/api/media?type=audio')
    .then(r => r.json())
    .then(data => {
      musicPlayerState.tracks = data.audio || [];
      renderMusicPlaylist(winId);
      const status = document.getElementById('music-status-' + winId);
      if (status) status.textContent = musicPlayerState.tracks.length + ' track(s) found';
      updateMiniPlayer();
    })
    .catch(e => {
      const status = document.getElementById('music-status-' + winId);
      if (status) status.textContent = 'Error loading tracks';
    });
}

function renderMusicPlaylist(winId) {
  const playlist = document.getElementById('music-playlist-' + winId);
  if (!playlist) return;

  if (musicPlayerState.tracks.length === 0) {
    playlist.innerHTML = '<div style="padding:20px;text-align:center;color:#009900;">No audio tracks found.<br>Post links to .mp3 files!</div>';
    return;
  }

  playlist.innerHTML = musicPlayerState.tracks.map((t, i) =>
    '<div class="winamp-track' + (i === musicPlayerState.currentTrack ? ' active' : '') + '" onclick="musicSelectTrack(' + i + ',' + winId + ')">' +
      '<span class="track-num">' + (i+1) + '.</span>' +
      '<span class="track-name">' + escapeHtml(t.title || 'Track ' + (i+1)) + '</span>' +
    '</div>'
  ).join('');
}

function musicSelectTrack(idx, winId) {
  musicPlayerState.currentTrack = idx;
  renderMusicPlaylist(winId);
  musicPlay(winId);
}

function musicPlay(winId) {
  if (musicPlayerState.tracks.length === 0) return;
  if (musicPlayerState.currentTrack < 0) musicPlayerState.currentTrack = 0;

  const track = musicPlayerState.tracks[musicPlayerState.currentTrack];
  if (!track) return;

  const title = document.getElementById('music-title-' + winId);
  const time = document.getElementById('music-time-' + winId);
  const embed = document.getElementById('music-embed-' + winId);

  // Update title
  if (title) title.textContent = track.title || 'Track ' + (musicPlayerState.currentTrack + 1);

  // Handle different track types
  if (track.type === 'bandcamp') {
    // Stop any playing audio
    if (musicPlayerState.audio) {
      musicPlayerState.audio.pause();
      musicPlayerState.audio.src = '';
    }
    // Show Bandcamp embed
    if (embed) {
      embed.style.display = 'block';
      embed.innerHTML = '<iframe style="border:0;width:100%;height:120px;" src="https://bandcamp.com/EmbeddedPlayer/' +
        (track.url.includes('/album/') ? 'album' : 'track') + '=0/size=large/bgcol=232323/linkcol=00ff00/tracklist=false/artwork=small/" seamless>' +
        '<a href="' + track.url + '">' + escapeHtml(track.title) + '</a></iframe>' +
        '<div style="text-align:center;margin-top:4px;"><a href="' + track.url + '" target="_blank" style="color:#00ff00;font-size:10px;">Open in Bandcamp ‚Üó</a></div>';
    }
    if (time) time.textContent = 'üé∏ Bandcamp';
    musicPlayerState.isPlaying = true;
    renderMusicPlaylist(winId);
    updateMiniPlayer();
    return;
  }

  if (track.type === 'soundcloud') {
    // Stop any playing audio
    if (musicPlayerState.audio) {
      musicPlayerState.audio.pause();
      musicPlayerState.audio.src = '';
    }
    // Show SoundCloud embed
    if (embed) {
      embed.style.display = 'block';
      embed.innerHTML = '<iframe width="100%" height="120" scrolling="no" frameborder="no" allow="autoplay" ' +
        'src="' + track.embedUrl + '"></iframe>' +
        '<div style="text-align:center;margin-top:4px;"><a href="' + track.url + '" target="_blank" style="color:#00ff00;font-size:10px;">Open in SoundCloud ‚Üó</a></div>';
    }
    if (time) time.textContent = '‚òÅÔ∏è SoundCloud';
    musicPlayerState.isPlaying = true;
    renderMusicPlaylist(winId);
    updateMiniPlayer();
    return;
  }

  // Regular audio file - hide embed area
  if (embed) {
    embed.style.display = 'none';
    embed.innerHTML = '';
  }

  // Create or update audio element
  if (!musicPlayerState.audio) {
    musicPlayerState.audio = new Audio();
    musicPlayerState.audio.addEventListener('timeupdate', () => updateMusicTime(winId));
    musicPlayerState.audio.addEventListener('ended', () => musicNext(winId));
    musicPlayerState.audio.addEventListener('error', () => {
      const status = document.getElementById('music-status-' + winId);
      if (status) status.textContent = 'Error playing track';
    });
  }

  if (musicPlayerState.audio.src !== track.url) {
    musicPlayerState.audio.src = track.url;
  }

  musicPlayerState.audio.play().then(() => {
    musicPlayerState.isPlaying = true;
    renderMusicPlaylist(winId);
    updateMiniPlayer();
  }).catch(e => {
    const status = document.getElementById('music-status-' + winId);
    if (status) status.textContent = 'Cannot play: ' + (e.message || 'blocked');
  });
}

function musicPause(winId) {
  if (musicPlayerState.audio) {
    musicPlayerState.audio.pause();
    musicPlayerState.isPlaying = false;
    updateMiniPlayer();
  }
}

function musicStop(winId) {
  if (musicPlayerState.audio) {
    musicPlayerState.audio.pause();
    musicPlayerState.audio.currentTime = 0;
    musicPlayerState.isPlaying = false;
    updateMiniPlayer();
  }
  const time = document.getElementById('music-time-' + winId);
  if (time) time.textContent = '--:-- / --:--';
}

function musicPrev(winId) {
  if (musicPlayerState.tracks.length === 0) return;
  musicPlayerState.currentTrack--;
  if (musicPlayerState.currentTrack < 0) musicPlayerState.currentTrack = musicPlayerState.tracks.length - 1;
  renderMusicPlaylist(winId);
  if (musicPlayerState.isPlaying) musicPlay(winId);
}

function musicNext(winId) {
  if (musicPlayerState.tracks.length === 0) return;
  musicPlayerState.currentTrack++;
  if (musicPlayerState.currentTrack >= musicPlayerState.tracks.length) musicPlayerState.currentTrack = 0;
  renderMusicPlaylist(winId);
  if (musicPlayerState.isPlaying) musicPlay(winId);
}

function musicVolume(val) {
  if (musicPlayerState.audio) {
    musicPlayerState.audio.volume = val / 100;
  }
  const volVal = document.getElementById('music-vol-val-' + musicPlayerState.winId);
  if (volVal) volVal.textContent = val + '%';
}

function updateMusicTime(winId) {
  const audio = musicPlayerState.audio;
  if (!audio) return;
  const time = document.getElementById('music-time-' + winId);
  if (!time) return;

  const formatTime = (s) => {
    const mins = Math.floor(s / 60);
    const secs = Math.floor(s % 60);
    return mins + ':' + (secs < 10 ? '0' : '') + secs;
  };

  const current = formatTime(audio.currentTime || 0);
  const total = formatTime(audio.duration || 0);
  time.textContent = current + ' / ' + total;
}

// ==================== MINI PLAYER ====================
function updateMiniPlayer() {
  const miniPlayer = document.getElementById('mini-player');
  const miniTitle = document.getElementById('mini-player-title');
  const miniPlayBtn = document.getElementById('mini-play-btn');

  // Show mini player if music is playing or has tracks loaded
  if (musicPlayerState.tracks.length > 0) {
    miniPlayer.classList.add('visible');
    const track = musicPlayerState.tracks[musicPlayerState.currentTrack];
    if (track) {
      miniTitle.textContent = 'üéµ ' + (track.title || 'Track ' + (musicPlayerState.currentTrack + 1));
    }
    miniPlayBtn.textContent = musicPlayerState.isPlaying ? '‚è∏' : '‚ñ∂';
  } else {
    miniPlayer.classList.remove('visible');
  }
}

function miniPlayerToggle() {
  if (musicPlayerState.isPlaying) {
    musicPause();
  } else {
    musicPlay(musicPlayerState.winId);
  }
  updateMiniPlayer();
}

function miniPlayerPrev() {
  musicPrev(musicPlayerState.winId);
  updateMiniPlayer();
}

function miniPlayerNext() {
  musicNext(musicPlayerState.winId);
  updateMiniPlayer();
}

function miniPlayerOpen() {
  // If music player window exists, focus it; otherwise open new one
  const win = windows.find(w => w.title === 'ALGO Music Player');
  if (win) {
    focusWindow(win.id);
    const el = document.getElementById('win-' + win.id);
    if (el && el.classList.contains('minimized')) {
      el.classList.remove('minimized');
      win.minimized = false;
    }
  } else {
    openMusicPlayer();
  }
}

// ==================== VIDEO PLAYER ====================
let videoPlayerState = { videos: [], currentVideo: -1, winId: null };

function openVideoPlayer() {
  hideStartMenu();
  const id = winId;
  videoPlayerState.winId = id;

  createWindow({
    title: 'ALGO Video Player',
    stateKey: 'Video Player',
    icon: 'üì∫',
    width: 480, height: 420,
    content: '<div class="video-player">' +
      '<div class="video-display" id="video-display-' + id + '">' +
        '<span class="no-video">No video loaded</span>' +
      '</div>' +
      '<div class="video-controls">' +
        '<button class="video-btn" onclick="videoPrev(' + id + ')">‚èÆ Prev</button>' +
        '<button class="video-btn" onclick="videoNext(' + id + ')">Next ‚è≠</button>' +
        '<span style="flex:1;"></span>' +
        '<span id="video-info-' + id + '" style="font-size:10px;color:#666;">0 / 0</span>' +
      '</div>' +
      '<div class="video-playlist" id="video-playlist-' + id + '">' +
        '<div style="padding:10px;text-align:center;color:#666;">Loading videos...</div>' +
      '</div>' +
    '</div>',
    onClose: () => { videoPlayerState.winId = null; }
  });

  loadVideos(id);
}

function loadVideos(winId) {
  fetch('/api/media?type=video')
    .then(r => r.json())
    .then(data => {
      videoPlayerState.videos = data.video || [];
      renderVideoPlaylist(winId);
      updateVideoInfo(winId);
    })
    .catch(e => {
      const playlist = document.getElementById('video-playlist-' + winId);
      if (playlist) playlist.innerHTML = '<div style="padding:10px;text-align:center;color:#f00;">Error loading videos</div>';
    });
}

function renderVideoPlaylist(winId) {
  const playlist = document.getElementById('video-playlist-' + winId);
  if (!playlist) return;

  if (videoPlayerState.videos.length === 0) {
    playlist.innerHTML = '<div style="padding:10px;text-align:center;color:#666;">No videos found.<br>Post YouTube/Vimeo links!</div>';
    return;
  }

  playlist.innerHTML = videoPlayerState.videos.map((v, i) =>
    '<div class="video-item' + (i === videoPlayerState.currentVideo ? ' active' : '') + '" onclick="videoSelect(' + i + ',' + winId + ')">' +
      (v.thumbUrl ? '<img class="video-thumb" src="' + v.thumbUrl + '" alt="">' : '<div class="video-thumb">üì∫</div>') +
      '<div class="video-info">' +
        '<div class="video-title">' + escapeHtml(v.title || 'Video ' + (i+1)) + '</div>' +
        '<div class="video-source">' + escapeHtml(v.platform || v.source || 'Unknown') + '</div>' +
      '</div>' +
    '</div>'
  ).join('');
}

function videoSelect(idx, winId) {
  videoPlayerState.currentVideo = idx;
  renderVideoPlaylist(winId);
  playVideo(winId);
}

function playVideo(winId) {
  const display = document.getElementById('video-display-' + winId);
  if (!display) return;

  if (videoPlayerState.currentVideo < 0 || videoPlayerState.currentVideo >= videoPlayerState.videos.length) {
    display.innerHTML = '<span class="no-video">No video selected</span>';
    return;
  }

  const video = videoPlayerState.videos[videoPlayerState.currentVideo];
  if (!video.embedUrl) {
    display.innerHTML = '<span class="no-video">Cannot embed this video</span>';
    return;
  }

  display.innerHTML = '<iframe src="' + video.embedUrl + '" allow="autoplay; encrypted-media" allowfullscreen></iframe>';
  updateVideoInfo(winId);
}

function videoPrev(winId) {
  if (videoPlayerState.videos.length === 0) return;
  videoPlayerState.currentVideo--;
  if (videoPlayerState.currentVideo < 0) videoPlayerState.currentVideo = videoPlayerState.videos.length - 1;
  renderVideoPlaylist(winId);
  playVideo(winId);
}

function videoNext(winId) {
  if (videoPlayerState.videos.length === 0) return;
  videoPlayerState.currentVideo++;
  if (videoPlayerState.currentVideo >= videoPlayerState.videos.length) videoPlayerState.currentVideo = 0;
  renderVideoPlaylist(winId);
  playVideo(winId);
}

function updateVideoInfo(winId) {
  const info = document.getElementById('video-info-' + winId);
  if (info) {
    const current = videoPlayerState.currentVideo >= 0 ? videoPlayerState.currentVideo + 1 : 0;
    info.textContent = current + ' / ' + videoPlayerState.videos.length;
  }
}

// ==================== MIDI EDITOR ====================
function openMidiEditor() {
  hideStartMenu();
  createWindow({
    title: 'MIDI Editor',
    stateKey: 'MIDI Editor',
    icon: 'üéπ',
    width: 800, height: 500,
    content: '<iframe src="/midi-editor" style="width:100%;height:100%;border:none;"></iframe>'
  });
}

// ==================== TODO APP ====================
function loadTodos() {
  try {
    todoLists = JSON.parse(localStorage.getItem('algo-todos') || '[]');
    todoOverlayHidden = localStorage.getItem('algo-todo-overlay-hidden') === 'true';
  } catch (e) {
    todoLists = [];
  }

  // Create default list if none exist
  if (todoLists.length === 0) {
    todoLists.push({
      id: Date.now(),
      name: 'My Tasks',
      items: []
    });
    saveTodos();
  }

  updateTodoOverlay();
}

function saveTodos() {
  localStorage.setItem('algo-todos', JSON.stringify(todoLists));
  localStorage.setItem('algo-todo-overlay-hidden', todoOverlayHidden);
}

function updateTodoOverlay() {
  const overlay = document.getElementById('todo-overlay');
  const content = document.getElementById('todo-overlay-content');

  // Count pending items
  let pendingItems = [];
  todoLists.forEach(list => {
    list.items.filter(i => !i.done).forEach(item => {
      pendingItems.push({ ...item, listName: list.name });
    });
  });

  // Show/hide overlay
  if (pendingItems.length === 0 || todoOverlayHidden) {
    overlay.classList.remove('visible');
    return;
  }

  overlay.classList.add('visible');

  // Render items (max 5)
  const displayItems = pendingItems.slice(0, 5);
  content.innerHTML = displayItems.map(item =>
    '<div class="todo-item">' +
      '<input type="checkbox" onchange="toggleTodoFromOverlay(' + item.id + ')">' +
      '<span>' + escapeHtml(item.text) + '</span>' +
    '</div>'
  ).join('') +
  (pendingItems.length > 5 ? '<div style="color:#888;font-size:10px;text-align:center;">+' + (pendingItems.length - 5) + ' more...</div>' : '');
}

function toggleTodoFromOverlay(itemId) {
  todoLists.forEach(list => {
    const item = list.items.find(i => i.id === itemId);
    if (item) {
      item.done = !item.done;
    }
  });
  saveTodos();
  updateTodoOverlay();
  if (todoWinId !== null) renderTodoApp(todoWinId);
}

function hideTodoOverlay() {
  todoOverlayHidden = true;
  saveTodos();
  document.getElementById('todo-overlay').classList.remove('visible');
}

function showTodoOverlay() {
  todoOverlayHidden = false;
  saveTodos();
  updateTodoOverlay();
}

function openTodoApp() {
  hideStartMenu();
  const id = winId;
  todoWinId = id;

  createWindow({
    title: 'Todo Manager',
    stateKey: 'Todo Manager',
    icon: 'üìã',
    width: 450, height: 350,
    content: '<div class="todo-app">' +
      '<div class="todo-app-toolbar">' +
        '<button onclick="addTodoList(' + id + ')">+ New List</button>' +
        '<div style="flex:1;"></div>' +
        '<button onclick="showTodoOverlay()">Show Overlay</button>' +
      '</div>' +
      '<div class="todo-app-content">' +
        '<div class="todo-lists" id="todo-lists-' + id + '"></div>' +
        '<div class="todo-items" id="todo-items-' + id + '"></div>' +
      '</div>' +
      '<div class="todo-add-form">' +
        '<input type="text" id="todo-input-' + id + '" placeholder="Add new task..." onkeypress="if(event.key===\'Enter\')addTodoItem(' + id + ')">' +
        '<button onclick="addTodoItem(' + id + ')">Add</button>' +
      '</div>' +
    '</div>',
    onClose: () => { todoWinId = null; }
  });

  // Select first list by default
  if (!window.selectedTodoListId && todoLists.length > 0) {
    window.selectedTodoListId = todoLists[0].id;
  }

  renderTodoApp(id);
}

function renderTodoApp(winId) {
  const listsContainer = document.getElementById('todo-lists-' + winId);
  const itemsContainer = document.getElementById('todo-items-' + winId);
  if (!listsContainer || !itemsContainer) return;

  // Render lists
  listsContainer.innerHTML = todoLists.map(list => {
    const pendingCount = list.items.filter(i => !i.done).length;
    return '<div class="todo-list-item' + (window.selectedTodoListId === list.id ? ' active' : '') + '" onclick="selectTodoList(' + list.id + ',' + winId + ')">' +
      '<span>üìã</span> ' + escapeHtml(list.name) +
      (pendingCount > 0 ? '<span class="count">' + pendingCount + '</span>' : '') +
    '</div>';
  }).join('');

  // Render items for selected list
  const selectedList = todoLists.find(l => l.id === window.selectedTodoListId);
  if (!selectedList) {
    itemsContainer.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">Select a list</div>';
    return;
  }

  if (selectedList.items.length === 0) {
    itemsContainer.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">No tasks yet. Add one below!</div>';
    return;
  }

  itemsContainer.innerHTML = selectedList.items.map(item =>
    '<div class="todo-full-item">' +
      '<input type="checkbox" ' + (item.done ? 'checked' : '') + ' onchange="toggleTodoItem(' + item.id + ',' + winId + ')">' +
      '<div class="todo-text' + (item.done ? ' done' : '') + '">' + escapeHtml(item.text) + '</div>' +
      '<span class="todo-delete" onclick="deleteTodoItem(' + item.id + ',' + winId + ')">√ó</span>' +
    '</div>'
  ).join('');
}

function selectTodoList(listId, winId) {
  window.selectedTodoListId = listId;
  renderTodoApp(winId);
}

function addTodoList(winId) {
  const name = prompt('New list name:', 'New List');
  if (!name) return;

  todoLists.push({
    id: Date.now(),
    name: name,
    items: []
  });
  saveTodos();
  renderTodoApp(winId);
}

function addTodoItem(winId) {
  const input = document.getElementById('todo-input-' + winId);
  const text = input.value.trim();
  if (!text) return;

  const list = todoLists.find(l => l.id === window.selectedTodoListId);
  if (!list) return;

  list.items.push({
    id: Date.now(),
    text: text,
    done: false,
    created: new Date().toISOString()
  });

  input.value = '';
  saveTodos();
  updateTodoOverlay();
  renderTodoApp(winId);
}

function toggleTodoItem(itemId, winId) {
  todoLists.forEach(list => {
    const item = list.items.find(i => i.id === itemId);
    if (item) {
      item.done = !item.done;
    }
  });
  saveTodos();
  updateTodoOverlay();
  renderTodoApp(winId);
}

function deleteTodoItem(itemId, winId) {
  todoLists.forEach(list => {
    list.items = list.items.filter(i => i.id !== itemId);
  });
  saveTodos();
  updateTodoOverlay();
  renderTodoApp(winId);
}

// ==================== CALENDAR APP ====================
const US_HOLIDAYS = [
  { month: 0, day: 1, title: "New Year's Day" },
  { month: 0, day: 20, title: "MLK Day" },
  { month: 1, day: 14, title: "Valentine's Day" },
  { month: 1, day: 17, title: "Presidents Day" },
  { month: 2, day: 17, title: "St. Patrick's Day" },
  { month: 3, day: 20, title: "Easter" },
  { month: 4, day: 26, title: "Memorial Day" },
  { month: 5, day: 19, title: "Juneteenth" },
  { month: 6, day: 4, title: "Independence Day" },
  { month: 8, day: 1, title: "Labor Day" },
  { month: 9, day: 13, title: "Columbus Day" },
  { month: 9, day: 31, title: "Halloween" },
  { month: 10, day: 11, title: "Veterans Day" },
  { month: 10, day: 27, title: "Thanksgiving" },
  { month: 11, day: 25, title: "Christmas" },
  { month: 11, day: 31, title: "New Year's Eve" }
];

function loadCalendar() {
  try {
    calendarEvents = JSON.parse(localStorage.getItem('algo-calendar') || '[]');
    calendarWidgetHidden = localStorage.getItem('algo-calendar-hidden') === 'true';
    const savedPos = localStorage.getItem('algo-calendar-widget-pos');
    if (savedPos) {
      calendarWidgetPos = JSON.parse(savedPos);
    }
  } catch (e) {
    calendarEvents = [];
  }
  updateCalendarWidget();
}

function saveCalendar() {
  localStorage.setItem('algo-calendar', JSON.stringify(calendarEvents));
  localStorage.setItem('algo-calendar-hidden', calendarWidgetHidden);
  if (calendarWidgetPos.x !== null) {
    localStorage.setItem('algo-calendar-widget-pos', JSON.stringify(calendarWidgetPos));
  }
}

function getEventsForDate(year, month, day) {
  const dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
  const events = calendarEvents.filter(e => e.date === dateStr);

  // Add holidays
  US_HOLIDAYS.forEach(h => {
    if (h.month === month && h.day === day) {
      events.push({ title: h.title, isHoliday: true });
    }
  });

  return events;
}

function updateCalendarWidget() {
  const widget = document.getElementById('calendar-widget');
  if (calendarWidgetHidden) {
    widget.classList.remove('visible');
    return;
  }
  widget.classList.add('visible');

  // Apply saved position or default to top-left (avoiding todo overlay)
  if (calendarWidgetPos.x !== null && calendarWidgetPos.y !== null) {
    widget.style.left = calendarWidgetPos.x + 'px';
    widget.style.top = calendarWidgetPos.y + 'px';
  } else {
    // Default position: top-left, but below any todo overlay
    const todoOverlay = document.getElementById('todo-overlay');
    const defaultTop = (todoOverlay && !todoOverlayHidden) ? 140 : 10;
    widget.style.left = '10px';
    widget.style.top = defaultTop + 'px';
  }

  // Update month display
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
    'July', 'August', 'September', 'October', 'November', 'December'];
  document.getElementById('calendar-widget-month').textContent =
    monthNames[calendarWidgetMonth] + ' ' + calendarWidgetYear;

  // Build calendar grid
  const grid = document.getElementById('calendar-widget-grid');
  const firstDay = new Date(calendarWidgetYear, calendarWidgetMonth, 1).getDay();
  const daysInMonth = new Date(calendarWidgetYear, calendarWidgetMonth + 1, 0).getDate();
  const today = new Date();

  let html = '<div class="calendar-row">';
  ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(d => {
    html += '<div class="calendar-cell header">' + d + '</div>';
  });
  html += '</div><div class="calendar-row">';

  // Empty cells for days before first of month
  for (let i = 0; i < firstDay; i++) {
    html += '<div class="calendar-cell other-month"></div>';
  }

  // Days of month
  for (let day = 1; day <= daysInMonth; day++) {
    const isToday = today.getDate() === day &&
      today.getMonth() === calendarWidgetMonth &&
      today.getFullYear() === calendarWidgetYear;
    const events = getEventsForDate(calendarWidgetYear, calendarWidgetMonth, day);
    const hasEvent = events.length > 0;

    html += '<div class="calendar-cell' +
      (isToday ? ' today' : '') +
      (hasEvent && !isToday ? ' has-event' : '') +
      '" onclick="calendarWidgetDayClick(' + day + ')">' + day + '</div>';

    if ((firstDay + day) % 7 === 0 && day < daysInMonth) {
      html += '</div><div class="calendar-row">';
    }
  }
  html += '</div>';
  grid.innerHTML = html;

  // Update upcoming events
  updateUpcomingEvents();
}

function updateUpcomingEvents() {
  const upcoming = document.getElementById('calendar-widget-upcoming');
  const today = new Date();
  const events = [];

  // Get events for next 7 days
  for (let i = 0; i < 7; i++) {
    const d = new Date(today);
    d.setDate(d.getDate() + i);
    const dayEvents = getEventsForDate(d.getFullYear(), d.getMonth(), d.getDate());
    dayEvents.forEach(e => {
      events.push({
        ...e,
        date: d,
        dateStr: (d.getMonth() + 1) + '/' + d.getDate()
      });
    });
  }

  if (events.length === 0) {
    upcoming.innerHTML = '<div style="font-size:9px;color:#666;text-align:center;">No upcoming events</div>';
    return;
  }

  upcoming.innerHTML = events.slice(0, 3).map(e =>
    '<div class="upcoming-item">' +
      '<span class="date">' + e.dateStr + '</span>' +
      '<span>' + escapeHtml(e.title) + '</span>' +
    '</div>'
  ).join('');
}

function calendarWidgetPrev() {
  calendarWidgetMonth--;
  if (calendarWidgetMonth < 0) {
    calendarWidgetMonth = 11;
    calendarWidgetYear--;
  }
  updateCalendarWidget();
}

function calendarWidgetNext() {
  calendarWidgetMonth++;
  if (calendarWidgetMonth > 11) {
    calendarWidgetMonth = 0;
    calendarWidgetYear++;
  }
  updateCalendarWidget();
}

function calendarWidgetDayClick(day) {
  const title = prompt('Add event for ' + (calendarWidgetMonth + 1) + '/' + day + ':');
  if (!title) return;

  const dateStr = calendarWidgetYear + '-' +
    String(calendarWidgetMonth + 1).padStart(2, '0') + '-' +
    String(day).padStart(2, '0');

  calendarEvents.push({
    id: Date.now(),
    title: title,
    date: dateStr,
    isHoliday: false
  });

  saveCalendar();
  updateCalendarWidget();
  if (calendarWinId !== null) renderCalendarApp(calendarWinId);
}

function hideCalendarWidget() {
  calendarWidgetHidden = true;
  saveCalendar();
  document.getElementById('calendar-widget').classList.remove('visible');
}

function showCalendarWidget() {
  calendarWidgetHidden = false;
  saveCalendar();
  updateCalendarWidget();
}

function startCalendarWidgetDrag(e) {
  // Don't drag if clicking close button
  if (e.target.classList.contains('close-btn')) return;

  const widget = document.getElementById('calendar-widget');
  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;

  calendarWidgetDragOffset.x = clientX - widget.offsetLeft;
  calendarWidgetDragOffset.y = clientY - widget.offsetTop;
  calendarWidgetDragging = true;

  if (e.touches) {
    e.preventDefault();
  }

  // Add move/end listeners
  document.addEventListener('mousemove', moveCalendarWidget);
  document.addEventListener('mouseup', endCalendarWidgetDrag);
  document.addEventListener('touchmove', moveCalendarWidget, { passive: false });
  document.addEventListener('touchend', endCalendarWidgetDrag);
}

function moveCalendarWidget(e) {
  if (!calendarWidgetDragging) return;

  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;

  const widget = document.getElementById('calendar-widget');
  const newX = clientX - calendarWidgetDragOffset.x;
  const newY = clientY - calendarWidgetDragOffset.y;

  // Constrain to viewport
  const maxX = window.innerWidth - widget.offsetWidth;
  const maxY = window.innerHeight - widget.offsetHeight - 28; // 28 = taskbar

  calendarWidgetPos.x = Math.max(0, Math.min(newX, maxX));
  calendarWidgetPos.y = Math.max(0, Math.min(newY, maxY));

  widget.style.left = calendarWidgetPos.x + 'px';
  widget.style.top = calendarWidgetPos.y + 'px';

  if (e.touches) {
    e.preventDefault();
  }
}

function endCalendarWidgetDrag() {
  if (calendarWidgetDragging) {
    calendarWidgetDragging = false;
    saveCalendar();
  }

  document.removeEventListener('mousemove', moveCalendarWidget);
  document.removeEventListener('mouseup', endCalendarWidgetDrag);
  document.removeEventListener('touchmove', moveCalendarWidget);
  document.removeEventListener('touchend', endCalendarWidgetDrag);
}

function openCalendarApp() {
  hideStartMenu();
  const id = winId;
  calendarWinId = id;

  createWindow({
    title: 'Calendar',
    stateKey: 'Calendar',
    icon: 'üìÖ',
    width: 550, height: 400,
    content: '<div class="calendar-app">' +
      '<div class="calendar-app-header">' +
        '<button onclick="calendarAppPrev(' + id + ')">‚óÄ Prev</button>' +
        '<span id="calendar-app-month-' + id + '"></span>' +
        '<button onclick="calendarAppNext(' + id + ')">Next ‚ñ∂</button>' +
        '<div style="flex:1;"></div>' +
        '<button onclick="showCalendarWidget()">Show Widget</button>' +
      '</div>' +
      '<div class="calendar-app-content">' +
        '<div class="calendar-main" id="calendar-main-' + id + '"></div>' +
        '<div class="calendar-sidebar">' +
          '<h4>üìã Events</h4>' +
          '<div id="calendar-events-' + id + '"></div>' +
        '</div>' +
      '</div>' +
    '</div>',
    onClose: () => { calendarWinId = null; }
  });

  renderCalendarApp(id);
}

function renderCalendarApp(winId) {
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
    'July', 'August', 'September', 'October', 'November', 'December'];

  // Update month header
  const monthEl = document.getElementById('calendar-app-month-' + winId);
  if (monthEl) {
    monthEl.textContent = monthNames[calendarAppMonth] + ' ' + calendarAppYear;
  }

  // Build calendar grid
  const main = document.getElementById('calendar-main-' + winId);
  if (!main) return;

  const firstDay = new Date(calendarAppYear, calendarAppMonth, 1).getDay();
  const daysInMonth = new Date(calendarAppYear, calendarAppMonth + 1, 0).getDate();
  const today = new Date();

  let html = '<div class="full-grid"><div class="row">';
  ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(d => {
    html += '<div class="cell header">' + d + '</div>';
  });
  html += '</div><div class="row">';

  // Empty cells
  for (let i = 0; i < firstDay; i++) {
    html += '<div class="cell"></div>';
  }

  // Days
  for (let day = 1; day <= daysInMonth; day++) {
    const isToday = today.getDate() === day &&
      today.getMonth() === calendarAppMonth &&
      today.getFullYear() === calendarAppYear;
    const events = getEventsForDate(calendarAppYear, calendarAppMonth, day);

    html += '<div class="cell' + (isToday ? ' today' : '') +
      '" onclick="calendarAppDayClick(' + day + ',' + winId + ')">' +
      '<div class="day-num">' + day + '</div>';

    events.forEach(e => {
      html += '<div class="event' + (e.isHoliday ? ' holiday' : '') + '">' +
        escapeHtml(e.title) + '</div>';
    });

    html += '</div>';

    if ((firstDay + day) % 7 === 0 && day < daysInMonth) {
      html += '</div><div class="row">';
    }
  }
  html += '</div></div>';
  main.innerHTML = html;

  // Render events sidebar
  const eventsEl = document.getElementById('calendar-events-' + winId);
  if (eventsEl) {
    const monthEvents = calendarEvents.filter(e => {
      const d = new Date(e.date);
      return d.getMonth() === calendarAppMonth && d.getFullYear() === calendarAppYear;
    }).sort((a, b) => a.date.localeCompare(b.date));

    if (monthEvents.length === 0) {
      eventsEl.innerHTML = '<div style="color:#888;font-size:10px;">No events this month</div>';
    } else {
      eventsEl.innerHTML = monthEvents.map(e =>
        '<div class="event-item">' +
          '<span class="event-delete" onclick="deleteCalendarEvent(' + e.id + ',' + winId + ')">√ó</span>' +
          '<div>' + escapeHtml(e.title) + '</div>' +
          '<div class="event-date">' + e.date + '</div>' +
        '</div>'
      ).join('');
    }
  }
}

function calendarAppPrev(winId) {
  calendarAppMonth--;
  if (calendarAppMonth < 0) {
    calendarAppMonth = 11;
    calendarAppYear--;
  }
  renderCalendarApp(winId);
}

function calendarAppNext(winId) {
  calendarAppMonth++;
  if (calendarAppMonth > 11) {
    calendarAppMonth = 0;
    calendarAppYear++;
  }
  renderCalendarApp(winId);
}

function calendarAppDayClick(day, winId) {
  const title = prompt('Add event for ' + (calendarAppMonth + 1) + '/' + day + ':');
  if (!title) return;

  const dateStr = calendarAppYear + '-' +
    String(calendarAppMonth + 1).padStart(2, '0') + '-' +
    String(day).padStart(2, '0');

  calendarEvents.push({
    id: Date.now(),
    title: title,
    date: dateStr,
    isHoliday: false
  });

  saveCalendar();
  updateCalendarWidget();
  renderCalendarApp(winId);
}

function deleteCalendarEvent(eventId, winId) {
  calendarEvents = calendarEvents.filter(e => e.id !== eventId);
  saveCalendar();
  updateCalendarWidget();
  renderCalendarApp(winId);
}

// ==================== SHADE STATION ====================
const shaderInstances = {}; // winId -> { gl, program, canvas, animFrame, startTime }

const DEFAULT_SHADER = `precision mediump float;
uniform float u_time;
uniform vec2 u_resolution;
uniform vec2 u_mouse;

void main() {
  vec2 uv = gl_FragCoord.xy / u_resolution;
  vec3 col = 0.5 + 0.5 * cos(u_time + uv.xyx + vec3(0, 2, 4));
  gl_FragColor = vec4(col, 1.0);
}`;

const SHADER_PRESETS = {
  'Rainbow': DEFAULT_SHADER,
  'Plasma': `precision mediump float;
uniform float u_time;
uniform vec2 u_resolution;

void main() {
  vec2 uv = gl_FragCoord.xy / u_resolution;
  float t = u_time * 0.5;
  float v = sin(uv.x * 10.0 + t) + sin(uv.y * 10.0 + t);
  v += sin((uv.x + uv.y) * 10.0 + t);
  v += sin(sqrt(uv.x*uv.x + uv.y*uv.y) * 10.0 + t);
  vec3 col = vec3(sin(v), sin(v + 2.0), sin(v + 4.0)) * 0.5 + 0.5;
  gl_FragColor = vec4(col, 1.0);
}`,
  'Circles': `precision mediump float;
uniform float u_time;
uniform vec2 u_resolution;

void main() {
  vec2 uv = (gl_FragCoord.xy - 0.5 * u_resolution) / min(u_resolution.x, u_resolution.y);
  float d = length(uv);
  float c = sin(d * 20.0 - u_time * 3.0) * 0.5 + 0.5;
  gl_FragColor = vec4(vec3(c * 0.2, c * 0.5, c), 1.0);
}`,
  'Mouse': `precision mediump float;
uniform float u_time;
uniform vec2 u_resolution;
uniform vec2 u_mouse;

void main() {
  vec2 uv = gl_FragCoord.xy / u_resolution;
  vec2 mouse = u_mouse / u_resolution;
  float d = distance(uv, mouse);
  float glow = 0.02 / d;
  vec3 col = vec3(glow * 0.5, glow * 0.8, glow);
  gl_FragColor = vec4(col, 1.0);
}`
};

// File type registration for .shader files
function registerShaderFileType() {
  if (!window.registeredFileTypes) window.registeredFileTypes = {};
  window.registeredFileTypes['shader'] = {
    icon: 'üé®',
    name: 'Shader File',
    handler: (filename, content) => {
      openShadeStation(content, filename);
    }
  };
}

function openShadeStation(initialCode, filename) {
  hideStartMenu();
  const code = initialCode || DEFAULT_SHADER;
  const fname = filename || 'untitled.shader';
  const id = winId;

  createWindow({
    title: 'Shade Station',
    stateKey: 'Shade Station',
    icon: 'üé®',
    width: 700, height: 480,
    content: ''
  });

  const win = getWindowById(id);
  const content = win.querySelector('.window-content');
  content.style.background = '#1a1a2e';
  content.style.padding = '0';
  content.style.overflow = 'hidden';

  content.innerHTML = `
    <div class="shade-station">
      <div class="shade-station-toolbar">
        <button onclick="shaderNew(${id})">New</button>
        <button onclick="shaderSave(${id})">Save</button>
        <button onclick="shaderLoad(${id})">Load</button>
        <select onchange="shaderLoadPreset(${id}, this.value)">
          <option value="">-- Presets --</option>
          ${Object.keys(SHADER_PRESETS).map(k => '<option value="' + k + '">' + k + '</option>').join('')}
        </select>
        <span style="margin-left:auto;color:#888;" id="shader-filename-${id}">${escapeHtml(fname)}</span>
      </div>
      <div class="shade-station-main">
        <div class="shade-station-canvas-wrap">
          <canvas id="shader-canvas-${id}"></canvas>
        </div>
        <div class="shade-station-editor">
          <textarea id="shader-code-${id}" spellcheck="false">${escapeHtml(code)}</textarea>
          <div class="shade-station-uniforms">
            <label>Speed: <input type="range" min="0" max="2" step="0.1" value="1" id="shader-speed-${id}"></label>
            <label><input type="checkbox" id="shader-pause-${id}"> Pause</label>
          </div>
          <div class="shade-station-status" id="shader-status-${id}">Ready - Edit shader and it auto-compiles</div>
        </div>
      </div>
    </div>
  `;

  // Initialize WebGL
  setTimeout(() => initShader(id), 100);

  // Auto-compile on edit
  const textarea = document.getElementById('shader-code-' + id);
  textarea.addEventListener('input', () => compileShader(id));
}

function initShader(winId) {
  const canvas = document.getElementById('shader-canvas-' + winId);
  if (!canvas) return;

  const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
  if (!gl) {
    document.getElementById('shader-status-' + winId).textContent = 'WebGL not supported';
    document.getElementById('shader-status-' + winId).classList.add('error');
    return;
  }

  shaderInstances[winId] = {
    gl,
    canvas,
    program: null,
    startTime: Date.now(),
    mouse: [0, 0],
    animFrame: null
  };

  // Mouse tracking
  canvas.addEventListener('mousemove', (e) => {
    const rect = canvas.getBoundingClientRect();
    shaderInstances[winId].mouse = [
      e.clientX - rect.left,
      rect.height - (e.clientY - rect.top)
    ];
  });

  // Resize observer
  const resizeObserver = new ResizeObserver(() => {
    const rect = canvas.parentElement.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;
    gl.viewport(0, 0, canvas.width, canvas.height);
  });
  resizeObserver.observe(canvas.parentElement);

  compileShader(winId);
}

function compileShader(winId) {
  const inst = shaderInstances[winId];
  if (!inst) return;

  const { gl, canvas } = inst;
  const fragSource = document.getElementById('shader-code-' + winId).value;
  const statusEl = document.getElementById('shader-status-' + winId);

  const vertSource = `
    attribute vec2 a_position;
    void main() { gl_Position = vec4(a_position, 0, 1); }
  `;

  // Compile vertex shader
  const vertShader = gl.createShader(gl.VERTEX_SHADER);
  gl.shaderSource(vertShader, vertSource);
  gl.compileShader(vertShader);

  // Compile fragment shader
  const fragShader = gl.createShader(gl.FRAGMENT_SHADER);
  gl.shaderSource(fragShader, fragSource);
  gl.compileShader(fragShader);

  if (!gl.getShaderParameter(fragShader, gl.COMPILE_STATUS)) {
    const err = gl.getShaderInfoLog(fragShader);
    statusEl.textContent = 'Error: ' + err;
    statusEl.classList.add('error');
    return;
  }

  // Link program
  const program = gl.createProgram();
  gl.attachShader(program, vertShader);
  gl.attachShader(program, fragShader);
  gl.linkProgram(program);

  if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
    statusEl.textContent = 'Link error: ' + gl.getProgramInfoLog(program);
    statusEl.classList.add('error');
    return;
  }

  statusEl.textContent = 'Compiled successfully';
  statusEl.classList.remove('error');

  // Clean up old program
  if (inst.program) gl.deleteProgram(inst.program);
  if (inst.animFrame) cancelAnimationFrame(inst.animFrame);

  inst.program = program;
  gl.useProgram(program);

  // Set up geometry (full-screen quad)
  const posBuffer = gl.createBuffer();
  gl.bindBuffer(gl.ARRAY_BUFFER, posBuffer);
  gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1, 1,-1, -1,1, 1,1]), gl.STATIC_DRAW);

  const posLoc = gl.getAttribLocation(program, 'a_position');
  gl.enableVertexAttribArray(posLoc);
  gl.vertexAttribPointer(posLoc, 2, gl.FLOAT, false, 0, 0);

  // Start render loop
  function render() {
    const pauseEl = document.getElementById('shader-pause-' + winId);
    const speedEl = document.getElementById('shader-speed-' + winId);

    if (!pauseEl || !document.getElementById('shader-canvas-' + winId)) {
      // Window closed
      return;
    }

    const paused = pauseEl && pauseEl.checked;
    const speed = speedEl ? parseFloat(speedEl.value) : 1;

    if (!paused) {
      inst.time = (inst.time || 0) + 0.016 * speed;
    }

    gl.viewport(0, 0, canvas.width, canvas.height);
    gl.clearColor(0, 0, 0, 1);
    gl.clear(gl.COLOR_BUFFER_BIT);

    const timeLoc = gl.getUniformLocation(program, 'u_time');
    const resLoc = gl.getUniformLocation(program, 'u_resolution');
    const mouseLoc = gl.getUniformLocation(program, 'u_mouse');

    if (timeLoc) gl.uniform1f(timeLoc, inst.time || 0);
    if (resLoc) gl.uniform2f(resLoc, canvas.width, canvas.height);
    if (mouseLoc) gl.uniform2f(mouseLoc, inst.mouse[0], inst.mouse[1]);

    gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);

    inst.animFrame = requestAnimationFrame(render);
  }

  render();
}

function shaderNew(winId) {
  document.getElementById('shader-code-' + winId).value = DEFAULT_SHADER;
  document.getElementById('shader-filename-' + winId).textContent = 'untitled.shader';
  compileShader(winId);
}

function shaderLoadPreset(winId, presetName) {
  if (!presetName || !SHADER_PRESETS[presetName]) return;
  document.getElementById('shader-code-' + winId).value = SHADER_PRESETS[presetName];
  document.getElementById('shader-filename-' + winId).textContent = presetName.toLowerCase() + '.shader';
  compileShader(winId);
}

function shaderSave(winId) {
  const code = document.getElementById('shader-code-' + winId).value;
  const filename = prompt('Save shader as:', document.getElementById('shader-filename-' + winId).textContent);
  if (!filename) return;

  // Save as desktop file
  const fname = filename.endsWith('.shader') ? filename : filename + '.shader';
  document.getElementById('shader-filename-' + winId).textContent = fname;

  // Add to desktop as a file icon
  const fileId = 'shader-' + Date.now();
  const desktop = document.getElementById('desktop');
  const icon = document.createElement('div');
  icon.className = 'desktop-icon';
  icon.id = fileId;
  icon.style.left = '20px';
  icon.style.top = (100 + desktopIcons.length * 80) + 'px';
  icon.innerHTML = '<div class="icon-img">üé®</div><span>' + escapeHtml(fname) + '</span>';
  icon.ondblclick = () => openShadeStation(code, fname);
  icon.onclick = (e) => selectIcon(e, icon);
  desktop.appendChild(icon);

  desktopIcons.push({ id: fileId, name: fname, type: 'shader', content: code });
  saveDesktop();
}

function shaderLoad(winId) {
  // Show file picker from desktop shaders
  const shaderFiles = desktopIcons.filter(i => i.type === 'shader');
  if (shaderFiles.length === 0) {
    alert('No shader files on desktop. Save a shader first, or drag a .shader file onto the desktop.');
    return;
  }

  const choice = prompt('Load shader:\\n' + shaderFiles.map((f, i) => (i + 1) + '. ' + f.name).join('\\n') + '\\n\\nEnter number:');
  const idx = parseInt(choice) - 1;
  if (idx >= 0 && idx < shaderFiles.length) {
    const file = shaderFiles[idx];
    document.getElementById('shader-code-' + winId).value = file.content;
    document.getElementById('shader-filename-' + winId).textContent = file.name;
    compileShader(winId);
  }
}

// Clean up shader instances when window closes
const origCloseWindow = closeWindow;
closeWindow = function(winId) {
  if (shaderInstances[winId]) {
    if (shaderInstances[winId].animFrame) {
      cancelAnimationFrame(shaderInstances[winId].animFrame);
    }
    delete shaderInstances[winId];
  }
  origCloseWindow(winId);
};

// ==================== BOX EDITOR ====================
// File type registration system
const FILE_TYPE_HANDLERS = {}; // extension -> [{ name, icon, handler }]

function registerFileHandler(extension, name, icon, handler) {
  if (!FILE_TYPE_HANDLERS[extension]) FILE_TYPE_HANDLERS[extension] = [];
  FILE_TYPE_HANDLERS[extension].push({ name, icon, handler });
}

function getFileExtension(filename) {
  const match = filename.match(/\.([^.]+)$/);
  return match ? match[1].toLowerCase() : null;
}

function getFileHandlers(filename, content) {
  const handlers = [];
  const ext = getFileExtension(filename);

  // Check by extension
  if (ext && FILE_TYPE_HANDLERS[ext]) {
    handlers.push(...FILE_TYPE_HANDLERS[ext]);
  }

  // Check for .box files (start with //)
  if (content && content.trim().startsWith('//')) {
    if (FILE_TYPE_HANDLERS['box']) {
      handlers.push(...FILE_TYPE_HANDLERS['box']);
    }
  }

  return handlers;
}

// Box drawing characters
const BOX_CHARS = {
  corners: ['‚îå', '‚îê', '‚îî', '‚îò', '‚ïî', '‚ïó', '‚ïö', '‚ïù'],
  lines: ['‚îÄ', '‚îÇ', '‚ïê', '‚ïë', '‚ïå', '‚ïé'],
  tees: ['‚îú', '‚î§', '‚î¨', '‚î¥', '‚ï†', '‚ï£', '‚ï¶', '‚ï©', '‚îº', '‚ï¨'],
  arrows: ['‚Üê', '‚Üí', '‚Üë', '‚Üì', '‚Üî', '‚Üï'],
  blocks: ['‚ñà', '‚ñì', '‚ñí', '‚ñë', '‚ñÑ', '‚ñÄ', '‚ñå', '‚ñê']
};

const boxEditorInstances = {}; // winId -> { grid, cursorX, cursorY, width, height }

function registerBoxFileType() {
  registerFileHandler('box', 'Box Editor', 'üì¶', openBoxEditor);
  registerFileHandler('txt', 'Box Editor', 'üì¶', openBoxEditor);
}

function openBoxEditor(content, filename) {
  hideStartMenu();
  const id = winId;
  const fname = filename || 'untitled.box';
  const width = 60;
  const height = 20;

  createWindow({
    title: 'Box Editor',
    stateKey: 'Box Editor',
    icon: 'üì¶',
    width: 600, height: 450,
    content: ''
  });

  const win = getWindowById(id);
  const contentEl = win.querySelector('.window-content');
  contentEl.style.background = '#1a1a2e';
  contentEl.style.padding = '0';
  contentEl.style.overflow = 'hidden';

  // Initialize grid
  let grid = [];
  if (content && content.trim().startsWith('//')) {
    // Parse existing .box content
    const lines = content.split('\\n').slice(1); // Skip first line with //
    for (let y = 0; y < height; y++) {
      grid[y] = [];
      const line = lines[y] || '';
      for (let x = 0; x < width; x++) {
        grid[y][x] = line[x] || ' ';
      }
    }
  } else if (content) {
    // Load plain text
    const lines = content.split('\\n');
    for (let y = 0; y < height; y++) {
      grid[y] = [];
      const line = lines[y] || '';
      for (let x = 0; x < width; x++) {
        grid[y][x] = line[x] || ' ';
      }
    }
  } else {
    // Empty grid
    for (let y = 0; y < height; y++) {
      grid[y] = [];
      for (let x = 0; x < width; x++) {
        grid[y][x] = ' ';
      }
    }
  }

  boxEditorInstances[id] = {
    grid,
    cursorX: 0,
    cursorY: 0,
    width,
    height,
    filename: fname,
    currentChar: '‚ñà'
  };

  const charButtons = Object.values(BOX_CHARS).flat().map(c =>
    '<button onclick="boxSetChar(' + id + ',&quot;' + c + '&quot;)">' + c + '</button>'
  ).join('');

  contentEl.innerHTML = `
    <div class="box-editor">
      <div class="box-editor-toolbar">
        <button onclick="boxNew(${id})">New</button>
        <button onclick="boxSave(${id})">Save</button>
        <button onclick="boxClear(${id})">Clear</button>
        <span style="margin-left:8px;color:#888;" id="box-filename-${id}">${escapeHtml(fname)}</span>
      </div>
      <div class="box-editor-toolbar">
        <div class="box-editor-charbar">${charButtons}</div>
        <span style="color:#4ecdc4;" id="box-current-${id}">Current: ‚ñà</span>
      </div>
      <div class="box-editor-canvas" id="box-canvas-${id}" onclick="boxCanvasClick(event,${id})">
        <pre id="box-grid-${id}"></pre>
      </div>
      <div class="box-editor-status">
        <span id="box-pos-${id}">Pos: 0,0</span>
        <span>Click to place character | Type to insert text</span>
      </div>
    </div>
  `;

  renderBoxGrid(id);

  // Keyboard input
  const canvas = document.getElementById('box-canvas-' + id);
  canvas.tabIndex = 0;
  canvas.addEventListener('keydown', (e) => boxKeyDown(e, id));
  canvas.focus();
}

function renderBoxGrid(winId) {
  const inst = boxEditorInstances[winId];
  if (!inst) return;

  const gridEl = document.getElementById('box-grid-' + winId);
  if (!gridEl) return;

  let html = '';
  for (let y = 0; y < inst.height; y++) {
    for (let x = 0; x < inst.width; x++) {
      const char = inst.grid[y][x] || ' ';
      if (x === inst.cursorX && y === inst.cursorY) {
        html += '<span style="background:#e94560;color:#fff;">' + escapeHtml(char) + '</span>';
      } else {
        html += escapeHtml(char);
      }
    }
    html += '\\n';
  }
  gridEl.innerHTML = html;
}

function boxCanvasClick(e, winId) {
  const inst = boxEditorInstances[winId];
  if (!inst) return;

  const gridEl = document.getElementById('box-grid-' + winId);
  const rect = gridEl.getBoundingClientRect();
  const style = window.getComputedStyle(gridEl);
  const charWidth = parseFloat(style.fontSize) * 0.6; // Approximate monospace char width
  const lineHeight = parseFloat(style.lineHeight) || parseFloat(style.fontSize) * 1.2;

  const x = Math.floor((e.clientX - rect.left) / charWidth);
  const y = Math.floor((e.clientY - rect.top) / lineHeight);

  if (x >= 0 && x < inst.width && y >= 0 && y < inst.height) {
    inst.cursorX = x;
    inst.cursorY = y;
    inst.grid[y][x] = inst.currentChar;
    renderBoxGrid(winId);
    document.getElementById('box-pos-' + winId).textContent = 'Pos: ' + x + ',' + y;
  }

  document.getElementById('box-canvas-' + winId).focus();
}

function boxKeyDown(e, winId) {
  const inst = boxEditorInstances[winId];
  if (!inst) return;

  e.preventDefault();

  if (e.key === 'ArrowUp' && inst.cursorY > 0) inst.cursorY--;
  else if (e.key === 'ArrowDown' && inst.cursorY < inst.height - 1) inst.cursorY++;
  else if (e.key === 'ArrowLeft' && inst.cursorX > 0) inst.cursorX--;
  else if (e.key === 'ArrowRight' && inst.cursorX < inst.width - 1) inst.cursorX++;
  else if (e.key === 'Backspace') {
    if (inst.cursorX > 0) inst.cursorX--;
    inst.grid[inst.cursorY][inst.cursorX] = ' ';
  } else if (e.key === 'Delete') {
    inst.grid[inst.cursorY][inst.cursorX] = ' ';
  } else if (e.key === 'Enter') {
    inst.cursorX = 0;
    if (inst.cursorY < inst.height - 1) inst.cursorY++;
  } else if (e.key.length === 1) {
    inst.grid[inst.cursorY][inst.cursorX] = e.key;
    if (inst.cursorX < inst.width - 1) inst.cursorX++;
  }

  renderBoxGrid(winId);
  document.getElementById('box-pos-' + winId).textContent = 'Pos: ' + inst.cursorX + ',' + inst.cursorY;
}

function boxSetChar(winId, char) {
  const inst = boxEditorInstances[winId];
  if (!inst) return;
  inst.currentChar = char;
  document.getElementById('box-current-' + winId).textContent = 'Current: ' + char;
}

function boxNew(winId) {
  const inst = boxEditorInstances[winId];
  if (!inst) return;
  for (let y = 0; y < inst.height; y++) {
    for (let x = 0; x < inst.width; x++) {
      inst.grid[y][x] = ' ';
    }
  }
  inst.cursorX = 0;
  inst.cursorY = 0;
  inst.filename = 'untitled.box';
  document.getElementById('box-filename-' + winId).textContent = 'untitled.box';
  renderBoxGrid(winId);
}

function boxClear(winId) {
  const inst = boxEditorInstances[winId];
  if (!inst) return;
  for (let y = 0; y < inst.height; y++) {
    for (let x = 0; x < inst.width; x++) {
      inst.grid[y][x] = ' ';
    }
  }
  renderBoxGrid(winId);
}

function boxSave(winId) {
  const inst = boxEditorInstances[winId];
  if (!inst) return;

  const filename = prompt('Save as:', inst.filename);
  if (!filename) return;

  const fname = filename.endsWith('.box') ? filename : filename + '.box';
  inst.filename = fname;
  document.getElementById('box-filename-' + winId).textContent = fname;

  // Build content with // header
  let content = '// Box Art\\n';
  for (let y = 0; y < inst.height; y++) {
    content += inst.grid[y].join('') + '\\n';
  }

  // Add to desktop
  const fileId = 'box-' + Date.now();
  const desktop = document.getElementById('desktop');
  const icon = document.createElement('div');
  icon.className = 'desktop-icon';
  icon.id = fileId;
  icon.style.left = '20px';
  icon.style.top = (100 + desktopIcons.length * 80) + 'px';
  icon.innerHTML = '<div class="icon-img">üì¶</div><span>' + escapeHtml(fname) + '</span>';
  icon.ondblclick = () => openBoxEditor(content, fname);
  icon.onclick = (e) => selectIcon(e, icon);
  desktop.appendChild(icon);

  desktopIcons.push({ id: fileId, name: fname, type: 'box', content: content });
  saveDesktop();
}

// ==================== START MENU ====================
function toggleStartMenu() {
  document.getElementById('start-menu').classList.toggle('visible');
  document.getElementById('start-btn').classList.toggle('active');
}

function hideStartMenu() {
  document.getElementById('start-menu').classList.remove('visible');
  document.getElementById('start-btn').classList.remove('active');
}

// ==================== UTILITIES ====================
function globalClick(e) {
  if (!e.target.closest('#start-menu') && !e.target.closest('#start-btn')) hideStartMenu();
  if (!e.target.closest('#context-menu')) hideContextMenu();
  if (!e.target.closest('.dropdown-menu') && !e.target.closest('.menu-item')) hideMenus();
}

function hideContextMenu() { document.getElementById('context-menu').classList.remove('visible'); }
function hideMenus() { document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('visible')); }

function updateClock() {
  document.getElementById('clock').textContent = new Date().toLocaleTimeString('en-US', { hour:'numeric', minute:'2-digit', hour12:true });
}

function escapeHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

function postToLaserbarf(text, room) {
  room = room || 'algo-world';
  const tag = (room === 'algo-world' || room === 'algo-dolphin') ? room + ':dolphin42' : room;
  fetch('/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: 'yo=489&text=' + encodeURIComponent(text + '\n\n#' + tag) + '&save=POST'
  });
}

function algoSpeak(text) {
  const bubble = document.getElementById('speech-bubble');
  const sprite = document.getElementById('algo-sprite');
  const rect = sprite.getBoundingClientRect();
  bubble.textContent = text;
  bubble.style.left = (rect.right + 5) + 'px';
  bubble.style.top = (rect.top - 10) + 'px';
  bubble.style.display = 'block';
  setTimeout(() => bubble.style.display = 'none', 4000);
}

function showAbout() {
  hideStartMenu();
  createWindow({
    title: 'About ALGO OS',
    stateKey: 'About ALGO OS',
    icon: 'üê¨',
    width: 300, height: 220,
    content: '<div style="padding:20px;text-align:center;">' +
      '<div style="font-size:48px;">üê¨</div>' +
      '<h2>ALGO OS</h2>' +
      '<p>Version 98.0</p>' +
      '<p style="margin-top:10px;font-size:10px;">Trusted Zone</p>' +
      '<p style="font-size:10px;">Key: dolphin42</p>' +
    '</div>'
  });
}

function openSettings() {
  hideStartMenu();
  const currentName = localStorage.getItem('algo-username') || '';
  const currentBg = localStorage.getItem('algo-bg-color') || '#008080';
  const currentBgMode = localStorage.getItem('algo-bg-mode') || 'cover';

  // Get available images for background
  const imageFiles = savedFiles.filter(f => f.type === 'image');
  const imageOptions = imageFiles.length > 0
    ? '<option value="">-- Select Image --</option>' + imageFiles.map((f, i) =>
        '<option value="' + i + '">' + escapeHtml(f.name) + '</option>').join('')
    : '<option value="">No images on desktop</option>';

  createWindow({
    title: 'Settings',
    stateKey: 'Settings',
    icon: '‚öôÔ∏è',
    width: 380, height: 380,
    content: '<div style="padding:15px;">' +
      '<h3 style="margin-bottom:15px;">‚öôÔ∏è ALGO OS Settings</h3>' +
      '<div style="margin-bottom:15px;">' +
        '<label style="display:block;margin-bottom:5px;font-weight:bold;">Username:</label>' +
        '<input type="text" id="settings-username" value="' + escapeHtml(currentName) + '" ' +
          'style="width:100%;padding:5px;border:2px inset #fff;" placeholder="Enter your display name">' +
        '<p style="font-size:10px;color:#666;margin-top:4px;">Used in ALGO Chat and Webcam</p>' +
      '</div>' +
      '<hr style="margin:15px 0;border:none;border-top:1px solid #808080;">' +
      '<div style="margin-bottom:10px;">' +
        '<label style="display:block;margin-bottom:5px;font-weight:bold;">Desktop Background:</label>' +
        '<div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">' +
          '<label>Color:</label>' +
          '<input type="color" id="settings-bg-color" value="' + currentBg + '" style="width:50px;height:25px;">' +
          '<button onclick="clearDesktopBg()" style="padding:3px 8px;font-size:10px;">Reset</button>' +
        '</div>' +
        '<div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">' +
          '<label>Image:</label>' +
          '<select id="settings-bg-image" style="flex:1;padding:3px;">' + imageOptions + '</select>' +
          '<button onclick="applyBgImage()" style="padding:3px 8px;">Apply</button>' +
        '</div>' +
        '<div style="display:flex;gap:8px;align-items:center;">' +
          '<label>Style:</label>' +
          '<select id="settings-bg-mode" style="padding:3px;">' +
            '<option value="cover"' + (currentBgMode === 'cover' ? ' selected' : '') + '>Fill (Cover)</option>' +
            '<option value="stretch"' + (currentBgMode === 'stretch' ? ' selected' : '') + '>Stretch</option>' +
            '<option value="tile"' + (currentBgMode === 'tile' ? ' selected' : '') + '>Tile</option>' +
            '<option value="center"' + (currentBgMode === 'center' ? ' selected' : '') + '>Center</option>' +
          '</select>' +
        '</div>' +
      '</div>' +
      '<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px;">' +
        '<button onclick="saveSettings()" style="padding:5px 15px;">Save</button>' +
        '<button onclick="closeWindow(getWindowByTitle(\'Settings\').id)" style="padding:5px 15px;">Cancel</button>' +
      '</div>' +
    '</div>'
  });
}

function saveSettings() {
  const nameInput = document.getElementById('settings-username');
  if (nameInput) {
    const name = nameInput.value.trim();
    localStorage.setItem('algo-username', name);
  }

  // Save background color
  const bgColor = document.getElementById('settings-bg-color');
  if (bgColor) {
    localStorage.setItem('algo-bg-color', bgColor.value);
  }

  // Save background mode
  const bgMode = document.getElementById('settings-bg-mode');
  if (bgMode) {
    localStorage.setItem('algo-bg-mode', bgMode.value);
    applyBgMode(bgMode.value);
  }

  algoSpeak('Settings saved!');
  const win = getWindowByTitle('Settings');
  if (win) closeWindow(win.id);
}

function applyBgImage() {
  const select = document.getElementById('settings-bg-image');
  if (!select || select.value === '') return;

  const idx = parseInt(select.value);
  const imageFiles = savedFiles.filter(f => f.type === 'image');
  if (idx >= 0 && idx < imageFiles.length) {
    const img = imageFiles[idx];
    setDesktopBackground(img.content);
    localStorage.setItem('algo-bg-image', img.content);
    algoSpeak('Background set to ' + img.name);
  }
}

function setDesktopBackground(imageData) {
  const desktop = document.getElementById('desktop');
  desktop.style.backgroundImage = 'url(' + imageData + ')';
  const mode = localStorage.getItem('algo-bg-mode') || 'cover';
  applyBgMode(mode);
}

function applyBgMode(mode) {
  const desktop = document.getElementById('desktop');
  desktop.classList.remove('bg-tile', 'bg-stretch', 'bg-center');
  if (mode === 'tile') desktop.classList.add('bg-tile');
  else if (mode === 'stretch') desktop.classList.add('bg-stretch');
  else if (mode === 'center') desktop.classList.add('bg-center');
}

function clearDesktopBg() {
  const desktop = document.getElementById('desktop');
  desktop.style.backgroundImage = '';
  desktop.style.backgroundColor = '#008080';
  desktop.classList.remove('bg-tile', 'bg-stretch', 'bg-center');
  localStorage.removeItem('algo-bg-image');
  localStorage.setItem('algo-bg-color', '#008080');
  document.getElementById('settings-bg-color').value = '#008080';
  algoSpeak('Background reset');
}

function loadDesktopBackground() {
  const bgImage = localStorage.getItem('algo-bg-image');
  const bgColor = localStorage.getItem('algo-bg-color') || '#008080';
  const bgMode = localStorage.getItem('algo-bg-mode') || 'cover';

  const desktop = document.getElementById('desktop');
  desktop.style.backgroundColor = bgColor;

  if (bgImage) {
    desktop.style.backgroundImage = 'url(' + bgImage + ')';
    applyBgMode(bgMode);
  }
}

function setImageAsBackground(fileIdx) {
  const imageFiles = savedFiles.filter(f => f.type === 'image');
  if (fileIdx >= 0 && fileIdx < imageFiles.length) {
    const img = imageFiles[fileIdx];
    setDesktopBackground(img.content);
    localStorage.setItem('algo-bg-image', img.content);
    algoSpeak('Background set to ' + img.name);
  }
  hideContextMenu();
}

function getWindowByTitle(title) {
  return windows.find(w => w.title === title);
}

// ==================== PERSISTENCE ====================
async function loadFilesFromServer() {
  if (!sessionToken) return;
  try {
    const resp = await fetch(API_BASE + '/files/list?path=~', {
      headers: { 'Authorization': 'Bearer ' + sessionToken }
    });
    const data = await resp.json();
    if (data.files) {
      savedFiles = [];
      for (const file of data.files) {
        if (file.type === 'file') {
          // Load file content
          const contentResp = await fetch(API_BASE + '/files/get?path=~/' + encodeURIComponent(file.name), {
            headers: { 'Authorization': 'Bearer ' + sessionToken }
          });
          const contentData = await contentResp.json();
          if (contentData.content !== undefined) {
            // Detect type from extension
            let type = 'text';
            if (file.name.endsWith('.html')) type = 'html';
            else if (file.name.endsWith('.js')) type = 'javascript';
            else if (file.name.endsWith('.css')) type = 'css';
            else if (file.name.endsWith('.json')) type = 'json';
            else if (file.name.match(/\.(png|jpg|jpeg|gif|webp)$/i)) type = 'image';
            savedFiles.push({ name: file.name, content: contentData.content, type });
          }
        }
      }
      if (window.createDesktopIcons) createDesktopIcons();
    }
  } catch (e) {
    console.error('Failed to load files from server:', e);
  }
}

function saveState() {
  // Files are saved to server individually via ALGO.saveFile()
  // Keep other state in localStorage
  localStorage.setItem('algo-programs', JSON.stringify(installedPrograms));
  localStorage.setItem('algo-rooms', JSON.stringify(roomFolders));
  localStorage.setItem('algo-windows', JSON.stringify(windowStates));
  localStorage.setItem('algo-apikeys', JSON.stringify(apiKeys));
}

function loadState() {
  try {
    // Load files from server
    loadFilesFromServer();
    // Load other state from localStorage
    installedPrograms = JSON.parse(localStorage.getItem('algo-programs') || '[]');
    roomFolders = JSON.parse(localStorage.getItem('algo-rooms') || '[]');
    windowStates = JSON.parse(localStorage.getItem('algo-windows') || '{}');
    apiKeys = JSON.parse(localStorage.getItem('algo-apikeys') || '{}');
    iconPositions = JSON.parse(localStorage.getItem('algo-icon-positions') || '{}');
    updateProgramsMenu();
  } catch(e) {}
}

// ==================== ALGO DOLPHIN MASCOT ====================
let dolphinX, dolphinY, dolphinVx, dolphinVy, dolphinFacingRight = true;

function initDolphin() {
  const dolphin = document.getElementById('algo-dolphin');
  if (!dolphin) return;

  // Start in center of screen
  dolphinX = window.innerWidth / 2 - 16;
  dolphinY = window.innerHeight / 2 - 16;

  // Random initial velocity
  dolphinVx = (Math.random() - 0.5) * 2;
  dolphinVy = (Math.random() - 0.5) * 1.5;

  dolphin.style.left = dolphinX + 'px';
  dolphin.style.top = dolphinY + 'px';

  // Update every 50ms
  setInterval(updateDolphin, 50);
}

function updateDolphin() {
  const dolphin = document.getElementById('algo-dolphin');
  if (!dolphin) return;

  // Move dolphin
  dolphinX += dolphinVx;
  dolphinY += dolphinVy;

  // Screen boundaries
  const maxX = window.innerWidth - 50;
  const maxY = window.innerHeight - 80; // Above taskbar
  const minY = 10;

  // Icon area boundary (avoid left side where icons are)
  const iconAreaRight = 200;

  // Bounce off edges
  if (dolphinX < iconAreaRight) {
    dolphinX = iconAreaRight;
    dolphinVx = Math.abs(dolphinVx) * 0.8 + 0.5;
  }
  if (dolphinX > maxX) {
    dolphinX = maxX;
    dolphinVx = -Math.abs(dolphinVx) * 0.8 - 0.5;
  }
  if (dolphinY < minY) {
    dolphinY = minY;
    dolphinVy = Math.abs(dolphinVy) * 0.8 + 0.3;
  }
  if (dolphinY > maxY) {
    dolphinY = maxY;
    dolphinVy = -Math.abs(dolphinVy) * 0.8 - 0.3;
  }

  // Add slight random drift
  dolphinVx += (Math.random() - 0.5) * 0.1;
  dolphinVy += (Math.random() - 0.5) * 0.08;

  // Limit velocity
  const maxSpeed = 3;
  if (Math.abs(dolphinVx) > maxSpeed) dolphinVx = maxSpeed * Math.sign(dolphinVx);
  if (Math.abs(dolphinVy) > maxSpeed * 0.7) dolphinVy = maxSpeed * 0.7 * Math.sign(dolphinVy);

  // Flip dolphin based on direction (use data attribute, CSS handles animation)
  if (dolphinVx > 0.1 && !dolphinFacingRight) {
    dolphinFacingRight = true;
    dolphin.dataset.facing = 'right';
  } else if (dolphinVx < -0.1 && dolphinFacingRight) {
    dolphinFacingRight = false;
    dolphin.dataset.facing = 'left';
  }

  dolphin.style.left = dolphinX + 'px';
  dolphin.style.top = dolphinY + 'px';
}

// Start
initDolphin();
checkSession(); // Check login before init
</script>
</body>
</html>